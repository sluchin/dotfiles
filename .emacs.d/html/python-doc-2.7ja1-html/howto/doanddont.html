

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Python 良い慣用句、悪い慣用句 &mdash; Python 2.7ja1 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.7ja1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Python 2.7ja1 documentation 内を検索"
          href="../_static/opensearch.xml"/>
    <link rel="author" title="このドキュメントについて" href="../about.html" />
    <link rel="copyright" title="著作権" href="../copyright.html" />
    <link rel="top" title="Python 2.7ja1 documentation" href="../index.html" />
    <link rel="up" title="Python HOWTO" href="index.html" />
    <link rel="next" title="関数型プログラミング HOWTO" href="functional.html" />
    <link rel="prev" title="ディスクリプタ HowTo ガイド" href="descriptor.html" />
    <link rel="shortcut icon" type="image/png" href="../_static/py.png" />
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/_jp.js"></script>
    
 

  </head>
  <body>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="functional.html" title="関数型プログラミング HOWTO"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="descriptor.html" title="ディスクリプタ HowTo ガイド"
             accesskey="P">前へ</a> |</li>
        <li><img src="../_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="../index.html">Python 2.7ja1 documentation</a> &raquo;</li>

          <li><a href="index.html" accesskey="U">Python HOWTO</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../contents.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">Python 良い慣用句、悪い慣用句</a><ul>
<li><a class="reference internal" href="#id1">使うべきでない構文</a><ul>
<li><a class="reference internal" href="#from-import">from モジュール import *</a><ul>
<li><a class="reference internal" href="#id2">関数定義の中で</a></li>
<li><a class="reference internal" href="#id3">モジュールレベルで</a></li>
<li><a class="reference internal" href="#id4">問題ない状況</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exec-execfile">そのまんまな <tt class="docutils literal"><span class="pre">exec</span></tt>, <tt class="docutils literal"><span class="pre">execfile()</span></tt> と仲間たち</a></li>
<li><a class="reference internal" href="#from-import-1-2">from モジュール import 名前1, 名前2</a></li>
<li><a class="reference internal" href="#except">except:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">例外</a></li>
<li><a class="reference internal" href="#id6">使い捨てじゃなくて充電池を使う</a></li>
<li><a class="reference internal" href="#id7">バックスラッシュで文を続ける</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="descriptor.html"
                        title="前の章へ">ディスクリプタ HowTo ガイド</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="functional.html"
                        title="次の章へ">関数型プログラミング HOWTO</a></p>
  <h3>このページ</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/howto/doanddont.txt"
           rel="nofollow">ソースコードを表示</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>クイック検索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    モジュール、クラス、または関数名を入力してください
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="python">
<h1>Python 良い慣用句、悪い慣用句<a class="headerlink" href="#python" title="このヘッドラインへのパーマリンク">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Moshe Zadka</td>
</tr>
</tbody>
</table>
<p>This document is placed in the public domain.
(この文書はパブリックドメインです。)</p>
<div class="topic">
<p class="topic-title first">概要</p>
<p>この文書はチュートリアルのおまけと考えてもらって結構です。
Python をどう使うべきか、そして更に重要なこととして、どう使うべきで <em>ない</em> かを例示しています。</p>
</div>
<div class="section" id="id1">
<h2>使うべきでない構文<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Python の落とし穴は他言語と比べればほとんどないようなものですが、中には特殊な場面でしか役に立たなかったり、単に危険なだけの構文も存在しています。</p>
<div class="section" id="from-import">
<h3>from モジュール import *<a class="headerlink" href="#from-import" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="id2">
<h4>関数定義の中で<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>関数定義内での <tt class="docutils literal"><span class="pre">from</span> <span class="pre">モジュール</span> <span class="pre">import</span> <span class="pre">*</span></tt> は <em>不正</em> です。多くの古い Python では不正としてチェックされないものの、だからと言って有効になるわけではありません。やり手の弁護士を雇って無罪になっても、潔白になれるわけではないのと同じですね。ですから絶対にそういう使い方をしないでください。不正にされないバージョンでも、コンパイラはどの名前がローカルでどの名前がグローバルなのか判然としなくなるので、関数の実行が遅くなってしまいます。Python 2.1 で、この構文は警告や、場合によってはエラーも出すようになりました。</p>
</div>
<div class="section" id="id3">
<h4>モジュールレベルで<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>モジュールレベルで <tt class="docutils literal"><span class="pre">from</span> <span class="pre">モジュール</span> <span class="pre">import</span> <span class="pre">*</span></tt> を使うのは有効ではありますが、大抵は、やめたほうが良いですよ。理由のひとつとして、それをやると本来 Python が持っている大事な特徴を失ってしまうということが挙げられます。その特徴とは、トップレベルの名前がそれぞれどこで定義されているのか、エディタの検索機能だけでわかるというものです。それに、将来モジュールに関数やクラスが増えていくと、ややこしいことになりかねません。</p>
<p>ニュースグループで出てくる最低の質問には、なぜこのコード:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;www&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>が動かないのか、というものがあります。もちろんこれで動きますよ
(ただし &#8220;www&#8221; というファイルがあれば)。でもモジュールのどこかに
<tt class="docutils literal"><span class="pre">from</span> <span class="pre">os</span> <span class="pre">import</span> <span class="pre">*</span></tt> があればダメです。 <a class="reference internal" href="../library/os.html#module-os" title="os: 雑多なオペレーティングシステムインタフェース。"><tt class="xref py py-mod docutils literal"><span class="pre">os</span></tt></a> モジュールは、整数を返す <a class="reference internal" href="../library/functions.html#open" title="open"><tt class="xref py py-func docutils literal"><span class="pre">open()</span></tt></a> 関数を持っているのです。これはとても便利ではありますが、ビルトインを隠してしまうのは、非常に不便な特徴のひとつと言えます。</p>
<p>モジュールがエクスポートする名前は確実にはわからないのですから、必要なものだけ
<tt class="docutils literal"><span class="pre">from</span> <span class="pre">モジュール</span> <span class="pre">import</span> <span class="pre">名前1,</span> <span class="pre">名前2</span></tt> で取るか、モジュールから出さずに
<tt class="docutils literal"><span class="pre">import</span> <span class="pre">モジュール;print</span> <span class="pre">モジュール.name</span></tt> としておいて必要に応じてアクセスするようにしましょう。</p>
</div>
<div class="section" id="id4">
<h4>問題ない状況<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><tt class="docutils literal"><span class="pre">from</span> <span class="pre">モジュール</span> <span class="pre">import</span> <span class="pre">*</span></tt> が問題とならない状況もあります:</p>
<ul class="simple">
<li>対話的プロンプト。たとえば <tt class="docutils literal"><span class="pre">from</span> <span class="pre">math</span> <span class="pre">import</span> <span class="pre">*</span></tt> すれば
Python がスーパー関数電卓に変身します。</li>
<li>C のモジュールを Python のモジュールで拡張するとき。</li>
<li>そのモジュールは <tt class="docutils literal"><span class="pre">from</span> <span class="pre">import</span> <span class="pre">*</span></tt> 可だ、と作者が言っているとき。</li>
</ul>
</div>
</div>
<div class="section" id="exec-execfile">
<h3>そのまんまな <a class="reference internal" href="../reference/simple_stmts.html#exec"><tt class="xref std std-keyword docutils literal"><span class="pre">exec</span></tt></a>, <a class="reference internal" href="../library/functions.html#execfile" title="execfile"><tt class="xref py py-func docutils literal"><span class="pre">execfile()</span></tt></a> と仲間たち<a class="headerlink" href="#exec-execfile" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>「そのまんま」という言葉は辞書を明示せずに使うという意味で、そういう構文ではコードが <em>その時点の</em> 環境に対して評価されます。これは <tt class="docutils literal"><span class="pre">from</span> <span class="pre">import</span> <span class="pre">*</span></tt> と同じ理由で危険です &#8212; 使っている最中の変数を土足で踏んで行って、コード全体をメチャクチャにしてしまう可能性があるからです。これは、とにかくやめてください。</p>
<p>悪い見本:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">exec</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">=1&quot;</span> <span class="o">%</span> <span class="n">name</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="k">exec</span> <span class="s">&quot;s.</span><span class="si">%s</span><span class="s">=val&quot;</span> <span class="o">%</span> <span class="n">var</span>  <span class="c"># ダメ!</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">execfile</span><span class="p">(</span><span class="s">&quot;handler.py&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">handle</span><span class="p">()</span>
</pre></div>
</div>
<p>良い見本:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="nb">setattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="o">=</span><span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">execfile</span><span class="p">(</span><span class="s">&quot;handle.py&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">handle</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;handle&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">handle</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="from-import-1-2">
<h3>from モジュール import 名前1, 名前2<a class="headerlink" href="#from-import-1-2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>今回のは、これまでの「ダメ」よりかなり弱い「ダメ」ですが、やはりそれなりの理由がなければ、やめておいたほうが良いことに変わりありません。これが大抵うまくないのは、いつの間にか二つ別々の名前空間に住む一つのオブジェクトを持つことになるからです。一方の名前空間でそのバインディングが変更されたとき、もう一方のバインディングは変更されないので、食い違いができてしまいます。これが起こるのは、たとえば、モジュールを読み直したり、ランタイムで関数の定義を変更したときなどです。</p>
<p>悪い見本:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># foo.py</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c"># bar.py</span>
<span class="kn">from</span> <span class="nn">foo</span> <span class="kn">import</span> <span class="n">a</span>
<span class="k">if</span> <span class="n">something</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span> <span class="c"># 危険: foo.a != a</span>
</pre></div>
</div>
<p>良い見本:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># foo.py</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c"># bar.py</span>
<span class="kn">import</span> <span class="nn">foo</span>
<span class="k">if</span> <span class="n">something</span><span class="p">():</span>
    <span class="n">foo</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="section" id="except">
<h3>except:<a class="headerlink" href="#except" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Python には <tt class="docutils literal"><span class="pre">except:</span></tt> 節があり、これはあらゆる例外を捕捉します。
Python のエラーは <em>すべて</em> 例外を出しますから、 <tt class="docutils literal"><span class="pre">except:</span></tt> を使うと各種のプログラミングエラーがランタイムの問題のように見えてしまい、デバッグの邪魔になります。</p>
<p>以下のコードは、 <tt class="docutils literal"><span class="pre">except:</span></tt> をなぜ避けるべきなのかを示す良い例です:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">opne</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">)</span> <span class="c"># &quot;open&quot; を打ち間違えた</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;could not open file!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>この 2 行目は <a class="reference internal" href="../library/exceptions.html#exceptions.NameError" title="exceptions.NameError"><tt class="xref py py-exc docutils literal"><span class="pre">NameError</span></tt></a> を引き起こし、続く except 節で捕捉されます。プログラムがエラー終了しますが、実際のエラーが <tt class="docutils literal"><span class="pre">&quot;file&quot;</span></tt> とは何の関係もないのに、にプログラムが表示するエラーメッセージは <tt class="docutils literal"><span class="pre">&quot;file&quot;</span></tt> の読み込みにあったように誤解させます。</p>
<p>前述の例はこう書くべきでした:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">opne</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;could not open file&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>このプログラムを実行した場合は、 Python は <a class="reference internal" href="../library/exceptions.html#exceptions.NameError" title="exceptions.NameError"><tt class="xref py py-exc docutils literal"><span class="pre">NameError</span></tt></a> のトレースバックを表示し、修正すべき問題を即座に明らかにしてくれます。</p>
<p id="index-0"><tt class="docutils literal"><span class="pre">except:</span></tt> は <em>全て</em> の例外を補足します。これには <a class="reference internal" href="../library/exceptions.html#exceptions.SystemExit" title="exceptions.SystemExit"><tt class="xref py py-exc docutils literal"><span class="pre">SystemExit</span></tt></a>,
<a class="reference internal" href="../library/exceptions.html#exceptions.KeyboardInterrupt" title="exceptions.KeyboardInterrupt"><tt class="xref py py-exc docutils literal"><span class="pre">KeyboardInterrupt</span></tt></a>, <a class="reference internal" href="../library/exceptions.html#exceptions.GeneratorExit" title="exceptions.GeneratorExit"><tt class="xref py py-exc docutils literal"><span class="pre">GeneratorExit</span></tt></a> (これはエラーではなく、通常はユーザーコードでキャッチするべきではない例外です) も含まれるので、ほとんど全ての場合に <tt class="docutils literal"><span class="pre">except:</span></tt> を利用してはいけません。
&#8220;通常の&#8221; すべてのエラーをキャッチする必要がある場合、たとえばコールバックを実行するようなフレームワークの場合は、全ての通常の例外の基底クラスである
<a class="reference internal" href="../library/exceptions.html#exceptions.Exception" title="exceptions.Exception"><tt class="xref py py-exc docutils literal"><span class="pre">Exception</span></tt></a> をキャッチすることができます。不幸なことに、 Python 2.x ではサードパーティのコードが <a class="reference internal" href="../library/exceptions.html#exceptions.Exception" title="exceptions.Exception"><tt class="xref py py-exc docutils literal"><span class="pre">Exception</span></tt></a>
を継承していない例外を発生させる可能性があるので、 <tt class="docutils literal"><span class="pre">except:</span></tt> を使ってキャッチしたくない例外を手動で再度 raise する必要がある場合があるかもしれません。</p>
</div>
</div>
<div class="section" id="id5">
<h2>例外<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>例外は Python の有用な機能です。何か期待している以外のことが起これば例外を出す、という習慣を持つべきですが、それと同時に、何か対処できるときにだけ捕捉する、ということも習慣にしてください。</p>
<p>以下は非常にありがちな悪い見本です:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;file not found&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</pre></div>
</div>
<p>ここで、 <a class="reference internal" href="../library/os.path.html#os.path.exists" title="os.path.exists"><tt class="xref py py-func docutils literal"><span class="pre">os.path.exists()</span></tt></a> を呼んでから <a class="reference internal" href="../library/functions.html#open" title="open"><tt class="xref py py-func docutils literal"><span class="pre">open()</span></tt></a> を呼ぶまでの間にファイルが消された場合を考えてください。そうなれば最後の行は <a class="reference internal" href="../library/exceptions.html#exceptions.IOError" title="exceptions.IOError"><tt class="xref py py-exc docutils literal"><span class="pre">IOError</span></tt></a> を投げるでしょう。同じことは、 <em>file</em> は存在しているけれど読み出し権限がなかった、という場合にも起こります。これをテストする際、ふつうのマシンで、存在するファイルと存在しないファイルに対してだけやったのではバグがないように見えてしまい、テスト結果が大丈夫そうなのでコードはそのまま出荷されてしまうことになります。こうして、対処されない <a class="reference internal" href="../library/exceptions.html#exceptions.IOError" title="exceptions.IOError"><tt class="xref py py-exc docutils literal"><span class="pre">IOError</span></tt></a> (またはその他の <a class="reference internal" href="../library/exceptions.html#exceptions.EnvironmentError" title="exceptions.EnvironmentError"><tt class="xref py py-exc docutils literal"><span class="pre">EnvironmentError</span></tt></a>)はユーザの所まで逃げのびて、汚いトレースバックを見せることになるのです。</p>
<p>もっと良い方法はこちら:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">EnvironmentError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Unable to open file: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>このバージョンでは、ファイルが開かれて一行目も読まれる (だから、あてにならない
NFS や SMB 接続でも動く) か、あるいはファイルを開くのに失敗した理由についての全ての情報を含むエラーメッセージを表示してアプリケーションを強制終了するかの
<em>いずれか</em> 一方しか起こりません。</p>
<p>とはいえ、このバージョンの <tt class="xref py py-func docutils literal"><span class="pre">get_status()</span></tt> でさえ、前提としている条件が多過ぎます &#8212; すぐ終わるスクリプトでだけ使って、長く動作させる、いわゆるサーバでは使わない前提なのです。もちろん呼び出し側はこうすることもできます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<p>でも、もっと良い方法があります。コードで使う <tt class="docutils literal"><span class="pre">except</span></tt> 節を、できるだけ少なくするのです &#8212; 使うとすれば、必ず成功するはずの呼び出し内か、main 関数での全捕捉ですね。</p>
<p>というわけで、たぶんもっと良い <tt class="xref py py-func docutils literal"><span class="pre">get_status()</span></tt> はこちら:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</pre></div>
</div>
<p>呼び出した側は、望むなら例外を処理することもできますし (たとえばループで複数ファイルに試行するときとか)、そのまま <em>自分の</em> 呼び出し親まで上げることもできます。</p>
<p>しかし、この最終バージョンにも深刻な問題があります &#8212; CPython 実装の細部に原因があるのですが、例外が起きたときにはその例外ハンドラが終了するまでファイルが閉じられないのです; しかも、なお悪いことに、他の実装 (たとえば Jython) では例外の有無に関わらず閉じられません。</p>
<p>この関数の一番良いバージョンでは <a class="reference internal" href="../library/functions.html#open" title="open"><tt class="xref py py-func docutils literal"><span class="pre">open()</span></tt></a> をコンテクストマネジャとして使って、関数が返るとすぐにファイルが閉じられるようにしています:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2>使い捨てじゃなくて充電池を使う<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>どうも皆、Python ライブラリに最初からあるものを自分で書こうとして、大抵うまくいっていないようです。そういう場当たりなモジュールには貧弱なインタフェースしかないことを考えると、ふつうは Python に付いてくる高機能な標準ライブラリとデータ型を使うほうが、自分でひねり出すより格段に良いですよ。</p>
<p>便利なのにほとんど知られていないモジュールに <a class="reference internal" href="../library/os.path.html#module-os.path" title="os.path: Operations on pathnames."><tt class="xref py py-mod docutils literal"><span class="pre">os.path</span></tt></a> があります。このモジュールには OS に合ったパス演算が備わっていて、大抵は自分でどれだけ苦労して作ったものよりもずっと良いものです。</p>
<p>比べてください:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># うげえ!</span>
<span class="k">return</span> <span class="nb">dir</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="nb">file</span>
<span class="c"># 改良版</span>
<span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="../library/os.path.html#module-os.path" title="os.path: Operations on pathnames."><tt class="xref py py-mod docutils literal"><span class="pre">os.path</span></tt></a> にはさらに便利な関数が他にもあります: <tt class="xref py py-func docutils literal"><span class="pre">basename()</span></tt> や
<tt class="xref py py-func docutils literal"><span class="pre">dirname()</span></tt>, <tt class="xref py py-func docutils literal"><span class="pre">splitext()</span></tt> などです。</p>
<p>加えて、なぜか気付かれていない多くのビルトイン関数があります:
たとえば <a class="reference internal" href="../library/functions.html#min" title="min"><tt class="xref py py-func docutils literal"><span class="pre">min()</span></tt></a> と <a class="reference internal" href="../library/functions.html#max" title="max"><tt class="xref py py-func docutils literal"><span class="pre">max()</span></tt></a> を使えば、大小比較のできるシーケンスなら何からでも最小値/最大値を見つけることができるのに、多くの人々が自家製の
<a class="reference internal" href="../library/functions.html#max" title="max"><tt class="xref py py-func docutils literal"><span class="pre">max()</span></tt></a>/<a class="reference internal" href="../library/functions.html#min" title="min"><tt class="xref py py-func docutils literal"><span class="pre">min()</span></tt></a> を書いています。また別の超便利な関数として、シーケンスに対して2項演算を繰り返し適用して最終的に1つの値にまとめる
<a class="reference internal" href="../library/functions.html#reduce" title="reduce"><tt class="xref py py-func docutils literal"><span class="pre">reduce()</span></tt></a> です。例えば、階乗を乗算の繰り返しで計算します:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">operator</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="go">24</span>
</pre></div>
</div>
<p>数値の字句解析をするときには、 <a class="reference internal" href="../library/functions.html#float" title="float"><tt class="xref py py-func docutils literal"><span class="pre">float()</span></tt></a>, <a class="reference internal" href="../library/functions.html#int" title="int"><tt class="xref py py-func docutils literal"><span class="pre">int()</span></tt></a>, <a class="reference internal" href="../library/functions.html#long" title="long"><tt class="xref py py-func docutils literal"><span class="pre">long()</span></tt></a>
は全て文字列の引数を受け取って、不正なフォーマットの文字列の場合には
<a class="reference internal" href="../library/exceptions.html#exceptions.ValueError" title="exceptions.ValueError"><tt class="xref py py-exc docutils literal"><span class="pre">ValueError</span></tt></a> を発生させることを覚えておくと便利です。</p>
</div>
<div class="section" id="id7">
<h2>バックスラッシュで文を続ける<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Python は改行を文の終わりとして扱いますので、そして文は一行にうまく収まらないことがよくありますので、こうする人が多いです:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">foo</span><span class="o">.</span><span class="n">bar</span><span class="p">()[</span><span class="s">&#39;first&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">baz</span><span class="o">.</span><span class="n">quux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> <span class="ow">and</span> \
   <span class="n">calculate_number</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">!=</span> <span class="n">forbulate</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">360</span><span class="p">):</span>
      <span class="k">pass</span>
</pre></div>
</div>
<p>これは危険だということに気づいたほうが良いですよ: はぐれスペースが <tt class="docutils literal"><span class="pre">\</span></tt>
の後に来ればその行の意味が変わってしまいますが、スペースはエディタで見えにくいことに定評があるのです。今回の場合は構文エラーにはなりますが、もしこうなら:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">value</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">bar</span><span class="p">()[</span><span class="s">&#39;first&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">baz</span><span class="o">.</span><span class="n">quux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span> \
        <span class="o">+</span> <span class="n">calculate_number</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="o">*</span><span class="n">forbulate</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
</pre></div>
</div>
<p>微妙に違う意味になるだけで、エラーが出ません。</p>
<p>それで、ふつうは括弧に入れて暗黙のうちに行をつなげるほうが賢明です:</p>
<p>このバージョンで鉄壁です:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">bar</span><span class="p">()[</span><span class="s">&#39;first&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">baz</span><span class="o">.</span><span class="n">quux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">calculate_number</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="o">*</span><span class="n">forbulate</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">360</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="functional.html" title="関数型プログラミング HOWTO"
             >次へ</a> |</li>
        <li class="right" >
          <a href="descriptor.html" title="ディスクリプタ HowTo ガイド"
             >前へ</a> |</li>
        <li><img src="../_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="../index.html">Python 2.7ja1 documentation</a> &raquo;</li>

          <li><a href="index.html" >Python HOWTO</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 1990-2011, Python Software Foundation.
      最終更新: 2011-12-26
      このドキュメントは <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/02cb752c6a9e で生成しました。
    </div>
  </body>
</html>