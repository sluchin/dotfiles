

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>urllib2 を使ってインターネット上のリソースを取得するには &mdash; Python 2.7ja1 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.7ja1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Python 2.7ja1 documentation 内を検索"
          href="../_static/opensearch.xml"/>
    <link rel="author" title="このドキュメントについて" href="../about.html" />
    <link rel="copyright" title="著作権" href="../copyright.html" />
    <link rel="top" title="Python 2.7ja1 documentation" href="../index.html" />
    <link rel="up" title="Python HOWTO" href="index.html" />
    <link rel="next" title="Python を Web 上で使うには HOWTO" href="webservers.html" />
    <link rel="prev" title="Unicode HOWTO" href="unicode.html" />
    <link rel="shortcut icon" type="image/png" href="../_static/py.png" />
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/_jp.js"></script>
    
 

  </head>
  <body>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="webservers.html" title="Python を Web 上で使うには HOWTO"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="unicode.html" title="Unicode HOWTO"
             accesskey="P">前へ</a> |</li>
        <li><img src="../_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="../index.html">Python 2.7ja1 documentation</a> &raquo;</li>

          <li><a href="index.html" accesskey="U">Python HOWTO</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../contents.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">urllib2 を使ってインターネット上のリソースを取得するには</a><ul>
<li><a class="reference internal" href="#id1">はじめに</a></li>
<li><a class="reference internal" href="#url">URL を取得する</a><ul>
<li><a class="reference internal" href="#id2">データ</a></li>
<li><a class="reference internal" href="#id4">ヘッダ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9">例外を処理する</a><ul>
<li><a class="reference internal" href="#urlerror">URLError</a></li>
<li><a class="reference internal" href="#httperror">HTTPError</a><ul>
<li><a class="reference internal" href="#id10">エラーコード</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11">エラーをラップする</a><ul>
<li><a class="reference internal" href="#id12">その1</a></li>
<li><a class="reference internal" href="#id13">その2</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#info-geturl">info と geturl</a></li>
<li><a class="reference internal" href="#openers-handlers">Openers と Handlers</a></li>
<li><a class="reference internal" href="#basic">Basic 認証</a></li>
<li><a class="reference internal" href="#id14">プロキシ</a></li>
<li><a class="reference internal" href="#id17">ソケットとレイヤー</a></li>
<li><a class="reference internal" href="#id18">脚注</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="unicode.html"
                        title="前の章へ">Unicode HOWTO</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="webservers.html"
                        title="次の章へ">Python を Web 上で使うには HOWTO</a></p>
  <h3>このページ</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/howto/urllib2.txt"
           rel="nofollow">ソースコードを表示</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>クイック検索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    モジュール、クラス、または関数名を入力してください
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="urllib2">
<h1>urllib2 を使ってインターネット上のリソースを取得するには<a class="headerlink" href="#urllib2" title="このヘッドラインへのパーマリンク">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body"><a class="reference external" href="http://www.voidspace.org.uk/python/index.shtml">Michael Foord</a></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last">この HOWTO の前段階の版のフランス語訳が
<a class="reference external" href="http://www.voidspace.org.uk/python/articles/urllib2_francais.shtml">urllib2 - Le Manuel manquant</a>
で入手できます。</p>
</div>
<div class="section" id="id1">
<h2>はじめに<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="sidebar">
<p class="first sidebar-title">関連する記事</p>
<p>同じように Python でインターネットリソースを取得するのに以下の記事が役に立ちます:</p>
<ul class="last">
<li><p class="first"><a class="reference external" href="http://www.voidspace.org.uk/python/articles/authentication.shtml">Basic Authentication</a></p>
<blockquote>
<div><p><em>Basic 認証</em> についてのチュートリアルで Python の例がついています。</p>
</div></blockquote>
</li>
</ul>
</div>
<p><strong>urllib2</strong> は URLs (Uniform Resource Locators) を取得するための
<a class="reference external" href="http://www.python.org">Python</a> モジュールです。このモジュールはとても簡単なインターフェースを <em>urlopen</em> 関数の形式で提供しています。また、このモジュールは一般的な状況で利用するためにいくらか複雑なインターフェースも提供しています
- basic 認証やクッキー、プロキシ等。これらは handler や opener と呼ばれるオブジェクトとして提供されます。</p>
<p>urllib2 は多くの &#8220;URL スキーム&#8221; (URL の &#8221;:&#8221; の前の文字列で識別されるもの
- 例えば &#8220;<a class="reference external" href="ftp://python.org/">ftp://python.org/</a>&#8221; では &#8220;ftp&#8221;) の URL を、関連するネットワークプロトコル(例えば FTP, HTTP) を利用することで、取得できます。</p>
<p>単純な状況では <em>urlopen</em> はとても簡単に使うことができます。しかし HTTP の URL を開くときにエラーが起きたり、特殊なケースに遭遇すると、
HyperText Transfer Protocol に関するいくつかのことを理解する必要があります。
HTTP に関して最も包括的で信頼できる文献は <span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2616.html"><strong>RFC 2616</strong></a> です。この文書は技術文書なので簡単には読めません。この HOWTO の目的は <em>urllib2</em> の利用法を例示することです、
HTTP についてはその助けになるのに十分に詳しく載せています。このドキュメントは <a class="reference internal" href="../library/urllib2.html#module-urllib2" title="urllib2: URLを開く次世代ライブラリ"><tt class="xref py py-mod docutils literal"><span class="pre">urllib2</span></tt></a> のドキュメントの代わりにはなりませんが、補完する役割を持っています。</p>
</div>
<div class="section" id="url">
<h2>URL を取得する<a class="headerlink" href="#url" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>urllib2 を利用する最も簡単な方法は以下です:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">urllib2</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&#39;http://python.org/&#39;</span><span class="p">)</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>多くの urllib2 の利用法はこのように簡単です (&#8216;http:&#8217; の代わりに URL を
&#8216;ftp:&#8217; や &#8216;file:&#8217; 等で始めればできます。)。しかし、このチュートリアルの目的は、得に HTTP に絞って、より複雑な状況を説明することです。</p>
<p>HTTP はリクエスト (request) とレスポンス (response) が基本となっています
- クライアントがリクエストし、サーバーがレスポンスを送ります。
urllib2 はこれを真似て、作成する HTTP リクエストを表現する
<tt class="docutils literal"><span class="pre">Request</span></tt> オブジェクトを備えています。リクエストオブジェクトを作成する最も簡単な方法は取得したい URL を指定することです。
<tt class="docutils literal"><span class="pre">urlopen</span></tt> をこのオブジェクトを使って呼び出すと、リクエストした URL のレスポンスオブジェクトが返されます。このレスポンスはファイルライクオブジェクトで、これはつまりレスポンスに <tt class="docutils literal"><span class="pre">.read()</span></tt>
と呼び出せることを意味しています:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">urllib2</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">&#39;http://www.voidspace.org.uk&#39;</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="n">the_page</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>urllib2 は同じリクエストインターフェースを全ての URL スキームに対して利用できるようにしています。例えば、FTP リクエストの場合はこうできます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">&#39;ftp://example.com/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>HTTP の場合には、リクエストオブジェクトに対して二つの特別な操作ができます:
一つ目はサーバーに送るデータを渡すことができる、二つ目はサーバーに送るデータやリクエスト自身に <em>ついての</em> 特別な情報 (&#8220;metadata&#8221;)を渡すことができます
- これらの送られる情報は HTTP 「ヘッダ」です。今度はこれらに関してひとつひとつ見ていきましょう。</p>
<div class="section" id="id2">
<h3>データ<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>URL にデータを送りたい場合はよくあります
(しばしば、その URL は CGI (Common Gateway Interface) スクリプト <a class="footnote-reference" href="#id19" id="id3">[1]</a> や他の web アプリケーションを参照することになります)。これは HTTP では、 <strong>POST</strong> リクエストとして知られる方法で行なわれます。これは web 上で HTML フォームを埋めて送信するときにブラウザが行なっていることです。全ての POST がフォームから送られるとは限りません:
自身のアプリケーションに対して任意のデータを POST を使って送ることができます。一般的な HTML フォームの場合、データは標準的な方法でエンコードされている必要があり、リクエストオブジェクトに <tt class="docutils literal"><span class="pre">data</span></tt> 引数として渡します。エンコーディングは <tt class="docutils literal"><span class="pre">urllib2</span></tt> からではなく、 <tt class="docutils literal"><span class="pre">urllib</span></tt> ライブラリの関数を使って行います:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://www.someserver.com/cgi-bin/register.cgi&#39;</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="s">&#39;Michael Foord&#39;</span><span class="p">,</span>
          <span class="s">&#39;location&#39;</span> <span class="p">:</span> <span class="s">&#39;Northampton&#39;</span><span class="p">,</span>
          <span class="s">&#39;language&#39;</span> <span class="p">:</span> <span class="s">&#39;Python&#39;</span> <span class="p">}</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="n">the_page</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>他のエンコーディングが必要な場合があることに注意して下さい (例えば、
HTML フォームからファイルをアップロードするための詳細については
<a class="reference external" href="http://www.w3.org/TR/REC-html40/interact/forms.html#h-17.13">HTML Specification, Form Submission</a> を見て下さい</p>
<p><tt class="docutils literal"><span class="pre">data</span></tt> 引数を渡さない場合、urllib2 は <strong>GET</strong> リクエストを利用します。
GET と POST リクエストの一つの違いは、POST リクエストにしばしば、「副作用」があることです:
POST リクエストはいくつかの方法によってシステムの状態を変化させます
(例えば100ポンドのスパムの缶詰をドアの前まで配達する注文を web サイトで行う)。とはいえ HTTP 標準で明確にされている内容では、POST は <em>常に</em> 副作用を持ち、
GET リクエストが副作用を持つことを禁止していません、副作用の無い POST リクエストはありません。
HTTP の GET リクエストでもデータ自身をエンコーディングすることでデータを渡すことができます。</p>
<p>以下のようにして行います:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">urllib2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Somebody Here&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Northampton&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span><span class="p">[</span><span class="s">&#39;language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Python&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">url_values</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">url_values</span>
<span class="go">name=Somebody+Here&amp;language=Python&amp;location=Northampton</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://www.example.com/example.cgi&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s">&#39;?&#39;</span> <span class="o">+</span> <span class="n">url_values</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">full_url</span><span class="p">)</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">?</span></tt> を URL に加え、それにエンコードされた値が続くことで、完全な URL が 作られていることに注意して下さい。</p>
</div>
<div class="section" id="id4">
<h3>ヘッダ<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ここでは特定の HTTP ヘッダについて議論します、
HTTP リクエストにヘッダを追加する方法について例示します。</p>
<p>いくつかの web サイト <a class="footnote-reference" href="#id20" id="id5">[2]</a> はプログラムからブラウズされることを嫌っていたり、異なるブラウザに対して異なるバージョンのブラウザに送ります <a class="footnote-reference" href="#id21" id="id6">[3]</a> 。デフォルトでは urllib2 は自身の情報を <tt class="docutils literal"><span class="pre">Python-urllib/x.y</span></tt> として扱います
(<tt class="docutils literal"><span class="pre">x</span></tt> と <tt class="docutils literal"><span class="pre">y</span></tt> は Python のリリースバージョンのメジャーバージョン、マイナーバージョンです、例えば <tt class="docutils literal"><span class="pre">Python-urllib/2.5</span></tt> など)、これによって web サイト側が混乱したり、動作しないかもしれません。ブラウザは自身の情報を <tt class="docutils literal"><span class="pre">User-Agent</span></tt> ヘッダ <a class="footnote-reference" href="#id22" id="id7">[4]</a> を通して扱っています。リクエストオブジェクトを作るときに、ヘッダに辞書を渡すことができます。以下の例は上の例と同じですが、自身を Internet Explorer <a class="footnote-reference" href="#id23" id="id8">[5]</a> のバージョンの一つとして扱っています。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://www.someserver.com/cgi-bin/register.cgi&#39;</span>
<span class="n">user_agent</span> <span class="o">=</span> <span class="s">&#39;Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)&#39;</span>
<span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="s">&#39;Michael Foord&#39;</span><span class="p">,</span>
          <span class="s">&#39;location&#39;</span> <span class="p">:</span> <span class="s">&#39;Northampton&#39;</span><span class="p">,</span>
          <span class="s">&#39;language&#39;</span> <span class="p">:</span> <span class="s">&#39;Python&#39;</span> <span class="p">}</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;User-Agent&#39;</span> <span class="p">:</span> <span class="n">user_agent</span> <span class="p">}</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="n">the_page</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>レスポンスは二つの便利なメソッドも持っています。
<a class="reference internal" href="#info-geturl">info と geturl</a> の節を見て下さい、この節は後で問題が起きた場合に見ておくべき内容です。</p>
</div>
</div>
<div class="section" id="id9">
<h2>例外を処理する<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><em>urlopen</em> はレスポンスを処理できなかった場合、
<tt class="xref py py-exc docutils literal"><span class="pre">URLError</span></tt> を送出します
(ふつうの Python API では、組み込み例外の
<a class="reference internal" href="../library/exceptions.html#exceptions.ValueError" title="exceptions.ValueError"><tt class="xref py py-exc docutils literal"><span class="pre">ValueError</span></tt></a>, <a class="reference internal" href="../library/exceptions.html#exceptions.TypeError" title="exceptions.TypeError"><tt class="xref py py-exc docutils literal"><span class="pre">TypeError</span></tt></a> などが送出されますが)。</p>
<p><tt class="xref py py-exc docutils literal"><span class="pre">HTTPError</span></tt> は <tt class="xref py py-exc docutils literal"><span class="pre">URLError</span></tt> のサブクラスで
HTTP URLs の特定の状況で送出されます。</p>
<div class="section" id="urlerror">
<h3>URLError<a class="headerlink" href="#urlerror" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>URLError が送出されることはよく起こります、それはネットワーク接続が無い場合や、指定したサーバが無い場合です。この場合、例外は &#8216;reason&#8217; 属性を持っていて、この属性はエラーコードとエラーメッセージのテキストを含むタプルです。</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">&#39;http://www.pretend_server.org&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">except</span> <span class="n">URLError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="k">print</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">(4, &#39;getaddrinfo failed&#39;)</span>
</pre></div>
</div>
</div>
<div class="section" id="httperror">
<h3>HTTPError<a class="headerlink" href="#httperror" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>サーバーからの全ての HTTP レスポンスは「ステータスコード」の数値を持っています。多くの場合ステータスコードはサーバーがリクエストを実現できなかったことを意味します。デフォルトハンドラーはこれらのレスポンスのいくつかを処理してくれます(例えばレスポンスが「リダイレクション」、つまりクライアントが別の URL を取得するように要求する場合には
urllib2 はこの処理を行ってくれます。)
処理できないものに対しては urlopen は <tt class="xref py py-exc docutils literal"><span class="pre">HTTPError</span></tt> を送出します。典型的なエラーには &#8216;404&#8217; (page not found), &#8216;403&#8217; (request forbidden) と
&#8216;401&#8217; (authentication required) が含まれます。</p>
<p>HTTP のエラーコード全てについては RFC 2616 の10節を参照して下さい。</p>
<p>送出された <tt class="xref py py-exc docutils literal"><span class="pre">HTTPError</span></tt> インスタンスは整数の &#8216;code&#8217; 属性を持っていて、サーバーによって送られた応答に対応しています。</p>
<div class="section" id="id10">
<h4>エラーコード<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>デフォルトハンドラーはリダイレクト(コードは300番台にあります) を処理し、
100-299番台のコードは成功を意味しているので、たいていの場合は400-599番台のエラーコードのみを見るだけですみます。</p>
<p><tt class="docutils literal"><span class="pre">BaseHTTPServer.BaseHTTPRequestHandler.responses</span></tt> は RFC2616 で利用されるレスポンスコード全てを示す便利な辞書です。この辞書は便利なのでここに載せておきます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Table mapping response codes to messages; entries have the</span>
<span class="c"># form {code: (shortmessage, longmessage)}.</span>
<span class="n">responses</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">100</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Continue&#39;</span><span class="p">,</span> <span class="s">&#39;Request received, please continue&#39;</span><span class="p">),</span>
    <span class="mi">101</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Switching Protocols&#39;</span><span class="p">,</span>
          <span class="s">&#39;Switching to new protocol; obey Upgrade header&#39;</span><span class="p">),</span>

    <span class="mi">200</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;OK&#39;</span><span class="p">,</span> <span class="s">&#39;Request fulfilled, document follows&#39;</span><span class="p">),</span>
    <span class="mi">201</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Created&#39;</span><span class="p">,</span> <span class="s">&#39;Document created, URL follows&#39;</span><span class="p">),</span>
    <span class="mi">202</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Accepted&#39;</span><span class="p">,</span>
          <span class="s">&#39;Request accepted, processing continues off-line&#39;</span><span class="p">),</span>
    <span class="mi">203</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Non-Authoritative Information&#39;</span><span class="p">,</span> <span class="s">&#39;Request fulfilled from cache&#39;</span><span class="p">),</span>
    <span class="mi">204</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;No Content&#39;</span><span class="p">,</span> <span class="s">&#39;Request fulfilled, nothing follows&#39;</span><span class="p">),</span>
    <span class="mi">205</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Reset Content&#39;</span><span class="p">,</span> <span class="s">&#39;Clear input form for further input.&#39;</span><span class="p">),</span>
    <span class="mi">206</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Partial Content&#39;</span><span class="p">,</span> <span class="s">&#39;Partial content follows.&#39;</span><span class="p">),</span>

    <span class="mi">300</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Multiple Choices&#39;</span><span class="p">,</span>
          <span class="s">&#39;Object has several resources -- see URI list&#39;</span><span class="p">),</span>
    <span class="mi">301</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Moved Permanently&#39;</span><span class="p">,</span> <span class="s">&#39;Object moved permanently -- see URI list&#39;</span><span class="p">),</span>
    <span class="mi">302</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Found&#39;</span><span class="p">,</span> <span class="s">&#39;Object moved temporarily -- see URI list&#39;</span><span class="p">),</span>
    <span class="mi">303</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;See Other&#39;</span><span class="p">,</span> <span class="s">&#39;Object moved -- see Method and URL list&#39;</span><span class="p">),</span>
    <span class="mi">304</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Not Modified&#39;</span><span class="p">,</span>
          <span class="s">&#39;Document has not changed since given time&#39;</span><span class="p">),</span>
    <span class="mi">305</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Use Proxy&#39;</span><span class="p">,</span>
          <span class="s">&#39;You must use proxy specified in Location to access this &#39;</span>
          <span class="s">&#39;resource.&#39;</span><span class="p">),</span>
    <span class="mi">307</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Temporary Redirect&#39;</span><span class="p">,</span>
          <span class="s">&#39;Object moved temporarily -- see URI list&#39;</span><span class="p">),</span>

    <span class="mi">400</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Bad Request&#39;</span><span class="p">,</span>
          <span class="s">&#39;Bad request syntax or unsupported method&#39;</span><span class="p">),</span>
    <span class="mi">401</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Unauthorized&#39;</span><span class="p">,</span>
          <span class="s">&#39;No permission -- see authorization schemes&#39;</span><span class="p">),</span>
    <span class="mi">402</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Payment Required&#39;</span><span class="p">,</span>
          <span class="s">&#39;No payment -- see charging schemes&#39;</span><span class="p">),</span>
    <span class="mi">403</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Forbidden&#39;</span><span class="p">,</span>
          <span class="s">&#39;Request forbidden -- authorization will not help&#39;</span><span class="p">),</span>
    <span class="mi">404</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Not Found&#39;</span><span class="p">,</span> <span class="s">&#39;Nothing matches the given URI&#39;</span><span class="p">),</span>
    <span class="mi">405</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Method Not Allowed&#39;</span><span class="p">,</span>
          <span class="s">&#39;Specified method is invalid for this server.&#39;</span><span class="p">),</span>
    <span class="mi">406</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Not Acceptable&#39;</span><span class="p">,</span> <span class="s">&#39;URI not available in preferred format.&#39;</span><span class="p">),</span>
    <span class="mi">407</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Proxy Authentication Required&#39;</span><span class="p">,</span> <span class="s">&#39;You must authenticate with &#39;</span>
          <span class="s">&#39;this proxy before proceeding.&#39;</span><span class="p">),</span>
    <span class="mi">408</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Request Timeout&#39;</span><span class="p">,</span> <span class="s">&#39;Request timed out; try again later.&#39;</span><span class="p">),</span>
    <span class="mi">409</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Conflict&#39;</span><span class="p">,</span> <span class="s">&#39;Request conflict.&#39;</span><span class="p">),</span>
    <span class="mi">410</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Gone&#39;</span><span class="p">,</span>
          <span class="s">&#39;URI no longer exists and has been permanently removed.&#39;</span><span class="p">),</span>
    <span class="mi">411</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Length Required&#39;</span><span class="p">,</span> <span class="s">&#39;Client must specify Content-Length.&#39;</span><span class="p">),</span>
    <span class="mi">412</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Precondition Failed&#39;</span><span class="p">,</span> <span class="s">&#39;Precondition in headers is false.&#39;</span><span class="p">),</span>
    <span class="mi">413</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Request Entity Too Large&#39;</span><span class="p">,</span> <span class="s">&#39;Entity is too large.&#39;</span><span class="p">),</span>
    <span class="mi">414</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Request-URI Too Long&#39;</span><span class="p">,</span> <span class="s">&#39;URI is too long.&#39;</span><span class="p">),</span>
    <span class="mi">415</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Unsupported Media Type&#39;</span><span class="p">,</span> <span class="s">&#39;Entity body in unsupported format.&#39;</span><span class="p">),</span>
    <span class="mi">416</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Requested Range Not Satisfiable&#39;</span><span class="p">,</span>
          <span class="s">&#39;Cannot satisfy request range.&#39;</span><span class="p">),</span>
    <span class="mi">417</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Expectation Failed&#39;</span><span class="p">,</span>
          <span class="s">&#39;Expect condition could not be satisfied.&#39;</span><span class="p">),</span>

    <span class="mi">500</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="s">&#39;Server got itself in trouble&#39;</span><span class="p">),</span>
    <span class="mi">501</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Not Implemented&#39;</span><span class="p">,</span>
          <span class="s">&#39;Server does not support this operation&#39;</span><span class="p">),</span>
    <span class="mi">502</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Bad Gateway&#39;</span><span class="p">,</span> <span class="s">&#39;Invalid responses from another server/proxy.&#39;</span><span class="p">),</span>
    <span class="mi">503</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Service Unavailable&#39;</span><span class="p">,</span>
          <span class="s">&#39;The server cannot process the request due to a high load&#39;</span><span class="p">),</span>
    <span class="mi">504</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;Gateway Timeout&#39;</span><span class="p">,</span>
          <span class="s">&#39;The gateway server did not receive a timely response&#39;</span><span class="p">),</span>
    <span class="mi">505</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;HTTP Version Not Supported&#39;</span><span class="p">,</span> <span class="s">&#39;Cannot fulfill request.&#39;</span><span class="p">),</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>エラーが起きた場合、サーバーは HTTP エラーコード <em>と</em> エラーページを返して応答します。返されたページに対する応答として <tt class="xref py py-exc docutils literal"><span class="pre">HTTPError</span></tt> インスタンスを使うことができます。これは code 属性に対しても同様です、これらは read も geturl, info などのメソッドも持っています。:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">&#39;http://www.python.org/fish.html&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">except</span> <span class="n">URLError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">print</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">print</span> <span class="n">e</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="go">404</span>
<span class="go">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span>
<span class="go">    &quot;http://www.w3.org/TR/html4/loose.dtd&quot;&gt;</span>
<span class="go">&lt;?xml-stylesheet href=&quot;./css/ht2html.css&quot;</span>
<span class="go">    type=&quot;text/css&quot;?&gt;</span>
<span class="go">&lt;html&gt;&lt;head&gt;&lt;title&gt;Error 404: File Not Found&lt;/title&gt;</span>
<span class="go">...... etc...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id11">
<h3>エラーをラップする<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><tt class="xref py py-exc docutils literal"><span class="pre">HTTPError</span></tt> <em>または</em> <tt class="xref py py-exc docutils literal"><span class="pre">URLError</span></tt> が起きたときのために準備しておきたい場合には。二つの基本的なアプローチがあります。私は二つ目のアプローチを好みます。</p>
<div class="section" id="id12">
<h4>その1<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-python"><pre>from urllib2 import Request, urlopen, URLError, HTTPError
req = Request(someurl)
try:
    response = urlopen(req)
except HTTPError, e:
    print 'The server couldn\'t fulfill the request.'
    print 'Error code: ', e.code
except URLError, e:
    print 'We failed to reach a server.'
    print 'Reason: ', e.reason
else:
    # everything is fine</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last"><tt class="docutils literal"><span class="pre">except</span> <span class="pre">HTTPError</span></tt> が <em>必ず</em> 最初に来る必要があります、そうしないと <tt class="docutils literal"><span class="pre">except</span> <span class="pre">URLError</span></tt> も <tt class="xref py py-exc docutils literal"><span class="pre">HTTPError</span></tt> を捕捉してしまいます。</p>
</div>
</div>
<div class="section" id="id13">
<h4>その2<a class="headerlink" href="#id13" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-python"><pre>from urllib2 import Request, urlopen, URLError
req = Request(someurl)
try:
    response = urlopen(req)
except URLError, e:
    if hasattr(e, 'reason'):
        print 'We failed to reach a server.'
        print 'Reason: ', e.reason
    elif hasattr(e, 'code'):
        print 'The server couldn\'t fulfill the request.'
        print 'Error code: ', e.code
else:
    # everything is fine</pre>
</div>
</div>
</div>
</div>
<div class="section" id="info-geturl">
<h2>info と geturl<a class="headerlink" href="#info-geturl" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>レスポンスは urlopen (または <tt class="xref py py-exc docutils literal"><span class="pre">HTTPError</span></tt> インスタンス) によって返され、
<tt class="xref py py-meth docutils literal"><span class="pre">info()</span></tt> と <tt class="xref py py-meth docutils literal"><span class="pre">geturl()</span></tt> の二つの便利なメソッドを持っています。</p>
<p><strong>geturl</strong> - これは取得したページの実際の URL を返します。
<tt class="docutils literal"><span class="pre">urlopen</span></tt> (または 利用される opener オブジェクト) はリダイレクトに追従するため、有用です。取得したページの URL は要求した URL と同じとは限りません。</p>
<p><strong>info</strong> - これは取得したページ (特にサーバからヘッダ)を表す辞書風オブジェクトを返します。これは現在では <tt class="docutils literal"><span class="pre">httplib.HTTPMessage</span></tt> インスタンスです。</p>
<p>典型的なヘッダは &#8216;Content-length&#8217;, &#8216;Content-type&#8217; 等を含んでいます。
HTTP ヘッダその意味と利用法について簡単な説明がつきの便利な一覧
<a class="reference external" href="http://www.cs.tut.fi/~jkorpela/http.html">Quick Reference to HTTP Headers</a> を参照して下さい、</p>
</div>
<div class="section" id="openers-handlers">
<h2>Openers と Handlers<a class="headerlink" href="#openers-handlers" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>URL を取得する場合、opener (混乱を招きやすい名前ですが、 <a class="reference internal" href="../library/urllib2.html#urllib2.OpenerDirector" title="urllib2.OpenerDirector"><tt class="xref py py-class docutils literal"><span class="pre">urllib2.OpenerDirector</span></tt></a> のインスタンス) を利用します。標準的にはデフォルトの opener を - <tt class="docutils literal"><span class="pre">urlopen</span></tt> を通して - 利用していますが、カスタムの opener を作成することもできます。
oppener は handler を利用します。全ての「一番厄介な仕事」はハンドラによって行なわれます。各 handler は特定の URL スキーム (http, ftp, 等) での URL の開き方を知っていたり、
URL を開く局面でどう処理するかを知っています、例えば HTTP リダイレクションや
HTTP のクッキーなど。</p>
<p>インストール済みの特定のハンドラで URL を取得したい場合には、
opener を作成したいと思うでしょう、例えばクッキーを処理する opener が得たい場合や、リダイレクションを処理しない opener を得たい場合。</p>
<p>opener を作成するには、 <tt class="docutils literal"><span class="pre">OpenerDirector</span></tt> をインスタンス化して、続けて、 <tt class="docutils literal"><span class="pre">.add_handler(some_handler_instance)</span></tt> を呼び出します。</p>
<p>それに代わる方法として、 <tt class="docutils literal"><span class="pre">build_opener</span></tt> を利用することもできます、これは opener オブジェクトを一回の関数呼び出しで作成できる便利な関数です。
<tt class="docutils literal"><span class="pre">build_opener</span></tt> はいくつかのハンドラをデフォルトで追加しますが、デフォルトのハンドラに対して追加、継承のどちらかまたは両方を行うのに手っ取り早い方法を提供してくれます。</p>
<p>追加したくなる可能性がある handler としては、プロキシ処理、認証など、一般的ですがいくらか特定の状況に限られるものでしょう。</p>
<p><tt class="docutils literal"><span class="pre">install_opener</span></tt> も (グローバルな) デフォルト <tt class="docutils literal"><span class="pre">opener</span></tt> オブジェクトの作成に利用できます。つまり、 <tt class="docutils literal"><span class="pre">urlopen</span></tt> を呼び出すと、インストールした opener が利用されます。</p>
<p>opener オブジェクトは <tt class="docutils literal"><span class="pre">open</span></tt> メソッドを持っていて、
<tt class="docutils literal"><span class="pre">urlopen</span></tt> 関数と同じ様に、url を取得するのに直接呼び出すことができます:
利便性を除けば <tt class="docutils literal"><span class="pre">install_opener</span></tt> を使う必要はありません。</p>
</div>
<div class="section" id="basic">
<h2>Basic 認証<a class="headerlink" href="#basic" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ハンドラの作成とインストールを例示するのに、 <tt class="docutils literal"><span class="pre">HTTPBasicAuthHandler</span></tt> を利用してみます。この話題についてのより詳しい議論は &#8211; Basic 認証がどうやって動作するのかの説明も含んでいる
<a class="reference external" href="http://www.voidspace.org.uk/python/articles/authentication.shtml">Basic Authentication Tutorial</a>
を参照して下さい。</p>
<p>認証が必要な場合、サーバは認証を要求するヘッダ (401 のエラーコードとともに) を送ります。これによって認証スキームと &#8216;realm&#8217; が指定されます。ヘッダはこのようになっています: <tt class="docutils literal"><span class="pre">Www-authenticate:</span> <span class="pre">SCHEME</span> <span class="pre">realm=&quot;REALM&quot;</span></tt> 。</p>
<p>例:</p>
<div class="highlight-python"><pre>Www-authenticate: Basic realm="cPanel Users"</pre>
</div>
<p>クライアントはリクエストヘッダに含まれる realm に対して適切な名前とパスワードとともにリクエストを再試行する必要があります。これが &#8216;basic 認証&#8217; です。一連の流れを簡単化するために、 <tt class="docutils literal"><span class="pre">HTTPBasicAuthHandler</span></tt> のインスタンスを作成し、
opener が handler を利用するようにします。</p>
<p><tt class="docutils literal"><span class="pre">HTTPBasicAuthHandler</span></tt> はパスワードマネージャーと呼ばれる、
URL と realm をパスワードとユーザ名への対応づけを処理する、オブジェクトを利用します。
realm が何なのか(サーバから返される認証ヘッダから) 知りたい場合には、
<tt class="docutils literal"><span class="pre">HTTPPasswordMgr</span></tt> を利用できます。多くの場合、realm が何なのかについて気にすることはありません。そのような場合には <tt class="docutils literal"><span class="pre">HTTPPasswordMgrWithDefaultRealm</span></tt> を使うと便利です。これは URL に対してデフォルトのユーザ名とパスワードを指定できます。これによって特定の realm に対する代替の組み合わせを提供することなしに利用できるようになります。このことは <tt class="docutils literal"><span class="pre">add_password</span></tt> メソッドの realm 引数として <tt class="docutils literal"><span class="pre">None</span></tt> を与えることで明示することができます。</p>
<p>トップレベルの URL が認証が必要なはじめに URL です。この URL よりも「深い」URL を渡しても .add_password() は同様にマッチします。:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># create a password manager</span>
<span class="n">password_mgr</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPPasswordMgrWithDefaultRealm</span><span class="p">()</span>

<span class="c"># Add the username and password.</span>
<span class="c"># If we knew the realm, we could use it instead of ``None``.</span>
<span class="n">top_level_url</span> <span class="o">=</span> <span class="s">&quot;http://example.com/foo/&quot;</span>
<span class="n">password_mgr</span><span class="o">.</span><span class="n">add_password</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">top_level_url</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

<span class="n">handler</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPBasicAuthHandler</span><span class="p">(</span><span class="n">password_mgr</span><span class="p">)</span>

<span class="c"># create &quot;opener&quot; (OpenerDirector instance)</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

<span class="c"># use the opener to fetch a URL</span>
<span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">a_url</span><span class="p">)</span>

<span class="c"># Install the opener.</span>
<span class="c"># Now all calls to urllib2.urlopen use our opener.</span>
<span class="n">urllib2</span><span class="o">.</span><span class="n">install_opener</span><span class="p">(</span><span class="n">opener</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last">上の例では <tt class="docutils literal"><span class="pre">build_opener</span></tt> に <tt class="docutils literal"><span class="pre">HHTPBasicAuthHandler</span></tt> のみを与えましたが。デフォルトの opener は普通の状況に適用するために
&#8211; <tt class="docutils literal"><span class="pre">ProxyHandler</span></tt>, <tt class="docutils literal"><span class="pre">UnknownHandler</span></tt>, <tt class="docutils literal"><span class="pre">HTTPHandler</span></tt>,
<tt class="docutils literal"><span class="pre">HTTPDefaultErrorHandler</span></tt>, <tt class="docutils literal"><span class="pre">HTTPRedirectHandler</span></tt>, <tt class="docutils literal"><span class="pre">FTPHandler</span></tt>,
<tt class="docutils literal"><span class="pre">FileHandler</span></tt>, <tt class="docutils literal"><span class="pre">HTTPErrorProcessor</span></tt> を備えています。</p>
</div>
<p><tt class="docutils literal"><span class="pre">top_level_url</span></tt> は実際には &#8220;<a class="reference external" href="http://example.com/">http://example.com/</a>&#8221; のような完全な URL (&#8216;http:&#8217; スキームとホスト名、オプションとしてポート番号、含む)  <em>か</em>
&#8220;example.com&#8221; や &#8220;example.com:8080&#8221; (後者はポート番号を含む) のような
&#8220;authority&#8221; (つまり、ホスト名とオプションとしてポート番号を含む) の
<em>どちらでも</em> かまいません。
authority の場合には &#8220;userinfo&#8221; 要素は含んではいけません
- 例えば &#8220;<a class="reference external" href="mailto:joe&#37;&#52;&#48;password">joe<span>&#64;</span>password</a>:example.com&#8221; は不適切です。</p>
</div>
<div class="section" id="id14">
<h2>プロキシ<a class="headerlink" href="#id14" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><strong>urllib2</strong> は自動でプロキシ設定を認識して使います。これは通常の handler の組に含まれる <tt class="docutils literal"><span class="pre">ProxyHandler</span></tt> を通して行なわれます。たいていの場合はこれでうまくいきますが、役に立たない場合もあります <a class="footnote-reference" href="#id24" id="id15">[6]</a> 。この問題に対処する一つの方法はプロキシを定義しない <tt class="docutils literal"><span class="pre">ProxyHandler</span></tt> を組み立てることです。この方法は <a class="reference external" href="http://www.voidspace.org.uk/python/articles/authentication.shtml">Basic Authentication</a> handler を設定したときと同じような流れで行うことができます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">proxy_support</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">ProxyHandler</span><span class="p">({})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">proxy_support</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">urllib2</span><span class="o">.</span><span class="n">install_opener</span><span class="p">(</span><span class="n">opener</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last">現在 <tt class="docutils literal"><span class="pre">urllib2</span></tt> はプロキシ経由で <tt class="docutils literal"><span class="pre">https</span></tt> ロケーションを取得する機能をサポートしていません。しかし、urllib2 をこのレシピ <a class="footnote-reference" href="#id25" id="id16">[7]</a> で拡張することで可能にすることができます。</p>
</div>
</div>
<div class="section" id="id17">
<h2>ソケットとレイヤー<a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Python はレイヤー化された web 上からリソース取得もサポートしています。
urllib2 は httplib ライブラリを利用します、
httplib はさらに socket ライブラリを利用します。</p>
<p>Python 2.3 ではレスポンスがタイムアウトするまでのソケットの待ち時間を指定することができます。これは web ページを取得する場合に便利に使うことができます。
socket モジュールのデフォルトでは <em>タイムアウトが無く</em>
ハングしてしまうかもしれません。現在では socket のタイムアウトは httplib や urllib2 のレベルからは隠蔽されていています。しかし、以下を利用することで全てのソケットに対してグローバルにデフォルトタイムアウトを設定することができます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="c"># timeout in seconds</span>
<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

<span class="c"># this call to urllib2.urlopen now uses the default timeout</span>
<span class="c"># we have set in the socket module</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">&#39;http://www.voidspace.org.uk&#39;</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</pre></div>
</div>
<hr class="docutils" />
</div>
<div class="section" id="id18">
<h2>脚注<a class="headerlink" href="#id18" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>このドキュメントは John Lee によって査読、改訂されました。</p>
<table class="docutils footnote" frame="void" id="id19" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[1]</a></td><td>CGI プロトコルの入門については
<a class="reference external" href="http://www.pyzine.com/Issue008/Section_Articles/article_CGIOne.html">Writing Web Applications in Python</a>
を参照して下さい。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id20" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[2]</a></td><td>例を挙げると Google がそうです。プログラムから google を使う
<em>正しい</em> やり方は、もちろん <a class="reference external" href="http://pygoogle.sourceforge.net">PyGoogle</a> を利用することです。
Google API を利用した例については
<a class="reference external" href="http://www.voidspace.org.uk/python/recipebook.shtml#google">Voidspace Google</a>
を参照して下さい。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id21" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[3]</a></td><td>ブラウザを検知すること (browser sniffing) は web サイトのデザインにおけるとても悪い習慣です - web 標準を利用する方が賢明でしょう。不幸なことに未だに多くの web サイトが異なるブラウザに対して異なるバージョンを返しています。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id22" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[4]</a></td><td>MSIE 6 のユーザエージェントは
<em>&#8216;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)&#8217;</em>
です。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id23" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[5]</a></td><td>HTTP リクエストヘッダの詳細については、
<a class="reference external" href="http://www.cs.tut.fi/~jkorpela/http.html">Quick Reference to HTTP Headers</a> を参照して下さい。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id24" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id15">[6]</a></td><td>私の場合は仕事中にインターネットにアクセスするにはプロキシを利用する必要があります。
<em>localhost</em> の URL に対してこのプロキシを経由してアクセスしようとすれば、ブロックされます。IE を proxy を利用するように設定すれば、
urllib2 はその情報を利用します。
localhost のサーバでスクリプトをテストしようとすると、
urllib2 がプロキシを利用するのを止めなければいけません。</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id25" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id16">[7]</a></td><td>urllib2 opener for SSL proxy (CONNECT method): <a class="reference external" href="http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/456195">ASPN Cookbook Recipe</a>.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="webservers.html" title="Python を Web 上で使うには HOWTO"
             >次へ</a> |</li>
        <li class="right" >
          <a href="unicode.html" title="Unicode HOWTO"
             >前へ</a> |</li>
        <li><img src="../_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="../index.html">Python 2.7ja1 documentation</a> &raquo;</li>

          <li><a href="index.html" >Python HOWTO</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 1990-2011, Python Software Foundation.
      最終更新: 2011-12-26
      このドキュメントは <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/02cb752c6a9e で生成しました。
    </div>
  </body>
</html>