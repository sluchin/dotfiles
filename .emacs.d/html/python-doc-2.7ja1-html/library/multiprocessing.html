

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>16.6. multiprocessing — プロセスベースの “並列処理” インタフェース &mdash; Python 2.7ja1 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.7ja1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Python 2.7ja1 documentation 内を検索"
          href="../_static/opensearch.xml"/>
    <link rel="author" title="このドキュメントについて" href="../about.html" />
    <link rel="copyright" title="著作権" href="../copyright.html" />
    <link rel="top" title="Python 2.7ja1 documentation" href="../index.html" />
    <link rel="up" title="16. オプションのオペレーティングシステムサービス" href="someos.html" />
    <link rel="next" title="16.7. mmap — メモリマップファイル" href="mmap.html" />
    <link rel="prev" title="16.5. dummy_thread — thread の代替モジュール" href="dummy_thread.html" />
    <link rel="shortcut icon" type="image/png" href="../_static/py.png" />
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/_jp.js"></script>
    
 

  </head>
  <body>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="mmap.html" title="16.7. mmap — メモリマップファイル"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="dummy_thread.html" title="16.5. dummy_thread — thread の代替モジュール"
             accesskey="P">前へ</a> |</li>
        <li><img src="../_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="../index.html">Python 2.7ja1 documentation</a> &raquo;</li>

          <li><a href="index.html" >Python 標準ライブラリ</a> &raquo;</li>
          <li><a href="someos.html" accesskey="U">16. オプションのオペレーティングシステムサービス</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../contents.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">16.6. <tt class="docutils literal"><span class="pre">multiprocessing</span></tt> &#8212; プロセスベースの &#8220;並列処理&#8221; インタフェース</a><ul>
<li><a class="reference internal" href="#id1">16.6.1. はじめに</a><ul>
<li><a class="reference internal" href="#process">16.6.1.1. <tt class="docutils literal"><span class="pre">Process</span></tt> クラス</a></li>
<li><a class="reference internal" href="#id2">16.6.1.2. プロセス間でのオブジェクト交換</a></li>
<li><a class="reference internal" href="#id3">16.6.1.3. プロセス間の同期</a></li>
<li><a class="reference internal" href="#id4">16.6.1.4. プロセス間での状態の共有</a></li>
<li><a class="reference internal" href="#id5">16.6.1.5. ワーカープロセスのプールを使用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6">16.6.2. リファレンス</a><ul>
<li><a class="reference internal" href="#id7">16.6.2.1. <tt class="docutils literal"><span class="pre">Process</span></tt> クラスと例外</a></li>
<li><a class="reference internal" href="#pipe-queue">16.6.2.2. パイプ (Pipe) とキュー (Queue)</a></li>
<li><a class="reference internal" href="#miscellaneous">16.6.2.3. その他の関数(Miscellaneous)</a></li>
<li><a class="reference internal" href="#connection">16.6.2.4. Connection オブジェクト</a></li>
<li><a class="reference internal" href="#id8">16.6.2.5. 同期プリミティブ</a></li>
<li><a class="reference internal" href="#ctypes">16.6.2.6. 共有 <tt class="docutils literal"><span class="pre">ctypes</span></tt> オブジェクト</a><ul>
<li><a class="reference internal" href="#multiprocessing-sharedctypes">16.6.2.6.1. <tt class="docutils literal"><span class="pre">multiprocessing.sharedctypes</span></tt> モジュール</a></li>
</ul>
</li>
<li><a class="reference internal" href="#managers">16.6.2.7. Managers</a><ul>
<li><a class="reference internal" href="#namespace">16.6.2.7.1. Namespace オブジェクト</a></li>
<li><a class="reference internal" href="#id9">16.6.2.7.2. カスタマイズされたマネージャ</a></li>
<li><a class="reference internal" href="#id10">16.6.2.7.3. リモートマネージャを使用する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#proxy">16.6.2.8. Proxy オブジェクト</a><ul>
<li><a class="reference internal" href="#id11">16.6.2.8.1. クリーンアップ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-multiprocessing.pool">16.6.2.9. プロセスプール</a></li>
<li><a class="reference internal" href="#module-multiprocessing.connection">16.6.2.10. Listeners and Clients</a><ul>
<li><a class="reference internal" href="#multiprocessing-address-formats">16.6.2.10.1. アドレスフォーマット</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multiprocessing-auth-keys">16.6.2.11. 認証キー</a></li>
<li><a class="reference internal" href="#id15">16.6.2.12. ロギング</a></li>
<li><a class="reference internal" href="#module-multiprocessing.dummy">16.6.2.13. <tt class="docutils literal"><span class="pre">multiprocessing.dummy</span></tt> モジュール</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multiprocessing-programming">16.6.3. プログラミングガイドライン</a><ul>
<li><a class="reference internal" href="#id17">16.6.3.1. 全てのプラットホーム</a></li>
<li><a class="reference internal" href="#windows">16.6.3.2. Windows</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multiprocessing-examples">16.6.4. 例</a></li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="dummy_thread.html"
                        title="前の章へ">16.5. <tt class="docutils literal docutils literal docutils literal"><span class="pre">dummy_thread</span></tt> &#8212; <tt class="docutils literal docutils literal docutils literal"><span class="pre">thread</span></tt> の代替モジュール</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="mmap.html"
                        title="次の章へ">16.7. <tt class="docutils literal docutils literal"><span class="pre">mmap</span></tt> &#8212; メモリマップファイル</a></p>
  <h3>このページ</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/library/multiprocessing.txt"
           rel="nofollow">ソースコードを表示</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>クイック検索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    モジュール、クラス、または関数名を入力してください
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-multiprocessing">
<span id="multiprocessing"></span><h1>16.6. <a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> &#8212; プロセスベースの &#8220;並列処理&#8221; インタフェース<a class="headerlink" href="#module-multiprocessing" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p class="versionadded">
<span class="versionmodified">バージョン 2.6 で追加.</span></p>
<div class="section" id="id1">
<h2>16.6.1. はじめに<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> はPythonの標準ライブラリのパッケージで
<a class="reference internal" href="threading.html#module-threading" title="threading: 高水準のスレッドインタフェース"><tt class="xref py py-mod docutils literal"><span class="pre">threading</span></tt></a> とよく似た API を使ってプロセスを生成することができます。
<a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> パッケージを使用すると、ローカルとリモート両方の並列制御を行うことができます。また、このパッケージはスレッドの代わりにサブプロセスを使用することにより、グローバルインタプリタロック ( <a class="reference internal" href="../glossary.html#term-global-interpreter-lock"><em class="xref std std-term">Global Interpreter Lock</em></a> )
の問題を避ける工夫が行われています。このような特徴があるため <a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> モジュールを使うことで、マルチプロセッサマシンの性能を最大限に活用することができるでしょう。なお、このモジュールは Unix と Windows で動作します。</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">このパッケージに含まれる機能には、ホストとなるオペレーティングシステム上で動作している共有セマフォ (shared semaphore) を使用しているものがあります。これが使用できない場合には、 <tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing.synchronize</span></tt> モジュールが無効になり、このモジュールのインポート時に <a class="reference internal" href="exceptions.html#exceptions.ImportError" title="exceptions.ImportError"><tt class="xref py py-exc docutils literal"><span class="pre">ImportError</span></tt></a> が発生します。詳細は <a class="reference external" href="http://bugs.python.org/issue3770">issue 3770</a> を参照してください。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p>このパッケージに含まれる機能を使用するためには、子プロセスから
<tt class="docutils literal"><span class="pre">__main__</span></tt> モジュールを呼び出せる必要があります。このことについては <a class="reference internal" href="#multiprocessing-programming"><em>プログラミングガイドライン</em></a> で触れていますが、ここであらためて強調しておきます。何故かというと、いくつかのサンプルコード、例えば
<tt class="xref py py-class docutils literal"><span class="pre">multiprocessing.Pool</span></tt> のサンプルはインタラクティブシェル上では動作しないからです。以下に例を示します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="go">Process PoolWorker-1:</span>
<span class="go">Process PoolWorker-2:</span>
<span class="go">Process PoolWorker-3:</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="nc">AttributeError</span>: <span class="n-Identifier">&#39;module&#39; object has no attribute &#39;f&#39;</span>
<span class="go">AttributeError: &#39;module&#39; object has no attribute &#39;f&#39;</span>
<span class="go">AttributeError: &#39;module&#39; object has no attribute &#39;f&#39;</span>
</pre></div>
</div>
<p class="last">(このサンプルを試すと、3つのトレースバック全てがほぼランダムに交互に重なって表示されます。そうなったら、なんとかしてマスタープロセスを止めましょう。)</p>
</div>
<div class="section" id="process">
<h3>16.6.1.1. <a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a> クラス<a class="headerlink" href="#process" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> モジュールでは、プロセスは以下の手順によって生成されます。はじめに <a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a>  のオブジェクトを作成し、続いて <a class="reference internal" href="#multiprocessing.Process.start" title="multiprocessing.Process.start"><tt class="xref py py-meth docutils literal"><span class="pre">start()</span></tt></a> メソッドを呼び出します。この <a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a> クラスは <a class="reference internal" href="threading.html#threading.Thread" title="threading.Thread"><tt class="xref py py-class docutils literal"><span class="pre">threading.Thread</span></tt></a> クラスと同様の API を持っています。まずは、簡単な例をもとにマルチプロセスを使用したプログラムについてみていきましょう。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="n">name</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;bob&#39;</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>実行された個々のプロセス ID を表示するために拡張したサンプルコードを以下に例を示します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">title</span>
    <span class="k">print</span> <span class="s">&#39;module name:&#39;</span><span class="p">,</span> <span class="n">__name__</span>
    <span class="k">print</span> <span class="s">&#39;parent process:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getppid</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;process id:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">info</span><span class="p">(</span><span class="s">&#39;function f&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="n">name</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">info</span><span class="p">(</span><span class="s">&#39;main line&#39;</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;bob&#39;</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>(Windows 環境で) <tt class="docutils literal"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__'</span></tt> という文が必要な理由については、
<a class="reference internal" href="#multiprocessing-programming"><em>プログラミングガイドライン</em></a> を参照してください。</p>
</div>
<div class="section" id="id2">
<h3>16.6.1.2. プロセス間でのオブジェクト交換<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> モジュールでは、プロセス間通信の手段が2つ用意されています。それぞれ以下に詳細を示します。</p>
<p><strong>キュー (Queue)</strong></p>
<blockquote>
<div><p><a class="reference internal" href="queue.html#module-Queue" title="Queue: 同期キュークラス"><tt class="xref py py-class docutils literal"><span class="pre">Queue</span></tt></a> クラスは <a class="reference internal" href="queue.html#Queue.Queue" title="Queue.Queue"><tt class="xref py py-class docutils literal"><span class="pre">Queue.Queue</span></tt></a> クラスとほとんど同じように使うことができます。以下に例を示します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="mi">42</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;hello&#39;</span><span class="p">])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>    <span class="c"># &quot;[42, None, &#39;hello&#39;]&quot; を表示</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>キューはスレッドセーフであり、プロセスセーフです。</p>
</div></blockquote>
<p><strong>パイプ (Pipe)</strong></p>
<blockquote>
<div><p><a class="reference internal" href="#multiprocessing.Pipe" title="multiprocessing.Pipe"><tt class="xref py py-func docutils literal"><span class="pre">Pipe()</span></tt></a> 関数は接続用オブジェクトのペアを返します。デフォルトでは、このオブジェクトを介して、親子間でパイプを使った双方向通信をおこなうことができます。以下に例を示します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Pipe</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="mi">42</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;hello&#39;</span><span class="p">])</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parent_conn</span><span class="p">,</span> <span class="n">child_conn</span> <span class="o">=</span> <span class="n">Pipe</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">child_conn</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">parent_conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>   <span class="c"># &quot;[42, None, &#39;hello&#39;]&quot; を表示</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>2つのコネクション用オブジェクトが <a class="reference internal" href="#multiprocessing.Pipe" title="multiprocessing.Pipe"><tt class="xref py py-func docutils literal"><span class="pre">Pipe()</span></tt></a> 関数から返され、親側の入出力、子側の入出力といったように、それぞれパイプの両端となります。
(他プロセスと通信する方法として) 各接続用オブジェクトには、
<a class="reference internal" href="#multiprocessing.Connection.send" title="multiprocessing.Connection.send"><tt class="xref py py-meth docutils literal"><span class="pre">send()</span></tt></a> メソッドと <a class="reference internal" href="#multiprocessing.Connection.recv" title="multiprocessing.Connection.recv"><tt class="xref py py-meth docutils literal"><span class="pre">recv()</span></tt></a> メソッドがあります。データを破壊してしまうような使い方に注意する必要があります。それは、2つのプロセス (もしくはスレッド) が同時に <em>同じ</em> パイプに対して、読み書きをおこなった場合に起こります。もちろん、異なったパイプを使用していれば、同時に読み書きをおこなってもデータが破壊されてしまう危険性はありません。</p>
</div></blockquote>
</div>
<div class="section" id="id3">
<h3>16.6.1.3. プロセス間の同期<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> は <a class="reference internal" href="threading.html#module-threading" title="threading: 高水準のスレッドインタフェース"><tt class="xref py py-mod docutils literal"><span class="pre">threading</span></tt></a> モジュールと同じプロセス間同期の仕組みを備えています。以下の例では、ロックを使用して、一度に1つのプロセスしか標準出力に書き込まないようにしています。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Lock</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="n">l</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;hello world&#39;</span><span class="p">,</span> <span class="n">i</span>
    <span class="n">l</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>ロックを使用しないで標準出力に書き込んだ場合は、各プロセスからの出力がごちゃまぜになってしまいます。</p>
</div>
<div class="section" id="id4">
<h3>16.6.1.4. プロセス間での状態の共有<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>これまでの話の流れで触れたとおり、並列プログラミングをする時には、出来る限り状態を共有しないというのが定石です。複数のプロセッサを使用するときは特にそうでしょう。</p>
<p>しかし、どうしてもプロセス間のデータ共有が必要な場合のために
<a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> モジュールにはその方法が用意されています。</p>
<p><strong>共有メモリ (Shared memory)</strong></p>
<blockquote>
<div><p>データを共有メモリ上に保持するために <a class="reference internal" href="#multiprocessing.Value" title="multiprocessing.Value"><tt class="xref py py-class docutils literal"><span class="pre">Value</span></tt></a> クラス、もしくは <a class="reference internal" href="#multiprocessing.Array" title="multiprocessing.Array"><tt class="xref py py-class docutils literal"><span class="pre">Array</span></tt></a> クラスを使用することができます。以下のサンプルコードを使って、この機能についてみていきましょう。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Array</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="n">n</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mf">3.1415927</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">arr</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">print</span> <span class="n">num</span><span class="o">.</span><span class="n">value</span>
    <span class="k">print</span> <span class="n">arr</span><span class="p">[:]</span>
</pre></div>
</div>
<p>このサンプルコードを実行すると以下のように表示されます。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="mf">3.1415927</span>
<span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">]</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">num</span></tt> と <tt class="docutils literal"><span class="pre">arr</span></tt> を生成するときに使用されている <tt class="docutils literal"><span class="pre">'d'</span></tt> と <tt class="docutils literal"><span class="pre">'i'</span></tt> の引数は
<a class="reference internal" href="array.html#module-array" title="array: 一様な型を持つ数値からなる空間効率のよいアレイ。"><tt class="xref py py-mod docutils literal"><span class="pre">array</span></tt></a> モジュールにより使用される種別の型コードです。ここで使用されている <tt class="docutils literal"><span class="pre">'d'</span></tt> は倍精度浮動小数、 <tt class="docutils literal"><span class="pre">'i'</span></tt> は符号付整数を表します。これらの共有オブジェクトは、プロセスセーフでありスレッドセーフです。</p>
<p>共有メモリを使用して、さらに柔軟なプログラミングを行うには
<a class="reference internal" href="#module-multiprocessing.sharedctypes" title="multiprocessing.sharedctypes: 共有メモリから ctypes オブジェクトを割り当てる"><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing.sharedctypes</span></tt></a> モジュールを使用します。このモジュールは共有メモリから割り当てられた任意の ctypes オブジェクトの生成をサポートします。</p>
</div></blockquote>
<p><strong>サーバプロセス (Server process)</strong></p>
<blockquote>
<div><p><tt class="xref py py-func docutils literal"><span class="pre">Manager()</span></tt> 関数により生成されたマネージャオブジェクトはサーバプロセスを管理します。マネージャオブジェクトは Python のオブジェクトを保持して、他のプロセスがプロキシ経由でその Python オブジェクトを操作することができます。</p>
<p><tt class="xref py py-func docutils literal"><span class="pre">Manager()</span></tt> 関数が返すマネージャは <a class="reference internal" href="functions.html#list" title="list"><tt class="xref py py-class docutils literal"><span class="pre">list</span></tt></a> 、 <a class="reference internal" href="stdtypes.html#dict" title="dict"><tt class="xref py py-class docutils literal"><span class="pre">dict</span></tt></a> 、
<tt class="xref py py-class docutils literal"><span class="pre">Namespace</span></tt> 、 <a class="reference internal" href="#multiprocessing.Lock" title="multiprocessing.Lock"><tt class="xref py py-class docutils literal"><span class="pre">Lock</span></tt></a> 、 <a class="reference internal" href="#multiprocessing.RLock" title="multiprocessing.RLock"><tt class="xref py py-class docutils literal"><span class="pre">RLock</span></tt></a> 、 <a class="reference internal" href="#multiprocessing.Semaphore" title="multiprocessing.Semaphore"><tt class="xref py py-class docutils literal"><span class="pre">Semaphore</span></tt></a> 、
<a class="reference internal" href="#multiprocessing.BoundedSemaphore" title="multiprocessing.BoundedSemaphore"><tt class="xref py py-class docutils literal"><span class="pre">BoundedSemaphore</span></tt></a> 、 <a class="reference internal" href="#multiprocessing.Condition" title="multiprocessing.Condition"><tt class="xref py py-class docutils literal"><span class="pre">Condition</span></tt></a> 、 <a class="reference internal" href="#multiprocessing.Event" title="multiprocessing.Event"><tt class="xref py py-class docutils literal"><span class="pre">Event</span></tt></a> 、
<a class="reference internal" href="queue.html#module-Queue" title="Queue: 同期キュークラス"><tt class="xref py py-class docutils literal"><span class="pre">Queue</span></tt></a> 、 <a class="reference internal" href="#multiprocessing.Value" title="multiprocessing.Value"><tt class="xref py py-class docutils literal"><span class="pre">Value</span></tt></a> 、 <a class="reference internal" href="#multiprocessing.Array" title="multiprocessing.Array"><tt class="xref py py-class docutils literal"><span class="pre">Array</span></tt></a> をサポートします。以下にサンプルコードを示します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Manager</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
    <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span>
    <span class="n">d</span><span class="p">[</span><span class="s">&#39;2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">d</span><span class="p">[</span><span class="mf">0.25</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">l</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">print</span> <span class="n">d</span>
    <span class="k">print</span> <span class="n">l</span>
</pre></div>
</div>
<p>このサンプルコードを実行すると以下のように表示されます。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="mf">0.25</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>サーバプロセスのマネージャオブジェクトは共有メモリのオブジェクトよりも柔軟であるといえます。それは、どのような型のオブジェクトでも使えるからです。また、1つのマネージャオブジェクトはネットワーク経由で他のコンピュータ上のプロセスによって共有することもできます。しかし、共有メモリより動作が遅いという欠点があります。</p>
</div></blockquote>
</div>
<div class="section" id="id5">
<h3>16.6.1.5. ワーカープロセスのプールを使用<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><tt class="xref py py-class docutils literal"><span class="pre">Pool</span></tt> クラスは、ワーカープロセスをプールする機能を備えています。このクラスには、いくつかの方法で開放されたワーカープロセスへタスクを割り当てるメソッドがあります。</p>
<p>以下に例を示します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>              <span class="c"># 4つのワーカープロセスで開始</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">])</span>    <span class="c"># 非同期で &quot;f(10)&quot; を評価</span>
    <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>           <span class="c"># あなたのコンピュータが *かなり* 遅くない限りは &quot;100&quot; を表示</span>
    <span class="k">print</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>          <span class="c"># &quot;[0, 1, 4,..., 81]&quot; を表示</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2>16.6.2. リファレンス<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> パッケージは <a class="reference internal" href="threading.html#module-threading" title="threading: 高水準のスレッドインタフェース"><tt class="xref py py-mod docutils literal"><span class="pre">threading</span></tt></a> モジュールの API とほとんど同じです。</p>
<div class="section" id="id7">
<h3>16.6.2.1. <a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a> クラスと例外<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="class">
<dt id="multiprocessing.Process">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">Process</tt><big>(</big><span class="optional">[</span><em>group</em><span class="optional">[</span>, <em>target</em><span class="optional">[</span>, <em>name</em><span class="optional">[</span>, <em>args</em><span class="optional">[</span>, <em>kwargs</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Process" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>Process オブジェクトは各プロセスの振る舞いを表します。
<a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a> クラスは <a class="reference internal" href="threading.html#threading.Thread" title="threading.Thread"><tt class="xref py py-class docutils literal"><span class="pre">threading.Thread</span></tt></a> クラスの全てのメソッドと同じインタフェースを提供します。</p>
<p>コンストラクタは必ずキーワード引数で呼び出すべきです。引数 <em>group</em> には必ず <tt class="docutils literal"><span class="pre">None</span></tt> を渡してください。この引数は <a class="reference internal" href="threading.html#threading.Thread" title="threading.Thread"><tt class="xref py py-class docutils literal"><span class="pre">threading.Thread</span></tt></a> クラスとの互換性のためだけに残されています。引数 <em>target</em> には、呼び出し可能オブジェクト (Collable Object) を渡します。このオブジェクトは <a class="reference internal" href="#multiprocessing.Process.run" title="multiprocessing.Process.run"><tt class="xref py py-meth docutils literal"><span class="pre">run()</span></tt></a> メソッドから呼び出されます。この引数はデフォルトで <tt class="docutils literal"><span class="pre">None</span></tt> となっており、何も呼び出されません。引数 <em>name</em> にはプロセス名を渡します。デフォルトでは、自動でユニークな名前が割り当てられます。命名規則は、 &#8216;Process-N<sub>1</sub>:N<sub>2</sub>:...:N<sub>k</sub>&#8216; となります。ここで N<sub>1</sub>,N<sub>2</sub>,...,N<sub>k</sub> は整数の数列で、
<em>作成した</em> プロセス数に対応します。引数 <em>args</em> は target で指定された呼び出し可能オブジェクトへの引数を渡します。同じく、引数 <em>kwargs</em> はキーワード引数を渡します。デフォルトでは、 <em>target</em> には引数が渡されないようになっています。</p>
<p>サブクラスがコンストラクタをオーバーライドする場合は、そのプロセスに対する処理を行う前に基底クラスのコンストラクタ
(<tt class="xref py py-meth docutils literal"><span class="pre">Process.__init__()</span></tt>) を実行しなければなりません。</p>
<dl class="method">
<dt id="multiprocessing.Process.run">
<tt class="descname">run</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Process.run" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロセスが実行する処理を表すメソッドです。</p>
<p>このメソッドはサブクラスでオーバーライドすることができます。標準の <a class="reference internal" href="#multiprocessing.Process.run" title="multiprocessing.Process.run"><tt class="xref py py-meth docutils literal"><span class="pre">run()</span></tt></a> メソッドは呼び出し可能オブジェクトを呼び出します。この呼び出されるオブジェクトはコンストラクタの target 引数として渡されます。もしコンストラクタに <em>args</em> もしくは <em>kwargs</em> 引数が渡されていれば、呼び出すオブジェクトにこれらの引数を渡します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Process.start">
<tt class="descname">start</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Process.start" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロセスの処理を開始するためのメソッドです。</p>
<p>このメソッドをプロセスごとに呼び出す必要があります。各プロセスの <a class="reference internal" href="#multiprocessing.Process.run" title="multiprocessing.Process.run"><tt class="xref py py-meth docutils literal"><span class="pre">run()</span></tt></a> メソッドを呼び出す準備が完了します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Process.join">
<tt class="descname">join</tt><big>(</big><span class="optional">[</span><em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Process.join" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#multiprocessing.Process.join" title="multiprocessing.Process.join"><tt class="xref py py-meth docutils literal"><span class="pre">join()</span></tt></a> されたプロセスが terminate を呼び出すまで、もしくはオプションで指定したタイムアウトが発生するまで呼び出し側のスレッドをブロックします。</p>
<p><em>timeout</em> が <tt class="docutils literal"><span class="pre">None</span></tt> ならタイムアウトは設定されません。</p>
<p>1つのプロセスは何回も join することができます。</p>
<p>プロセスは自分自身を join することはできません。それはデッドロックを引き起こすからです。プロセスが start される前に join しようとするとエラーが発生します。</p>
</dd></dl>

<dl class="attribute">
<dt id="multiprocessing.Process.name">
<tt class="descname">name</tt><a class="headerlink" href="#multiprocessing.Process.name" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロセス名です。</p>
<p>この名前は文字列で、プロセスの識別にのみ使用されます。特別な命名規則はありません。複数のプロセスが同じ名前を持つ場合もあります。また、この名前はコンストラクタにより初期化されます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Process.is_alive">
<tt class="descname">is_alive</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Process.is_alive" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロセスが実行中かを判別します。</p>
<p>おおまかに言って、プロセスオブジェクトは <a class="reference internal" href="#multiprocessing.Process.start" title="multiprocessing.Process.start"><tt class="xref py py-meth docutils literal"><span class="pre">start()</span></tt></a> メソッドを呼び出してから子プロセス終了までの期間が実行中となります。</p>
</dd></dl>

<dl class="attribute">
<dt id="multiprocessing.Process.daemon">
<tt class="descname">daemon</tt><a class="headerlink" href="#multiprocessing.Process.daemon" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>デーモンプロセスであるかどうかのフラグであり、ブール値を設定します。この属性は <a class="reference internal" href="#multiprocessing.Process.start" title="multiprocessing.Process.start"><tt class="xref py py-meth docutils literal"><span class="pre">start()</span></tt></a> が呼び出される前に設定する必要があります。</p>
<p>初期値は作成するプロセスから継承します。</p>
<p>プロセスが終了するとき、その子プロセスのデーモンプロセス全てを終了させようとします。</p>
<p>デーモンプロセスは子プロセスを作成できないことに注意してください。もしそうでなければ、そのデーモンの親プロセスが終了したときに子プロセスが孤児になってしまう場合があるからです。加えて Unix デーモンまたはサービスで <strong>ない</strong> 場合には、非デーモンプロセスが終了したとき、普通のプロセスとして (join されずに)
終了します。</p>
</dd></dl>

<p><tt class="xref py py-class docutils literal"><span class="pre">Threading.Thread</span></tt> クラスのAPIに加えて <a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a> クラスのオブジェクトには以下の属性およびメソッドがあります。</p>
<dl class="attribute">
<dt id="multiprocessing.Process.pid">
<tt class="descname">pid</tt><a class="headerlink" href="#multiprocessing.Process.pid" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロセスIDを返します。プロセスの生成前は <tt class="docutils literal"><span class="pre">None</span></tt> が設定されています。</p>
</dd></dl>

<dl class="attribute">
<dt id="multiprocessing.Process.exitcode">
<tt class="descname">exitcode</tt><a class="headerlink" href="#multiprocessing.Process.exitcode" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>子プロセスの終了コードです。子プロセスがまだ終了していない場合は <tt class="docutils literal"><span class="pre">None</span></tt> が返されます。負の値 <em>-N</em> は子プロセスがシグナル <em>N</em> で終了したことを表します。</p>
</dd></dl>

<dl class="attribute">
<dt id="multiprocessing.Process.authkey">
<tt class="descname">authkey</tt><a class="headerlink" href="#multiprocessing.Process.authkey" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロセスの認証キーです (バイト文字列です)。</p>
<p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> モジュールがメインプロセスにより初期化される場合には、
<tt class="xref py py-func docutils literal"><span class="pre">os.random()</span></tt> 関数を使用してランダムな値が設定されます。</p>
<p><a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a> クラスのオブジェクトの作成時にその親プロセスから認証キーを継承します。もしくは <a class="reference internal" href="#multiprocessing.Process.authkey" title="multiprocessing.Process.authkey"><tt class="xref py py-attr docutils literal"><span class="pre">authkey</span></tt></a> に別のバイト文字列を設定することもできます。</p>
<p>詳細は <a class="reference internal" href="#multiprocessing-auth-keys"><em>認証キー</em></a> を参照してください。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Process.terminate">
<tt class="descname">terminate</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Process.terminate" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロセスを終了します。Unix 環境では <tt class="docutils literal"><span class="pre">SIGTERM</span></tt> シグナルを、
Windows 環境では <tt class="xref c c-func docutils literal"><span class="pre">TerminateProcess()</span></tt> を使用して終了させます。終了ハンドラや finally 節などは、実行されないことに注意してください。</p>
<p>このメソッドにより終了するプロセスの子孫プロセスは、終了 <em>しません</em> 。そういった子孫プロセスは単純に孤児になります。</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">このメソッドの使用時に、関連付けられたプロセスがパイプやキューを使用している場合には、使用中のパイプやキューが破損して他のプロセスから使用できなくなる可能性があります。同様に、プロセスがロックやセマフォなどを取得している場合には、このプロセスが終了してしまうと他のプロセスのデッドロックの原因になるでしょう。</p>
</div>
</dd></dl>

<p>プロセスオブジェクトが作成したプロセスのみが <a class="reference internal" href="#multiprocessing.Process.start" title="multiprocessing.Process.start"><tt class="xref py py-meth docutils literal"><span class="pre">start()</span></tt></a>, <a class="reference internal" href="#multiprocessing.Process.join" title="multiprocessing.Process.join"><tt class="xref py py-meth docutils literal"><span class="pre">join()</span></tt></a>,
<a class="reference internal" href="#multiprocessing.Process.is_alive" title="multiprocessing.Process.is_alive"><tt class="xref py py-meth docutils literal"><span class="pre">is_alive()</span></tt></a> と <tt class="xref py py-attr docutils literal"><span class="pre">exit_code</span></tt> のメソッドを呼び出すべきです。</p>
<p>以下の例では <a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a> のメソッドの使い方を示しています。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">multiprocessing</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">signal</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
<span class="go">&lt;Process(Process-1, initial)&gt; False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
<span class="go">&lt;Process(Process-1, started)&gt; True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
<span class="go">&lt;Process(Process-1, stopped[SIGTERM])&gt; False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">==</span> <span class="o">-</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span>
<span class="go">True</span>
</pre></div>
</div>
</dd></dl>

<dl class="exception">
<dt id="multiprocessing.BufferTooShort">
<em class="property">exception </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">BufferTooShort</tt><a class="headerlink" href="#multiprocessing.BufferTooShort" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>この例外は <a class="reference internal" href="#multiprocessing.Connection.recv_bytes_into" title="multiprocessing.Connection.recv_bytes_into"><tt class="xref py py-meth docutils literal"><span class="pre">Connection.recv_bytes_into()</span></tt></a> によって発生し、バッファオブジェクトが小さすぎてメッセージが読み込めないことを示します。</p>
<p><tt class="docutils literal"><span class="pre">e</span></tt> が <a class="reference internal" href="#multiprocessing.BufferTooShort" title="multiprocessing.BufferTooShort"><tt class="xref py py-exc docutils literal"><span class="pre">BufferTooShort</span></tt></a> のインスタンスとすると、
<tt class="docutils literal"><span class="pre">e.args[0]</span></tt> はバイト文字列でそのメッセージを取得できます。</p>
</dd></dl>

</div>
<div class="section" id="pipe-queue">
<h3>16.6.2.2. パイプ (Pipe) とキュー (Queue)<a class="headerlink" href="#pipe-queue" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>マルチプロセス環境では、一般的にメッセージパッシングをプロセス間通信のために使用し、ロックのような同期プリミティブの使用しないようにします。</p>
<p>メッセージのやりとりのために <a class="reference internal" href="#multiprocessing.Pipe" title="multiprocessing.Pipe"><tt class="xref py py-func docutils literal"><span class="pre">Pipe()</span></tt></a> (2つのプロセス間の通信用)、もしくはキュー (複数プロセスがメッセージを生成、消費する通信用) を使用することができます。</p>
<p><a class="reference internal" href="queue.html#module-Queue" title="Queue: 同期キュークラス"><tt class="xref py py-class docutils literal"><span class="pre">Queue</span></tt></a> と <a class="reference internal" href="#multiprocessing.JoinableQueue" title="multiprocessing.JoinableQueue"><tt class="xref py py-class docutils literal"><span class="pre">JoinableQueue</span></tt></a> は複数プロセスから生成/消費を行う FIFO キューです。これらのキューは標準ライブラリの <a class="reference internal" href="queue.html#Queue.Queue" title="Queue.Queue"><tt class="xref py py-class docutils literal"><span class="pre">Queue.Queue</span></tt></a> を模倣しています。
<a class="reference internal" href="queue.html#module-Queue" title="Queue: 同期キュークラス"><tt class="xref py py-class docutils literal"><span class="pre">Queue</span></tt></a> には Python 2.5 の <a class="reference internal" href="queue.html#Queue.Queue" title="Queue.Queue"><tt class="xref py py-class docutils literal"><span class="pre">Queue.Queue</span></tt></a> クラスで導入された
<a class="reference internal" href="queue.html#Queue.Queue.task_done" title="Queue.Queue.task_done"><tt class="xref py py-meth docutils literal"><span class="pre">task_done()</span></tt></a> と <a class="reference internal" href="queue.html#Queue.Queue.join" title="Queue.Queue.join"><tt class="xref py py-meth docutils literal"><span class="pre">join()</span></tt></a> メソッドがないことが違う点です。</p>
<p>もし <a class="reference internal" href="#multiprocessing.JoinableQueue" title="multiprocessing.JoinableQueue"><tt class="xref py py-class docutils literal"><span class="pre">JoinableQueue</span></tt></a> を使用するなら、キューから削除される各タスクのために
<a class="reference internal" href="#multiprocessing.JoinableQueue.task_done" title="multiprocessing.JoinableQueue.task_done"><tt class="xref py py-meth docutils literal"><span class="pre">JoinableQueue.task_done()</span></tt></a> を呼び出さなければ <strong>なりません</strong> 。もしくは、ある例外を発生させてオーバーフローする可能性がある未終了タスクを数えるためにセマフォが使用されます。</p>
<p>管理オブジェクトを使用することで共有キューを作成できることも覚えておいてください。詳細は <a class="reference internal" href="#multiprocessing-managers"><em>Managers</em></a> を参照してください。</p>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last"><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> は通常の <a class="reference internal" href="queue.html#Queue.Empty" title="Queue.Empty"><tt class="xref py py-exc docutils literal"><span class="pre">Queue.Empty</span></tt></a> と、タイムアウトのシグナルを送るために <a class="reference internal" href="queue.html#Queue.Full" title="Queue.Full"><tt class="xref py py-exc docutils literal"><span class="pre">Queue.Full</span></tt></a> 例外を使用します。それらは <a class="reference internal" href="queue.html#module-Queue" title="Queue: 同期キュークラス"><tt class="xref py py-mod docutils literal"><span class="pre">Queue</span></tt></a> からインポートする必要があるので <a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> の名前空間では利用できません。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last"><a class="reference internal" href="queue.html#module-Queue" title="Queue: 同期キュークラス"><tt class="xref py py-class docutils literal"><span class="pre">Queue</span></tt></a> を利用しようとしている最中にプロセスを
<a class="reference internal" href="#multiprocessing.Process.terminate" title="multiprocessing.Process.terminate"><tt class="xref py py-meth docutils literal"><span class="pre">Process.terminate()</span></tt></a> や <a class="reference internal" href="os.html#os.kill" title="os.kill"><tt class="xref py py-func docutils literal"><span class="pre">os.kill()</span></tt></a> で終了させる場合、キューにあるデータは破損し易くなります。終了した後で他のプロセスがキューを利用しようとすると、例外を発生させる可能性があります。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p>上述したように、もし子プロセスがキューへ要素を追加するなら
(そして <tt class="xref py py-meth docutils literal"><span class="pre">JoinableQueue.cancel_join_thread()</span></tt> を使用しない)
そのプロセスはバッファされた全ての要素がパイプへフラッシュされるまで終了しません。</p>
<p>これは、そのプロセスを join しようとする場合、キューに追加された全ての要素が消費されるのを確認しない限り、デッドロックを発生させる可能性があることを意味します。似たような現象で、子プロセスが非デーモンプロセスの場合、親プロセスは終了時に非デーモンの全ての子プロセスを join しようとしてハングアップする可能性があります。</p>
<p class="last">Manager を使用して作成されたキューではこの問題はありません。詳細は <a class="reference internal" href="#multiprocessing-programming"><em>プログラミングガイドライン</em></a> を参照してください。</p>
</div>
<p>プロセス間通信におけるキューの使用方法は <a class="reference internal" href="#multiprocessing-examples"><em>例</em></a> を参照してください。</p>
<dl class="function">
<dt id="multiprocessing.Pipe">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">Pipe</tt><big>(</big><span class="optional">[</span><em>duplex</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Pipe" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>パイプの終端を表す <a class="reference internal" href="#multiprocessing.Connection" title="multiprocessing.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a> オブジェクトのタプル <tt class="docutils literal"><span class="pre">(conn1,</span> <span class="pre">conn2)</span></tt> を返します。</p>
<p><em>duplex</em> が <tt class="docutils literal"><span class="pre">True</span></tt> (デフォルト) なら、双方向性パイプです。
<em>duplex</em> が <tt class="docutils literal"><span class="pre">False</span></tt> なら、パイプは一方向性です。
<tt class="docutils literal"><span class="pre">conn1</span></tt> はメッセージの受信専用に <tt class="docutils literal"><span class="pre">conn2</span></tt> はメッセージの送信専用として使用されます。</p>
</dd></dl>

<dl class="class">
<dt id="multiprocessing.Queue">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">Queue</tt><big>(</big><span class="optional">[</span><em>maxsize</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Queue" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>パイプや2～3個のロック/セマフォを使用して実装されたプロセス共有キューを返します。あるプロセスが最初に要素をキューへ追加するとき、バッファからパイプの中へオブジェクトを転送する供給スレッドが開始されます。</p>
<p>標準ライブラリの <a class="reference internal" href="queue.html#module-Queue" title="Queue: 同期キュークラス"><tt class="xref py py-mod docutils literal"><span class="pre">Queue</span></tt></a> モジュールからの通常の <a class="reference internal" href="queue.html#Queue.Empty" title="Queue.Empty"><tt class="xref py py-exc docutils literal"><span class="pre">Queue.Empty</span></tt></a> や
<a class="reference internal" href="queue.html#Queue.Full" title="Queue.Full"><tt class="xref py py-exc docutils literal"><span class="pre">Queue.Full</span></tt></a> 例外はタイムアウトのシグナルを送るために発生します。</p>
<p><a class="reference internal" href="queue.html#module-Queue" title="Queue: 同期キュークラス"><tt class="xref py py-class docutils literal"><span class="pre">Queue</span></tt></a> は <a class="reference internal" href="queue.html#Queue.Queue.task_done" title="Queue.Queue.task_done"><tt class="xref py py-meth docutils literal"><span class="pre">task_done()</span></tt></a> や <a class="reference internal" href="queue.html#Queue.Queue.join" title="Queue.Queue.join"><tt class="xref py py-meth docutils literal"><span class="pre">join()</span></tt></a> を除く
<a class="reference internal" href="queue.html#Queue.Queue" title="Queue.Queue"><tt class="xref py py-class docutils literal"><span class="pre">Queue.Queue</span></tt></a> の全てのメソッドを実装します。</p>
<dl class="method">
<dt id="multiprocessing.Queue.qsize">
<tt class="descname">qsize</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Queue.qsize" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>おおよそのキューのサイズを返します。マルチスレッディング/マルチプロセスの特性上、この数値は信用できません。</p>
<p>これは <tt class="docutils literal"><span class="pre">sem_getvalue()</span></tt> が実装されていない Mac OS X のような Unix プラットホーム上で
<a class="reference internal" href="exceptions.html#exceptions.NotImplementedError" title="exceptions.NotImplementedError"><tt class="xref py py-exc docutils literal"><span class="pre">NotImplementedError</span></tt></a> を発生させる可能性があることを覚えておいてください。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Queue.empty">
<tt class="descname">empty</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Queue.empty" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>キューが空っぽなら <tt class="docutils literal"><span class="pre">True</span></tt> を、そうでなければ <tt class="docutils literal"><span class="pre">False</span></tt> を返します。マルチスレッディング/マルチプロセスの特性上、これは信用できません。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Queue.full">
<tt class="descname">full</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Queue.full" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>キューがいっぱいなら <tt class="docutils literal"><span class="pre">True</span></tt> を、そうでなければ <tt class="docutils literal"><span class="pre">False</span></tt> を返します。マルチスレッディング/マルチプロセスの特性上、これは信用できません。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Queue.put">
<tt class="descname">put</tt><big>(</big><em>item</em><span class="optional">[</span>, <em>block</em><span class="optional">[</span>, <em>timeout</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Queue.put" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>キューの中へ要素を追加します。オプションの引数 <em>block</em> が <tt class="docutils literal"><span class="pre">True</span></tt> (デフォルト) 且つ
<em>timeout</em> が <tt class="docutils literal"><span class="pre">None</span></tt> (デフォルト) なら、空きスロットが利用可能になるまで必要であればブロックします。
<em>timeout</em> が正の数なら、最大 <em>timeout</em> 秒ブロックして、その時間内に空きスロットが利用できなかったら <a class="reference internal" href="queue.html#Queue.Full" title="Queue.Full"><tt class="xref py py-exc docutils literal"><span class="pre">Queue.Full</span></tt></a> 例外を発生させます。それ以外 ( <em>block</em> が <tt class="docutils literal"><span class="pre">False</span></tt> ) で、空きスロットがすぐに利用可能な場合はキューに要素を追加します。そうでなければ <a class="reference internal" href="queue.html#Queue.Full" title="Queue.Full"><tt class="xref py py-exc docutils literal"><span class="pre">Queue.Full</span></tt></a> 例外が発生します(その場合 <em>timeout</em> は無視されます)。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Queue.put_nowait">
<tt class="descname">put_nowait</tt><big>(</big><em>item</em><big>)</big><a class="headerlink" href="#multiprocessing.Queue.put_nowait" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><tt class="docutils literal"><span class="pre">put(item,</span> <span class="pre">False)</span></tt> と等価です。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Queue.get">
<tt class="descname">get</tt><big>(</big><span class="optional">[</span><em>block</em><span class="optional">[</span>, <em>timeout</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Queue.get" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>キューから要素を取り出して削除します。オプションの引数 <em>block</em> が <tt class="docutils literal"><span class="pre">True</span></tt> (デフォルト) 且つ
<em>timeout</em> が <tt class="docutils literal"><span class="pre">None</span></tt> (デフォルト) なら、要素が取り出せるまで必要であればブロックします。
<em>timeout</em> が正の数なら、最大 <em>timeout</em> 秒ブロックして、その時間内に要素が取り出せなかったら <a class="reference internal" href="queue.html#Queue.Empty" title="Queue.Empty"><tt class="xref py py-exc docutils literal"><span class="pre">Queue.Empty</span></tt></a> 例外を発生させます。それ以外 ( <em>block</em> が <tt class="docutils literal"><span class="pre">False</span></tt> ) で、要素がすぐに取り出せる場合は要素を返します。そうでなければ <a class="reference internal" href="queue.html#Queue.Empty" title="Queue.Empty"><tt class="xref py py-exc docutils literal"><span class="pre">Queue.Empty</span></tt></a> 例外が発生します(その場合 <em>timeout</em> は無視されます)。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Queue.get_nowait">
<tt class="descname">get_nowait</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Queue.get_nowait" title="この定義へのパーマリンク">¶</a></dt>
<dt id="multiprocessing.Queue.get_no_wait">
<tt class="descname">get_no_wait</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Queue.get_no_wait" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><tt class="docutils literal"><span class="pre">get(False)</span></tt> と等価です。</p>
</dd></dl>

<p><a class="reference internal" href="#multiprocessing.Queue" title="multiprocessing.Queue"><tt class="xref py py-class docutils literal"><span class="pre">multiprocessing.Queue</span></tt></a> は <a class="reference internal" href="queue.html#Queue.Queue" title="Queue.Queue"><tt class="xref py py-class docutils literal"><span class="pre">Queue.Queue</span></tt></a> にはない追加メソッドがあります。これらのメソッドは通常、ほとんどのコードに必要ありません。</p>
<dl class="method">
<dt id="multiprocessing.Queue.close">
<tt class="descname">close</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Queue.close" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>カレントプロセスからこのキューへそれ以上データが追加されないことを表します。バックグラウンドスレッドはパイプへバッファされた全てのデータをフラッシュするとすぐに終了します。これはキューがガベージコレクトされるときに自動的に呼び出されます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Queue.join_thread">
<tt class="descname">join_thread</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Queue.join_thread" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>バックグラウンドスレッドを join します。このメソッドは <a class="reference internal" href="#multiprocessing.Queue.close" title="multiprocessing.Queue.close"><tt class="xref py py-meth docutils literal"><span class="pre">close()</span></tt></a> が呼び出された後でのみ使用されます。バッファされた全てのデータがパイプへフラッシュされるのを保証した上で、バックグラウンドスレッドが終了するまでブロックします。</p>
<p>デフォルトでは、あるプロセスがキューを作成していない場合、終了時にキューのバックグラウンドスレッドを join しようとします。そのプロセスは <a class="reference internal" href="#multiprocessing.Queue.join_thread" title="multiprocessing.Queue.join_thread"><tt class="xref py py-meth docutils literal"><span class="pre">join_thread()</span></tt></a> が何もしないように <a class="reference internal" href="#multiprocessing.Queue.cancel_join_thread" title="multiprocessing.Queue.cancel_join_thread"><tt class="xref py py-meth docutils literal"><span class="pre">cancel_join_thread()</span></tt></a> を呼び出すことができます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Queue.cancel_join_thread">
<tt class="descname">cancel_join_thread</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Queue.cancel_join_thread" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#multiprocessing.Queue.join_thread" title="multiprocessing.Queue.join_thread"><tt class="xref py py-meth docutils literal"><span class="pre">join_thread()</span></tt></a> がブロッキングするのを防ぎます。特にこれはバックグラウンドスレッドがそのプロセスの終了時に自動的に join されるのを防ぎます。詳細は <a class="reference internal" href="#multiprocessing.Queue.join_thread" title="multiprocessing.Queue.join_thread"><tt class="xref py py-meth docutils literal"><span class="pre">join_thread()</span></tt></a> を参照してください。</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="multiprocessing.JoinableQueue">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">JoinableQueue</tt><big>(</big><span class="optional">[</span><em>maxsize</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.JoinableQueue" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#multiprocessing.JoinableQueue" title="multiprocessing.JoinableQueue"><tt class="xref py py-class docutils literal"><span class="pre">JoinableQueue</span></tt></a> は <a class="reference internal" href="queue.html#module-Queue" title="Queue: 同期キュークラス"><tt class="xref py py-class docutils literal"><span class="pre">Queue</span></tt></a> のサブクラスであり、
<a class="reference internal" href="#multiprocessing.JoinableQueue.task_done" title="multiprocessing.JoinableQueue.task_done"><tt class="xref py py-meth docutils literal"><span class="pre">task_done()</span></tt></a> や <a class="reference internal" href="#multiprocessing.JoinableQueue.join" title="multiprocessing.JoinableQueue.join"><tt class="xref py py-meth docutils literal"><span class="pre">join()</span></tt></a> メソッドが追加されているキューです。</p>
<dl class="method">
<dt id="multiprocessing.JoinableQueue.task_done">
<tt class="descname">task_done</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.JoinableQueue.task_done" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>以前にキューへ追加されたタスクが完了したことを表します。キュー消費スレッドによって使用されます。タスクをフェッチするために使用されるそれぞれの <a class="reference internal" href="#multiprocessing.Queue.get" title="multiprocessing.Queue.get"><tt class="xref py py-meth docutils literal"><span class="pre">get()</span></tt></a> では、次に <a class="reference internal" href="#multiprocessing.JoinableQueue.task_done" title="multiprocessing.JoinableQueue.task_done"><tt class="xref py py-meth docutils literal"><span class="pre">task_done()</span></tt></a> を呼び出してタスクの処理が完了したことをキューへ伝えます。</p>
<p>もし <tt class="xref py py-meth docutils literal"><span class="pre">join()</span></tt> がブロッキング状態なら、全ての要素が処理されたときに復帰します( <a class="reference internal" href="#multiprocessing.JoinableQueue.task_done" title="multiprocessing.JoinableQueue.task_done"><tt class="xref py py-meth docutils literal"><span class="pre">task_done()</span></tt></a> 呼び出しが全ての要素からキュー内へ <a class="reference internal" href="#multiprocessing.Queue.put" title="multiprocessing.Queue.put"><tt class="xref py py-meth docutils literal"><span class="pre">put()</span></tt></a> されたと受け取ったことを意味します)。</p>
<p>キューにある要素より多く呼び出された場合 <a class="reference internal" href="exceptions.html#exceptions.ValueError" title="exceptions.ValueError"><tt class="xref py py-exc docutils literal"><span class="pre">ValueError</span></tt></a> が発生します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.JoinableQueue.join">
<tt class="descname">join</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.JoinableQueue.join" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>キューにある全ての要素が取り出されて処理されるまでブロッキングします。</p>
<p>キューに要素が追加されると未終了タスク数が増えます。キューの要素が取り出されて全て処理が完了したことを表す
<a class="reference internal" href="#multiprocessing.JoinableQueue.task_done" title="multiprocessing.JoinableQueue.task_done"><tt class="xref py py-meth docutils literal"><span class="pre">task_done()</span></tt></a> を消費スレッドが呼び出すと数が減ります。未終了タスク数がゼロになると <tt class="xref py py-meth docutils literal"><span class="pre">join()</span></tt> はブロッキングを解除します。</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="miscellaneous">
<h3>16.6.2.3. その他の関数(Miscellaneous)<a class="headerlink" href="#miscellaneous" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="function">
<dt id="multiprocessing.active_children">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">active_children</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.active_children" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>カレントプロセスのアクティブな子プロセスの全てのリストを返します。</p>
<p>これを呼び出すと &#8220;join&#8221; して既に終了しているプロセスには副作用があります。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.cpu_count">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">cpu_count</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.cpu_count" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>システムの CPU 数を返します。もしかしたら <a class="reference internal" href="exceptions.html#exceptions.NotImplementedError" title="exceptions.NotImplementedError"><tt class="xref py py-exc docutils literal"><span class="pre">NotImplementedError</span></tt></a> が発生するかもしれません。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.current_process">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">current_process</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.current_process" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>カレントプロセスに対応する <a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a> オブジェクトを返します。</p>
<p><a class="reference internal" href="threading.html#threading.current_thread" title="threading.current_thread"><tt class="xref py py-func docutils literal"><span class="pre">threading.current_thread()</span></tt></a> とよく似た関数です。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.freeze_support">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">freeze_support</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.freeze_support" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> を使用するプログラムが固まったときにウィンドウを実行状態にすることをサポートします。
( <strong>py2exe</strong> , <strong>PyInstaller</strong> や <strong>cx_Freeze</strong> でテストされています。)</p>
<p>メインモジュールの <tt class="docutils literal"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__'</span></tt> の後でこの関数を連続的に呼び出す必要があります。以下に例を示します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">freeze_support</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&#39;hello world!&#39;</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">freeze_support</span><span class="p">()</span>
    <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>もし <tt class="docutils literal"><span class="pre">freeze_support()</span></tt> の行がない場合、固まった実行状態で実行しようとして <a class="reference internal" href="exceptions.html#exceptions.RuntimeError" title="exceptions.RuntimeError"><tt class="xref py py-exc docutils literal"><span class="pre">RuntimeError</span></tt></a> を発生させます。</p>
<p>そのモジュールが Python インタプリタによって普通に実行されるなら
<a class="reference internal" href="#multiprocessing.freeze_support" title="multiprocessing.freeze_support"><tt class="xref py py-func docutils literal"><span class="pre">freeze_support()</span></tt></a> は何の影響もありません。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.set_executable">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">set_executable</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.set_executable" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>子プロセスを開始するときに使用する Python インタプリタのパスを設定します。
(デフォルトでは <a class="reference internal" href="sys.html#sys.executable" title="sys.executable"><tt class="xref py py-data docutils literal"><span class="pre">sys.executable</span></tt></a> が使用されます)。コードに組み込むときは、おそらく次のようにする必要があります。</p>
<div class="highlight-python"><pre>  setExecutable(os.path.join(sys.exec_prefix, 'pythonw.exe'))

子プロセスを生成する前に行います。 (Windows 専用)</pre>
</div>
</dd></dl>

<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last"><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> には
<a class="reference internal" href="threading.html#threading.active_count" title="threading.active_count"><tt class="xref py py-func docutils literal"><span class="pre">threading.active_count()</span></tt></a>, <a class="reference internal" href="threading.html#threading.enumerate" title="threading.enumerate"><tt class="xref py py-func docutils literal"><span class="pre">threading.enumerate()</span></tt></a>,
<a class="reference internal" href="threading.html#threading.settrace" title="threading.settrace"><tt class="xref py py-func docutils literal"><span class="pre">threading.settrace()</span></tt></a>, <a class="reference internal" href="threading.html#threading.setprofile" title="threading.setprofile"><tt class="xref py py-func docutils literal"><span class="pre">threading.setprofile()</span></tt></a>,
<a class="reference internal" href="threading.html#threading.Timer" title="threading.Timer"><tt class="xref py py-class docutils literal"><span class="pre">threading.Timer</span></tt></a> や <a class="reference internal" href="threading.html#threading.local" title="threading.local"><tt class="xref py py-class docutils literal"><span class="pre">threading.local</span></tt></a> のような関数はありません。</p>
</div>
</div>
<div class="section" id="connection">
<h3>16.6.2.4. Connection オブジェクト<a class="headerlink" href="#connection" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Connection オブジェクトは pickle でシリアライズ可能なオブジェクトか文字列を送ったり、受け取ったりします。そういったオブジェクトはメッセージ指向の接続ソケットと考えられます。</p>
<p>Connection オブジェクトは通常は <a class="reference internal" href="#multiprocessing.Pipe" title="multiprocessing.Pipe"><tt class="xref py py-func docutils literal"><span class="pre">Pipe()</span></tt></a> を使用して作成されます。詳細は <a class="reference internal" href="#multiprocessing-listeners-clients"><em>Listeners and Clients</em></a> も参照してください。</p>
<dl class="class">
<dt id="multiprocessing.Connection">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">Connection</tt><a class="headerlink" href="#multiprocessing.Connection" title="この定義へのパーマリンク">¶</a></dt>
<dd><dl class="method">
<dt id="multiprocessing.Connection.send">
<tt class="descname">send</tt><big>(</big><em>obj</em><big>)</big><a class="headerlink" href="#multiprocessing.Connection.send" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>コネクションの向こう側へ <a class="reference internal" href="#multiprocessing.Connection.recv" title="multiprocessing.Connection.recv"><tt class="xref py py-meth docutils literal"><span class="pre">recv()</span></tt></a> を使用して読み込むオブジェクトを送ります。</p>
<p>オブジェクトは pickle でシリアライズ可能でなければなりません。
pickle が極端に大きすぎる (OS にも依りますが、およそ 32 MB+) と、
ValueError 例外が送出されることがあります。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Connection.recv">
<tt class="descname">recv</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Connection.recv" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>コネクションの向こう側から <a class="reference internal" href="#multiprocessing.Connection.send" title="multiprocessing.Connection.send"><tt class="xref py py-meth docutils literal"><span class="pre">send()</span></tt></a> を使用して送られたオブジェクトを返します。何も受け取らずにコネクションの向こう側でクローズされた場合 <a class="reference internal" href="exceptions.html#exceptions.EOFError" title="exceptions.EOFError"><tt class="xref py py-exc docutils literal"><span class="pre">EOFError</span></tt></a> が発生します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Connection.fileno">
<tt class="descname">fileno</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Connection.fileno" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>コネクションが使用するハンドラか、ファイルディスクリプタを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Connection.close">
<tt class="descname">close</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.Connection.close" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>コネクションをクローズします。</p>
<p>コネクションがガベージコレクトされるときに自動的に呼び出されます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Connection.poll">
<tt class="descname">poll</tt><big>(</big><span class="optional">[</span><em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Connection.poll" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>読み込み可能なデータがあるかどうかを返します。</p>
<p><em>timeout</em> が指定されていなければすぐに返します。
<em>timeout</em> に数値を指定すると、最大指定した秒数をブロッキングします。
<em>timeout</em> に <tt class="docutils literal"><span class="pre">None</span></tt> を指定するとタイムアウトせずにずっとブロッキングします。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Connection.send_bytes">
<tt class="descname">send_bytes</tt><big>(</big><em>buffer</em><span class="optional">[</span>, <em>offset</em><span class="optional">[</span>, <em>size</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Connection.send_bytes" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>バッファインタフェースをサポートするオブジェクトから完全なメッセージとしてバイトデータを送ります。</p>
<p><em>offset</em> が指定されると <em>buffer</em> のその位置からデータが読み込まれます。
<em>size</em> が指定されると大量データがバッファから読み込まれます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Connection.recv_bytes">
<tt class="descname">recv_bytes</tt><big>(</big><span class="optional">[</span><em>maxlength</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Connection.recv_bytes" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>文字列のようにコネクションの向こう側から送られたバイトデータの完全なメッセージを返します。何も受け取らずにコネクションの向こう側でクローズされた場合 <a class="reference internal" href="exceptions.html#exceptions.EOFError" title="exceptions.EOFError"><tt class="xref py py-exc docutils literal"><span class="pre">EOFError</span></tt></a> が発生します。</p>
<p><em>maxlength</em> を指定して、且つ <em>maxlength</em> よりメッセージが長い場合、
<a class="reference internal" href="exceptions.html#exceptions.IOError" title="exceptions.IOError"><tt class="xref py py-exc docutils literal"><span class="pre">IOError</span></tt></a> を発生させて、それ以上はコネクションから読み込めなくなります。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.Connection.recv_bytes_into">
<tt class="descname">recv_bytes_into</tt><big>(</big><em>buffer</em><span class="optional">[</span>, <em>offset</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Connection.recv_bytes_into" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>コネクションの向こう側から送られたバイトデータを <em>buffer</em> に読み込み、メッセージのバイト数を返します。何も受け取らずにコネクションの向こう側でクローズされた場合 <a class="reference internal" href="exceptions.html#exceptions.EOFError" title="exceptions.EOFError"><tt class="xref py py-exc docutils literal"><span class="pre">EOFError</span></tt></a> が発生します。</p>
<p><em>buffer</em> は書き込み可能なバッファインタフェースを備えたオブジェクトでなければなりません。
<em>offset</em> が与えられたら、その位置からバッファへメッセージが書き込まれます。オフセットは <em>buffer</em> バイトよりも小さい正の数でなければなりません。</p>
<p>バッファがあまりに小さいと <a class="reference internal" href="#multiprocessing.BufferTooShort" title="multiprocessing.BufferTooShort"><tt class="xref py py-exc docutils literal"><span class="pre">BufferTooShort</span></tt></a> 例外が発生します。
<tt class="docutils literal"><span class="pre">e</span></tt> が例外インスタンスとすると完全なメッセージは <tt class="docutils literal"><span class="pre">e.args[0]</span></tt> で確認できます。</p>
</dd></dl>

</dd></dl>

<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pipe</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Pipe</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<span class="go">[1, &#39;hello&#39;, None]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">send_bytes</span><span class="p">(</span><span class="s">&#39;thank you&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">recv_bytes</span><span class="p">()</span>
<span class="go">&#39;thank you&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">array</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">arr1</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">arr2</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">send_bytes</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">count</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">recv_bytes_into</span><span class="p">(</span><span class="n">arr2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr1</span><span class="p">)</span> <span class="o">*</span> <span class="n">arr1</span><span class="o">.</span><span class="n">itemsize</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">arr2</span>
<span class="go">array(&#39;i&#39;, [0, 1, 2, 3, 4, 0, 0, 0, 0, 0])</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p><a class="reference internal" href="#multiprocessing.Connection.recv" title="multiprocessing.Connection.recv"><tt class="xref py py-meth docutils literal"><span class="pre">Connection.recv()</span></tt></a> メソッドは受信したデータを自動的に unpickle 化します。それはメッセージを送ったプロセスが信頼できる場合を除いてセキュリティリスクになります。</p>
<p class="last">そのため <a class="reference internal" href="#multiprocessing.Pipe" title="multiprocessing.Pipe"><tt class="xref py py-func docutils literal"><span class="pre">Pipe()</span></tt></a> を使用してコネクションオブジェクトを生成する場合を除いて、何らかの認証処理を実行した後で <a class="reference internal" href="#multiprocessing.Connection.recv" title="multiprocessing.Connection.recv"><tt class="xref py py-meth docutils literal"><span class="pre">recv()</span></tt></a> や
<a class="reference internal" href="#multiprocessing.Connection.send" title="multiprocessing.Connection.send"><tt class="xref py py-meth docutils literal"><span class="pre">send()</span></tt></a> メソッドのみを使用すべきです。詳細は <a class="reference internal" href="#multiprocessing-auth-keys"><em>認証キー</em></a> を参照してください。</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">もしプロセスがパイプの読み込み又は書き込み中に kill されると、メッセージの境界が正しいかどうか分からないので、そのパイプのデータは破壊されたようになります。</p>
</div>
</div>
<div class="section" id="id8">
<h3>16.6.2.5. 同期プリミティブ<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>一般的に同期プリミティブはマルチスレッドプログラムのようにマルチプロセスプログラムでは必要ありません。詳細は <a class="reference internal" href="threading.html#module-threading" title="threading: 高水準のスレッドインタフェース"><tt class="xref py py-mod docutils literal"><span class="pre">threading</span></tt></a> モジュールのドキュメントを参照してください。</p>
<p>マネージャオブジェクトを使用して同期プリミティブを作成できることも覚えておいてください。詳細は <a class="reference internal" href="#multiprocessing-managers"><em>Managers</em></a> を参照してください。</p>
<dl class="class">
<dt id="multiprocessing.BoundedSemaphore">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">BoundedSemaphore</tt><big>(</big><span class="optional">[</span><em>value</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.BoundedSemaphore" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>束縛されたセマフォオブジェクト: <a class="reference internal" href="threading.html#threading.BoundedSemaphore" title="threading.BoundedSemaphore"><tt class="xref py py-class docutils literal"><span class="pre">threading.BoundedSemaphore</span></tt></a> のクローンです。</p>
<p>(Mac OS X では <tt class="docutils literal"><span class="pre">sem_getvalue()</span></tt> が実装されていないので <a class="reference internal" href="#multiprocessing.Semaphore" title="multiprocessing.Semaphore"><tt class="xref py py-class docutils literal"><span class="pre">Semaphore</span></tt></a> と区別がつきません。)</p>
</dd></dl>

<dl class="class">
<dt id="multiprocessing.Condition">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">Condition</tt><big>(</big><span class="optional">[</span><em>lock</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Condition" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>状態変数: <a class="reference internal" href="threading.html#threading.Condition" title="threading.Condition"><tt class="xref py py-class docutils literal"><span class="pre">threading.Condition</span></tt></a> のクローンです。</p>
<p><em>lock</em> を指定するなら <a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> の <a class="reference internal" href="#multiprocessing.Lock" title="multiprocessing.Lock"><tt class="xref py py-class docutils literal"><span class="pre">Lock</span></tt></a> か <a class="reference internal" href="#multiprocessing.RLock" title="multiprocessing.RLock"><tt class="xref py py-class docutils literal"><span class="pre">RLock</span></tt></a> オブジェクトにすべきです。</p>
</dd></dl>

<dl class="class">
<dt id="multiprocessing.Event">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">Event</tt><a class="headerlink" href="#multiprocessing.Event" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="threading.html#threading.Event" title="threading.Event"><tt class="xref py py-class docutils literal"><span class="pre">threading.Event</span></tt></a> のクローンです。このメソッドは、終了時の内部セマフォの状態を返すので、タイムアウトが与えられ、実際にオペレーションがタイムアウトしたのでなければ、必ず <tt class="docutils literal"><span class="pre">True</span></tt> を返します。</p>
<p class="versionchanged">
<span class="versionmodified">バージョン 2.7 で変更: </span>以前は、このメソッドは必ず <tt class="docutils literal"><span class="pre">None</span></tt> を返していました。</p>
</dd></dl>

<dl class="class">
<dt id="multiprocessing.Lock">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">Lock</tt><a class="headerlink" href="#multiprocessing.Lock" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>非再帰的なロックオブジェクト: <a class="reference internal" href="threading.html#threading.Lock" title="threading.Lock"><tt class="xref py py-class docutils literal"><span class="pre">threading.Lock</span></tt></a> のクローンです。</p>
</dd></dl>

<dl class="class">
<dt id="multiprocessing.RLock">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">RLock</tt><a class="headerlink" href="#multiprocessing.RLock" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>再帰的なロックオブジェクト: <a class="reference internal" href="threading.html#threading.RLock" title="threading.RLock"><tt class="xref py py-class docutils literal"><span class="pre">threading.RLock</span></tt></a> のクローンです。</p>
</dd></dl>

<dl class="class">
<dt id="multiprocessing.Semaphore">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">Semaphore</tt><big>(</big><span class="optional">[</span><em>value</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Semaphore" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>セマフォオブジェクト: <a class="reference internal" href="threading.html#threading.Semaphore" title="threading.Semaphore"><tt class="xref py py-class docutils literal"><span class="pre">threading.Semaphore</span></tt></a> のクローンです。</p>
</dd></dl>

<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p><a class="reference internal" href="#multiprocessing.BoundedSemaphore" title="multiprocessing.BoundedSemaphore"><tt class="xref py py-class docutils literal"><span class="pre">BoundedSemaphore</span></tt></a>, <a class="reference internal" href="#multiprocessing.Lock" title="multiprocessing.Lock"><tt class="xref py py-class docutils literal"><span class="pre">Lock</span></tt></a>, <a class="reference internal" href="#multiprocessing.RLock" title="multiprocessing.RLock"><tt class="xref py py-class docutils literal"><span class="pre">RLock</span></tt></a> と <a class="reference internal" href="#multiprocessing.Semaphore" title="multiprocessing.Semaphore"><tt class="xref py py-class docutils literal"><span class="pre">Semaphore</span></tt></a>
の <tt class="xref py py-meth docutils literal"><span class="pre">acquire()</span></tt> メソッドは <a class="reference internal" href="threading.html#module-threading" title="threading: 高水準のスレッドインタフェース"><tt class="xref py py-mod docutils literal"><span class="pre">threading</span></tt></a> ではサポートされていないタイムアウトパラメータを取ります。その引数はキーワード引数で受け取れる
<tt class="docutils literal"><span class="pre">acquire(block=True,</span> <span class="pre">timeout=None)</span></tt> です。
<em>block</em> が <tt class="docutils literal"><span class="pre">True</span></tt> 且つ <em>timeout</em> が <tt class="docutils literal"><span class="pre">None</span></tt> ではないなら、タイムアウトが秒単位で設定されます。
<em>block</em> が <tt class="docutils literal"><span class="pre">False</span></tt> なら <em>timeout</em> は無視されます。</p>
<p class="last">Mac OS X では <tt class="docutils literal"><span class="pre">sem_timedwait</span></tt> がサポートされていないので、
<tt class="docutils literal"><span class="pre">acquire()</span></tt> タイムアウトを与えて呼ぶと、擬似的なスリーピングループ関数を実行することになります。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p>メインスレッドが <tt class="xref py py-meth docutils literal"><span class="pre">BoundedSemaphore.acquire()</span></tt>, <tt class="xref py py-meth docutils literal"><span class="pre">Lock.acquire()</span></tt>,
<tt class="xref py py-meth docutils literal"><span class="pre">RLock.acquire()</span></tt>, <tt class="xref py py-meth docutils literal"><span class="pre">Semaphore.acquire()</span></tt>, <tt class="xref py py-meth docutils literal"><span class="pre">Condition.acquire()</span></tt>
又は <tt class="xref py py-meth docutils literal"><span class="pre">Condition.wait()</span></tt> を呼び出してブロッキング状態のときに Ctrl-C で生成される SIGINT シグナルを受け取ると、その呼び出しはすぐに中断されて
<a class="reference internal" href="exceptions.html#exceptions.KeyboardInterrupt" title="exceptions.KeyboardInterrupt"><tt class="xref py py-exc docutils literal"><span class="pre">KeyboardInterrupt</span></tt></a> が発生します。</p>
<p class="last">これは同等のブロッキング呼び出しが実行中のときに SIGINT が無視される
<a class="reference internal" href="threading.html#module-threading" title="threading: 高水準のスレッドインタフェース"><tt class="xref py py-mod docutils literal"><span class="pre">threading</span></tt></a> の振る舞いとは違っています。</p>
</div>
</div>
<div class="section" id="ctypes">
<h3>16.6.2.6. 共有 <a class="reference internal" href="ctypes.html#module-ctypes" title="ctypes: A foreign function library for Python."><tt class="xref py py-mod docutils literal"><span class="pre">ctypes</span></tt></a> オブジェクト<a class="headerlink" href="#ctypes" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>子プロセスにより継承される共有メモリを使用する共有オブジェクトを作成することができます。</p>
<dl class="function">
<dt id="multiprocessing.Value">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">Value</tt><big>(</big><em>typecode_or_type</em>, <em>*args</em><span class="optional">[</span>, <em>lock</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.Value" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有メモリから割り当てられた <a class="reference internal" href="ctypes.html#module-ctypes" title="ctypes: A foreign function library for Python."><tt class="xref py py-mod docutils literal"><span class="pre">ctypes</span></tt></a> オブジェクトを返します。デフォルトでは、返り値は実際のオブジェクトの同期ラッパーです。</p>
<p><em>typecode_or_type</em> は返されるオブジェクトの型を決めます。それは ctypes の型か <a class="reference internal" href="array.html#module-array" title="array: 一様な型を持つ数値からなる空間効率のよいアレイ。"><tt class="xref py py-mod docutils literal"><span class="pre">array</span></tt></a> モジュールで使用されるような1文字の型コードかのどちらか一方です。
<em>*args</em> は型のコンストラクタへ渡されます。</p>
<p><em>lock</em> が <tt class="docutils literal"><span class="pre">True</span></tt> (デフォルト) なら、値へ同期アクセスするために新たなロックオブジェクトが作成されます。 <em>lock</em> が <a class="reference internal" href="#multiprocessing.Lock" title="multiprocessing.Lock"><tt class="xref py py-class docutils literal"><span class="pre">Lock</span></tt></a> か <a class="reference internal" href="#multiprocessing.RLock" title="multiprocessing.RLock"><tt class="xref py py-class docutils literal"><span class="pre">RLock</span></tt></a>
なら値への同期アクセスに使用されます。 <em>lock</em> が <tt class="docutils literal"><span class="pre">False</span></tt> なら、返されたオブジェクトへのアクセスはロックにより自動的に保護されません。そのため、必ずしも &#8220;プロセスセーフ&#8221; ではありません。</p>
<p><em>lock</em> はキーワード引数でのみ指定することに注意してください。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.Array">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">Array</tt><big>(</big><em>typecode_or_type</em>, <em>size_or_initializer</em>, <em>*</em>, <em>lock=True</em><big>)</big><a class="headerlink" href="#multiprocessing.Array" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有メモリから割り当てられた ctypes 配列を返します。デフォルトでは、返り値は実際の配列の同期ラッパーです。</p>
<p><em>typecode_or_type</em> は返される配列の要素の型を決めます。それは ctypes の型か <a class="reference internal" href="array.html#module-array" title="array: 一様な型を持つ数値からなる空間効率のよいアレイ。"><tt class="xref py py-mod docutils literal"><span class="pre">array</span></tt></a> モジュールで使用されるような1文字の型コードかのどちらか一方です。
<em>size_or_initializer</em> が整数なら、配列の長さを決定し、その配列はゼロで初期化されます。別の使用方法として <em>size_or_initializer</em> は配列の初期化に使用されるシーケンスになり、そのシーケンス長が配列の長さを決定します。</p>
<p><em>lock</em> が <tt class="docutils literal"><span class="pre">True</span></tt> (デフォルト) なら、値へ同期アクセスするために新たなロックオブジェクトが作成されます。 <em>lock</em> が <a class="reference internal" href="#multiprocessing.Lock" title="multiprocessing.Lock"><tt class="xref py py-class docutils literal"><span class="pre">Lock</span></tt></a> か <a class="reference internal" href="#multiprocessing.RLock" title="multiprocessing.RLock"><tt class="xref py py-class docutils literal"><span class="pre">RLock</span></tt></a>
なら値への同期アクセスに使用されます。 <em>lock</em> が <tt class="docutils literal"><span class="pre">False</span></tt> なら、返されたオブジェクトへのアクセスはロックにより自動的に保護されません。そのため、必ずしも &#8220;プロセスセーフ&#8221; ではありません。</p>
<p><em>lock</em> はキーワード引数でのみ指定することに注意してください。</p>
<p><a class="reference internal" href="ctypes.html#ctypes.c_char" title="ctypes.c_char"><tt class="xref py py-data docutils literal"><span class="pre">ctypes.c_char</span></tt></a> の配列は文字列を格納して取り出せる
<em>value</em> と <em>raw</em> 属性を持っていることを覚えておいてください。</p>
</dd></dl>

<div class="section" id="multiprocessing-sharedctypes">
<h4>16.6.2.6.1. <a class="reference internal" href="#module-multiprocessing.sharedctypes" title="multiprocessing.sharedctypes: 共有メモリから ctypes オブジェクトを割り当てる"><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing.sharedctypes</span></tt></a> モジュール<a class="headerlink" href="#multiprocessing-sharedctypes" title="このヘッドラインへのパーマリンク">¶</a></h4>
<span class="target" id="module-multiprocessing.sharedctypes"></span><p><a class="reference internal" href="#module-multiprocessing.sharedctypes" title="multiprocessing.sharedctypes: 共有メモリから ctypes オブジェクトを割り当てる"><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing.sharedctypes</span></tt></a> モジュールは子プロセスに継承される共有メモリの
<a class="reference internal" href="ctypes.html#module-ctypes" title="ctypes: A foreign function library for Python."><tt class="xref py py-mod docutils literal"><span class="pre">ctypes</span></tt></a> オブジェクトを割り当てる関数を提供します。</p>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last">共有メモリのポインタを格納することは可能ではありますが、特定プロセスのアドレス空間の位置を参照するということを覚えておいてください。しかし、そのポインタは別のプロセスのコンテキストにおいて無効になる確率が高いです。そして、別のプロセスからそのポインタを逆参照しようとするとクラッシュを引き起こす可能性があります。</p>
</div>
<dl class="function">
<dt id="multiprocessing.sharedctypes.RawArray">
<tt class="descclassname">multiprocessing.sharedctypes.</tt><tt class="descname">RawArray</tt><big>(</big><em>typecode_or_type</em>, <em>size_or_initializer</em><big>)</big><a class="headerlink" href="#multiprocessing.sharedctypes.RawArray" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有メモリから割り当てられた ctypes 配列を返します。</p>
<p><em>typecode_or_type</em> は返される配列の要素の型を決めます。それは ctypes の型か <a class="reference internal" href="array.html#module-array" title="array: 一様な型を持つ数値からなる空間効率のよいアレイ。"><tt class="xref py py-mod docutils literal"><span class="pre">array</span></tt></a> モジュールで使用されるような1文字の型コードかのどちらか一方です。
<em>size_or_initializer</em> が整数なら、配列の長さを決定し、その配列はゼロで初期化されます。別の使用方法として <em>size_or_initializer</em> は配列の初期化に使用されるシーケンスになり、そのシーケンス長が配列の長さを決定します。</p>
<p>要素を取得したり設定したりすることは潜在的に非アトミックであることに注意してください。ロックを使用して自動的に同期されたアクセスを保証するには <a class="reference internal" href="#multiprocessing.sharedctypes.Array" title="multiprocessing.sharedctypes.Array"><tt class="xref py py-func docutils literal"><span class="pre">Array()</span></tt></a> を使用してください。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.sharedctypes.RawValue">
<tt class="descclassname">multiprocessing.sharedctypes.</tt><tt class="descname">RawValue</tt><big>(</big><em>typecode_or_type</em>, <em>*args</em><big>)</big><a class="headerlink" href="#multiprocessing.sharedctypes.RawValue" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有メモリから割り当てられた ctypes オブジェクトを返します。</p>
<p><em>typecode_or_type</em> は返される型を決めます。それは ctypes の型か <a class="reference internal" href="array.html#module-array" title="array: 一様な型を持つ数値からなる空間効率のよいアレイ。"><tt class="xref py py-mod docutils literal"><span class="pre">array</span></tt></a> モジュールで使用されるような1文字の型コードかのどちらか一方です。
<em>*args</em> は型のコンストラクタへ渡されます。</p>
<p>値を取得したり設定したりすることは潜在的に非アトミックであることに注意してください。ロックを使用して自動的に同期されたアクセスを保証するには <a class="reference internal" href="#multiprocessing.sharedctypes.Value" title="multiprocessing.sharedctypes.Value"><tt class="xref py py-func docutils literal"><span class="pre">Value()</span></tt></a> を使用してください。</p>
<p><a class="reference internal" href="ctypes.html#ctypes.c_char" title="ctypes.c_char"><tt class="xref py py-data docutils literal"><span class="pre">ctypes.c_char</span></tt></a> の配列は文字列を格納して取り出せる
<em>value</em> と <em>raw</em> 属性を持っていることを覚えておいてください。詳細は <a class="reference internal" href="ctypes.html#module-ctypes" title="ctypes: A foreign function library for Python."><tt class="xref py py-mod docutils literal"><span class="pre">ctypes</span></tt></a> を参照してください。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.sharedctypes.Array">
<tt class="descclassname">multiprocessing.sharedctypes.</tt><tt class="descname">Array</tt><big>(</big><em>typecode_or_type</em>, <em>size_or_initializer</em>, <em>*args</em><span class="optional">[</span>, <em>lock</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.sharedctypes.Array" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><em>lock</em> の値に依存する点を除けば <a class="reference internal" href="#multiprocessing.sharedctypes.RawArray" title="multiprocessing.sharedctypes.RawArray"><tt class="xref py py-func docutils literal"><span class="pre">RawArray()</span></tt></a> と同様です。プロセスセーフな同期ラッパーが raw ctypes 配列の代わりに返されるでしょう。</p>
<p><em>lock</em> が <tt class="docutils literal"><span class="pre">True</span></tt> (デフォルト) なら、値へ同期アクセスするために新たなロックオブジェクトが作成されます。 <em>lock</em> が <tt class="xref py py-class docutils literal"><span class="pre">Lock</span></tt> か <tt class="xref py py-class docutils literal"><span class="pre">RLock</span></tt>
なら値への同期アクセスに使用されます。 <em>lock</em> が <tt class="docutils literal"><span class="pre">False</span></tt> なら、返されたオブジェクトへのアクセスはロックにより自動的に保護されません。そのため、必ずしも &#8220;プロセスセーフ&#8221; ではありません。</p>
<p><em>lock</em> はキーワード引数でのみ指定することに注意してください。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.sharedctypes.Value">
<tt class="descclassname">multiprocessing.sharedctypes.</tt><tt class="descname">Value</tt><big>(</big><em>typecode_or_type</em>, <em>*args</em><span class="optional">[</span>, <em>lock</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.sharedctypes.Value" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><em>lock</em> の値に依存する点を除けば <a class="reference internal" href="#multiprocessing.sharedctypes.RawValue" title="multiprocessing.sharedctypes.RawValue"><tt class="xref py py-func docutils literal"><span class="pre">RawValue()</span></tt></a> と同様です。プロセスセーフな同期ラッパーが ctypes オブジェクトの代わりに返されるでしょう。</p>
<p><em>lock</em> が <tt class="docutils literal"><span class="pre">True</span></tt> (デフォルト) なら、値へ同期アクセスするために新たなロックオブジェクトが作成されます。 <em>lock</em> が <tt class="xref py py-class docutils literal"><span class="pre">Lock</span></tt> か <tt class="xref py py-class docutils literal"><span class="pre">RLock</span></tt>
なら値への同期アクセスに使用されます。 <em>lock</em> が <tt class="docutils literal"><span class="pre">False</span></tt> なら、返されたオブジェクトへのアクセスはロックにより自動的に保護されません。そのため、必ずしも &#8220;プロセスセーフ&#8221; ではありません。</p>
<p><em>lock</em> はキーワード引数でのみ指定することに注意してください。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.sharedctypes.copy">
<tt class="descclassname">multiprocessing.sharedctypes.</tt><tt class="descname">copy</tt><big>(</big><em>obj</em><big>)</big><a class="headerlink" href="#multiprocessing.sharedctypes.copy" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有メモリから割り当てられた ctypes オブジェクト <em>obj</em> をコピーしたオブジェクトを返します。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.sharedctypes.synchronized">
<tt class="descclassname">multiprocessing.sharedctypes.</tt><tt class="descname">synchronized</tt><big>(</big><em>obj</em><span class="optional">[</span>, <em>lock</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.sharedctypes.synchronized" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>同期アクセスに <em>lock</em> を使用する ctypes オブジェクトのためにプロセスセーフなラッパーオブジェクトを返します。 <em>lock</em> が <tt class="docutils literal"><span class="pre">None</span></tt> (デフォルト) なら、
<a class="reference internal" href="#multiprocessing.RLock" title="multiprocessing.RLock"><tt class="xref py py-class docutils literal"><span class="pre">multiprocessing.RLock</span></tt></a> オブジェクトが自動的に作成されます。</p>
<p>同期ラッパーがラップするオブジェクトに加えて2つのメソッドがあります。
<tt class="xref py py-meth docutils literal"><span class="pre">get_obj()</span></tt> はラップされたオブジェクトを返します。
<tt class="xref py py-meth docutils literal"><span class="pre">get_lock()</span></tt> は同期のために使用されるロックオブジェクトを返します。</p>
<p>ラッパー経由で ctypes オブジェクトにアクセスすることは
raw ctypes オブジェクトへアクセスするよりずっと遅くなることに注意してください。</p>
</dd></dl>

<p>次の表は通常の ctypes 構文で共有メモリから共有 ctypes オブジェクトを作成するための構文を比較します。
( <tt class="docutils literal"><span class="pre">MyStruct</span></tt> テーブル内には <a class="reference internal" href="ctypes.html#ctypes.Structure" title="ctypes.Structure"><tt class="xref py py-class docutils literal"><span class="pre">ctypes.Structure</span></tt></a> のサブクラスがあります。)</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="35%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ctypes</th>
<th class="head">type を使用する sharedctypes</th>
<th class="head">typecode を使用する sharedctypes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>c_double(2.4)</td>
<td>RawValue(c_double, 2.4)</td>
<td>RawValue(&#8216;d&#8217;, 2.4)</td>
</tr>
<tr class="row-odd"><td>MyStruct(4, 6)</td>
<td>RawValue(MyStruct, 4, 6)</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>(c_short * 7)()</td>
<td>RawArray(c_short, 7)</td>
<td>RawArray(&#8216;h&#8217;, 7)</td>
</tr>
<tr class="row-odd"><td>(c_int * 3)(9, 2, 8)</td>
<td>RawArray(c_int, (9, 2, 8))</td>
<td>RawArray(&#8216;i&#8217;, (9, 2, 8))</td>
</tr>
</tbody>
</table>
<p>以下に子プロセスが多くの ctypes オブジェクトを変更する例を紹介します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Lock</span>
<span class="kn">from</span> <span class="nn">multiprocessing.sharedctypes</span> <span class="kn">import</span> <span class="n">Value</span><span class="p">,</span> <span class="n">Array</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">c_double</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">c_double</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">c_double</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">modify</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="n">n</span><span class="o">.</span><span class="n">value</span> <span class="o">**=</span> <span class="mi">2</span>
    <span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">**=</span> <span class="mi">2</span>
    <span class="n">s</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">x</span> <span class="o">**=</span> <span class="mi">2</span>
        <span class="n">a</span><span class="o">.</span><span class="n">y</span> <span class="o">**=</span> <span class="mi">2</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="n">c_double</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;hello world&#39;</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Point</span><span class="p">,</span> <span class="p">[(</span><span class="mf">1.875</span><span class="p">,</span><span class="o">-</span><span class="mf">6.25</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.75</span><span class="p">,</span><span class="mf">2.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">2.375</span><span class="p">,</span><span class="mf">9.5</span><span class="p">)],</span> <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">modify</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">print</span> <span class="n">n</span><span class="o">.</span><span class="n">value</span>
    <span class="k">print</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span>
    <span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">value</span>
    <span class="k">print</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
</pre></div>
</div>
<p>結果は以下のように表示されます。</p>
<div class="highlight-none"><div class="highlight"><pre>49
0.1111111111111111
HELLO WORLD
[(3.515625, 39.0625), (33.0625, 4.0), (5.640625, 90.25)]
</pre></div>
</div>
</div>
</div>
<div class="section" id="managers">
<span id="multiprocessing-managers"></span><h3>16.6.2.7. Managers<a class="headerlink" href="#managers" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Manager は別のプロセス間で共有されるデータの作成方法を提供します。マネージャオブジェクトは <em>共有オブジェクト</em> を管理するサーバプロセスを制御します。他のプロセスはプロキシ経由で共有オブジェクトへアクセスすることができます。</p>
<dl class="function">
<dt id="multiprocessing.sharedctypes.multiprocessing.Manager">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">Manager</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.sharedctypes.multiprocessing.Manager" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロセス間で共有オブジェクトのために使用される
<a class="reference internal" href="#multiprocessing.managers.SyncManager" title="multiprocessing.managers.SyncManager"><tt class="xref py py-class docutils literal"><span class="pre">SyncManager</span></tt></a> オブジェクトを返します。返されたマネージャオブジェクトは生成される子プロセスに対応して、共有オブジェクトを作成するメソッドを持ち、応答プロキシを返します。</p>
</dd></dl>

<span class="target" id="module-multiprocessing.managers"></span><p>マネージャプロセスは親プロセスが終了するか、ガベージコレクトされると停止します。マネージャクラスは <a class="reference internal" href="#module-multiprocessing.managers" title="multiprocessing.managers: Share data between process with shared objects."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing.managers</span></tt></a> モジュールで定義されています。</p>
<dl class="class">
<dt id="multiprocessing.managers.BaseManager">
<em class="property">class </em><tt class="descclassname">multiprocessing.managers.</tt><tt class="descname">BaseManager</tt><big>(</big><span class="optional">[</span><em>address</em><span class="optional">[</span>, <em>authkey</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.managers.BaseManager" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>BaseManager オブジェクトを作成します。</p>
<p>作成後、マネージャオブジェクトが開始されたマネージャプロセスの参照を保証するために
<a class="reference internal" href="#multiprocessing.managers.BaseManager.start" title="multiprocessing.managers.BaseManager.start"><tt class="xref py py-meth docutils literal"><span class="pre">start()</span></tt></a> か <tt class="docutils literal"><span class="pre">get_server().serve_forever()</span></tt> を呼び出します。</p>
<p><em>address</em> はマネージャプロセスが新たなコネクションを待ち受けるアドレスです。
<em>address</em> が <tt class="docutils literal"><span class="pre">None</span></tt> の場合、任意のアドレスが設定されます。</p>
<p><em>authkey</em> はサーバプロセスへ接続しようとするコネクションの正当性を検証するために使用される認証キーです。
<em>authkey</em> が <tt class="docutils literal"><span class="pre">None</span></tt> の場合 <tt class="docutils literal"><span class="pre">current_process().authkey</span></tt> が使用されます。
<em>authkey</em> を使用する場合は文字列でなければなりません。</p>
<dl class="method">
<dt id="multiprocessing.managers.BaseManager.start">
<tt class="descname">start</tt><big>(</big><span class="optional">[</span><em>initializer</em><span class="optional">[</span>, <em>initargs</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.managers.BaseManager.start" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>マネージャを開始するためにサブプロセスを開始します。
<em>initializer</em> が <tt class="docutils literal"><span class="pre">None</span></tt> でなければ、サブプロセスは開始時に
<tt class="docutils literal"><span class="pre">initializer(*initargs)</span></tt> を呼び出します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.BaseManager.get_server">
<tt class="descname">get_server</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.BaseManager.get_server" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>マネージャの制御下にある実際のサーバに相当する <tt class="xref py py-class docutils literal"><span class="pre">Server</span></tt> オブジェクトを返します。
<tt class="xref py py-class docutils literal"><span class="pre">Server</span></tt> オブジェクトは <tt class="xref py py-meth docutils literal"><span class="pre">serve_forever()</span></tt> メソッドをサポートします。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">manager</span> <span class="o">=</span> <span class="n">BaseManager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">50000</span><span class="p">),</span> <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;abc&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">server</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">get_server</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p><tt class="xref py py-class docutils literal"><span class="pre">Server</span></tt> はさらに <a class="reference internal" href="#multiprocessing.managers.BaseManager.address" title="multiprocessing.managers.BaseManager.address"><tt class="xref py py-attr docutils literal"><span class="pre">address</span></tt></a> 属性も持っています。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.BaseManager.connect">
<tt class="descname">connect</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.BaseManager.connect" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>ローカルからリモートのマネージャオブジェクトへ接続します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">BaseManager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span> <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;abc))</span><span class="gp">&gt;&gt;&gt; </span>
<span class="n">m</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.BaseManager.shutdown">
<tt class="descname">shutdown</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.BaseManager.shutdown" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>マネージャが使用するプロセスを停止します。これはサーバプロセスを開始するために <a class="reference internal" href="#multiprocessing.managers.BaseManager.start" title="multiprocessing.managers.BaseManager.start"><tt class="xref py py-meth docutils literal"><span class="pre">start()</span></tt></a> が使用された場合のみ有効です。</p>
<p>これは複数回呼び出すことができます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.BaseManager.register">
<tt class="descname">register</tt><big>(</big><em>typeid</em><span class="optional">[</span>, <em>callable</em><span class="optional">[</span>, <em>proxytype</em><span class="optional">[</span>, <em>exposed</em><span class="optional">[</span>, <em>method_to_typeid</em><span class="optional">[</span>, <em>create_method</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.managers.BaseManager.register" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>マネージャクラスで呼び出し可能オブジェクト(callable)や型を登録するために使用されるクラスメソッドです。</p>
<p><em>typeid</em> は特に共有オブジェクトの型を識別するために使用される &#8220;型識別子&#8221; です。これは文字列でなければなりません。</p>
<p><em>callable</em> はこの型識別子のオブジェクトを作成するために使用される呼び出し可能オブジェクトです。マネージャインスタンスが <tt class="xref py py-meth docutils literal"><span class="pre">from_address()</span></tt> クラスメソッドを使用して作成されるか、
<em>create_method</em> 引数が <tt class="docutils literal"><span class="pre">False</span></tt> の場合は <tt class="docutils literal"><span class="pre">None</span></tt> でも構いません。</p>
<p><em>proxytype</em> はこの <em>typeid</em> で共有オブジェクトのプロキシを作成するために使用される
<a class="reference internal" href="#multiprocessing.managers.BaseProxy" title="multiprocessing.managers.BaseProxy"><tt class="xref py py-class docutils literal"><span class="pre">BaseProxy</span></tt></a> のサブクラスです。 <tt class="docutils literal"><span class="pre">None</span></tt> の場合、プロキシクラスは自動的に作成されます。</p>
<p><em>exposed</em> は <tt class="xref py py-meth docutils literal"><span class="pre">BaseProxy._callMethod()</span></tt> を使用してアクセスされるこの typeid のプロキシになるメソッド名のシーケンスを指定するために使用されます。
( <em>exposed</em> が <tt class="docutils literal"><span class="pre">None</span></tt> の場合 <tt class="xref py py-attr docutils literal"><span class="pre">proxytype._exposed_</span></tt> が存在すれば、それが代わりに使用されます。) exposed リストが指定されない場合は、共有オブジェクトの全ての &#8220;パブリックメソッド&#8221; にアクセスされます。
(ここで言う &#8220;パブリックメソッド&#8221; は <a class="reference internal" href="../reference/datamodel.html#object.__call__" title="object.__call__"><tt class="xref py py-meth docutils literal"><span class="pre">__call__()</span></tt></a> メソッドを持ち、
<tt class="docutils literal"><span class="pre">'_'</span></tt> で始まらない名前の属性を意味します。)</p>
<p><em>method_to_typeid</em> はプロキシが返す exposed メソッドの型を指定するために使用されるマッピングです。それは typeid 文字列に対してメソッド名をマップします。
( <em>method_to_typeid</em> が <tt class="docutils literal"><span class="pre">None</span></tt> の場合 <tt class="xref py py-attr docutils literal"><span class="pre">proxytype._method_to_typeid_</span></tt>
が存在すれば、それが代わりに使用されます。) メソッド名がこのマッピングのキーではないか、マッピングが <tt class="docutils literal"><span class="pre">None</span></tt> の場合、そのメソッドによって返されるオブジェクトが値によってコピーされます。</p>
<p><em>create_method</em> は、新たな共有オブジェクトを作成するためにサーバプロセスへ伝えるのに使用されるメソッドを <em>typeid</em> の名前で作成し、そのためのプロキシを返すかを決定します。デフォルトでは <tt class="docutils literal"><span class="pre">True</span></tt> です。</p>
</dd></dl>

<p><a class="reference internal" href="#multiprocessing.managers.BaseManager" title="multiprocessing.managers.BaseManager"><tt class="xref py py-class docutils literal"><span class="pre">BaseManager</span></tt></a> インスタンスも読み取り専用属性を1つ持っています。</p>
<dl class="attribute">
<dt id="multiprocessing.managers.BaseManager.address">
<tt class="descname">address</tt><a class="headerlink" href="#multiprocessing.managers.BaseManager.address" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>マネージャが使用するアドレスです。</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="multiprocessing.managers.SyncManager">
<em class="property">class </em><tt class="descclassname">multiprocessing.managers.</tt><tt class="descname">SyncManager</tt><a class="headerlink" href="#multiprocessing.managers.SyncManager" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロセス間の同期のために使用される <a class="reference internal" href="#multiprocessing.managers.BaseManager" title="multiprocessing.managers.BaseManager"><tt class="xref py py-class docutils literal"><span class="pre">BaseManager</span></tt></a> のサブクラスです。
<tt class="xref py py-func docutils literal"><span class="pre">multiprocessing.Manager()</span></tt> はこの型のオブジェクトを返します。</p>
<p>また共有リストやディクショナリの作成もサポートします。</p>
<dl class="method">
<dt id="multiprocessing.managers.SyncManager.BoundedSemaphore">
<tt class="descname">BoundedSemaphore</tt><big>(</big><span class="optional">[</span><em>value</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.BoundedSemaphore" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有 <a class="reference internal" href="threading.html#threading.BoundedSemaphore" title="threading.BoundedSemaphore"><tt class="xref py py-class docutils literal"><span class="pre">threading.BoundedSemaphore</span></tt></a> オブジェクトを作成して、そのプロキシを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.Condition">
<tt class="descname">Condition</tt><big>(</big><span class="optional">[</span><em>lock</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.Condition" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有 <a class="reference internal" href="threading.html#threading.Condition" title="threading.Condition"><tt class="xref py py-class docutils literal"><span class="pre">threading.Condition</span></tt></a> オブジェクトを作成して、そのプロキシを返します。</p>
<p><em>lock</em> が提供される場合 <a class="reference internal" href="threading.html#threading.Lock" title="threading.Lock"><tt class="xref py py-class docutils literal"><span class="pre">threading.Lock</span></tt></a> か
<a class="reference internal" href="threading.html#threading.RLock" title="threading.RLock"><tt class="xref py py-class docutils literal"><span class="pre">threading.RLock</span></tt></a> オブジェクトのためのプロキシになります。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.Event">
<tt class="descname">Event</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.Event" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有 <a class="reference internal" href="threading.html#threading.Event" title="threading.Event"><tt class="xref py py-class docutils literal"><span class="pre">threading.Event</span></tt></a> オブジェクトを作成して、そのプロキシを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.Lock">
<tt class="descname">Lock</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.Lock" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有 <a class="reference internal" href="threading.html#threading.Lock" title="threading.Lock"><tt class="xref py py-class docutils literal"><span class="pre">threading.Lock</span></tt></a> オブジェクトを作成して、そのプロキシを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.Namespace">
<tt class="descname">Namespace</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.Namespace" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有 <a class="reference internal" href="#multiprocessing.managers.SyncManager.Namespace" title="multiprocessing.managers.SyncManager.Namespace"><tt class="xref py py-class docutils literal"><span class="pre">Namespace</span></tt></a> オブジェクトを作成して、そのプロキシを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.Queue">
<tt class="descname">Queue</tt><big>(</big><span class="optional">[</span><em>maxsize</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.Queue" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有 <a class="reference internal" href="queue.html#Queue.Queue" title="Queue.Queue"><tt class="xref py py-class docutils literal"><span class="pre">Queue.Queue</span></tt></a> オブジェクトを作成して、そのプロキシを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.RLock">
<tt class="descname">RLock</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.RLock" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有 <a class="reference internal" href="threading.html#threading.RLock" title="threading.RLock"><tt class="xref py py-class docutils literal"><span class="pre">threading.RLock</span></tt></a> オブジェクトを作成して、そのプロキシを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.Semaphore">
<tt class="descname">Semaphore</tt><big>(</big><span class="optional">[</span><em>value</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.Semaphore" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>共有 <a class="reference internal" href="threading.html#threading.Semaphore" title="threading.Semaphore"><tt class="xref py py-class docutils literal"><span class="pre">threading.Semaphore</span></tt></a> オブジェクトを作成して、そのプロキシを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.Array">
<tt class="descname">Array</tt><big>(</big><em>typecode</em>, <em>sequence</em><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.Array" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>配列を作成して、そのプロキシを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.Value">
<tt class="descname">Value</tt><big>(</big><em>typecode</em>, <em>value</em><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.Value" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>書き込み可能な <tt class="docutils literal"><span class="pre">value</span></tt> 属性を作成して、そのプロキシを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.dict">
<tt class="descname">dict</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.dict" title="この定義へのパーマリンク">¶</a></dt>
<dt>
<tt class="descname">dict</tt><big>(</big><em>mapping</em><big>)</big></dt>
<dt>
<tt class="descname">dict</tt><big>(</big><em>sequence</em><big>)</big></dt>
<dd><p>共有 <tt class="docutils literal"><span class="pre">dict</span></tt> オブジェクトを作成して、そのプロキシを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.SyncManager.list">
<tt class="descname">list</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.SyncManager.list" title="この定義へのパーマリンク">¶</a></dt>
<dt>
<tt class="descname">list</tt><big>(</big><em>sequence</em><big>)</big></dt>
<dd><p>共有 <tt class="docutils literal"><span class="pre">list</span></tt> オブジェクトを作成して、そのプロキシを返します。</p>
</dd></dl>

<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p>プロキシには、ミュータブルな値や、辞書とリストのプロキシの要素が、いつ変えられたのかを知る方法がないため、これらの値や要素の変化はマネージャを通して伝播しません。要素などを変化させるために、コンテナプロキシに変化されたオブジェクトを再代入できます。</p>
<blockquote class="last">
<div># create a list proxy and append a mutable object (a dictionary)
lproxy = manager.list()
lproxy.append({})
# now mutate the dictionary
d = lproxy[0]
d[&#8216;a&#8217;] = 1
d[&#8216;b&#8217;] = 2
# at this point, the changes to d are not yet synced, but by
# reassigning the dictionary, the proxy is notified of the change
lproxy[0] = d</div></blockquote>
</div>
</dd></dl>

<div class="section" id="namespace">
<h4>16.6.2.7.1. Namespace オブジェクト<a class="headerlink" href="#namespace" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Namespace オブジェクトはプライベートなメソッドを持っていますが、書き込み属性を持ちます。そのオブジェクト表現はその属性の値を表示します。</p>
<p>しかし、Namespace オブジェクトのためにプロキシを使用するとき
<tt class="docutils literal"><span class="pre">'_'</span></tt> が先頭に付く属性はプロキシの属性になり、参照対象の属性にはなりません。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">manager</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Global</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Namespace</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Global</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Global</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="s">&#39;hello&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Global</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="mf">12.3</span>    <span class="c"># これはプロキシの属性です</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">Global</span>
<span class="go">Namespace(x=10, y=&#39;hello&#39;)</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h4>16.6.2.7.2. カスタマイズされたマネージャ<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>独自のマネージャを作成するために <a class="reference internal" href="#multiprocessing.managers.BaseManager" title="multiprocessing.managers.BaseManager"><tt class="xref py py-class docutils literal"><span class="pre">BaseManager</span></tt></a> のサブクラスを作成して、マネージャクラスで呼び出し可能なオブジェクトか新たな型を登録するために
<a class="reference internal" href="#multiprocessing.managers.BaseManager.register" title="multiprocessing.managers.BaseManager.register"><tt class="xref py py-meth docutils literal"><span class="pre">register()</span></tt></a> クラスメソッドを使用します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span>

<span class="k">class</span> <span class="nc">MathsClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>

<span class="k">class</span> <span class="nc">MyManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">MyManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;Maths&#39;</span><span class="p">,</span> <span class="n">MathsClass</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">MyManager</span><span class="p">()</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">maths</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Maths</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">maths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>         <span class="c"># 7 を表示</span>
    <span class="k">print</span> <span class="n">maths</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>         <span class="c"># 56 を表示</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h4>16.6.2.7.3. リモートマネージャを使用する<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>あるマシン上でマネージャサーバを実行して、他のマシンからそのサーバを使用するクライアントを持つことができます(ファイアウォールを通過できることが前提)。</p>
<p>次のコマンドを実行することでリモートクライアントからアクセスを受け付ける1つの共有キューのためにサーバを作成します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">Queue</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">QueueManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span> <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">QueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_queue&#39;</span><span class="p">,</span> <span class="nb">callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span><span class="n">queue</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">QueueManager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">50000</span><span class="p">),</span> <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;abracadabra&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get_server</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>あるクライアントからサーバへのアクセスは次のようになります。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">QueueManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span> <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">QueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_queue&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">QueueManager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;foo.bar.org&#39;</span><span class="p">,</span> <span class="mi">50000</span><span class="p">),</span> <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;abracadabra&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queue</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get_queue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>別のクライアントもそれを使用することができます。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">QueueManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span> <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">QueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_queue&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">QueueManager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;foo.bar.org&#39;</span><span class="p">,</span> <span class="mi">50000</span><span class="p">),</span> <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;abracadabra&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queue</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get_queue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">&#39;hello&#39;</span>
</pre></div>
</div>
<p>ローカルプロセスもそのキューへアクセスすることができます。クライアント上で上述のコードを使用してアクセスします。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Worker</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>
<span class="gp">... </span>        <span class="nb">super</span><span class="p">(</span><span class="n">Worker</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;local hello&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">w</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">QueueManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span> <span class="k">pass</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">QueueManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;get_queue&#39;</span><span class="p">,</span> <span class="nb">callable</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">queue</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">QueueManager</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">50000</span><span class="p">),</span> <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;abracadabra&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get_server</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="proxy">
<h3>16.6.2.8. Proxy オブジェクト<a class="headerlink" href="#proxy" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>プロキシは別のプロセスで(おそらく)有効な共有オブジェクトを <em>参照する</em> オブジェクトです。共有オブジェクトはプロキシの <em>参照対象</em> になると言うことができます。複数のプロキシオブジェクトが同じ参照対象を持つ可能性もあります。</p>
<p>プロキシオブジェクトはその参照対象が持つ対応メソッドを実行するメソッドを持ちます。
(そうは言っても、参照対象の全てのメソッドが必ずしもプロキシ経由で利用可能ではありません)
プロキシは通常その参照対象ができることと同じ方法で使用されます。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Manager</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">([</span><span class="n">i</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">l</span>
<span class="go">[0, 1, 4, 9, 16, 25, 36, 49, 64, 81]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="nb">repr</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="go">&lt;ListProxy object, typeid &#39;list&#39; at 0x...&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="go">16</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
<span class="go">[4, 9, 16]</span>
</pre></div>
</div>
<p>プロキシに <a class="reference internal" href="functions.html#str" title="str"><tt class="xref py py-func docutils literal"><span class="pre">str()</span></tt></a> を適用すると参照対象のオブジェクト表現を返すのに対して、
<a class="reference internal" href="repr.html#module-repr" title="repr: 大きさに制限のある別のrepr()の実装。"><tt class="xref py py-func docutils literal"><span class="pre">repr()</span></tt></a> を適用するとプロキシのオブジェクト表現を返すことに注意してください。</p>
<p>プロキシオブジェクトの重要な機能はプロセス間で受け渡し可能な pickle 化ができることです。しかし、プロキシが対応するマネージャプロセスに対して送信される場合、そのプロキシを unpickle するとその参照対象を生成することを覚えておいてください。例えば、これはある共有オブジェクトに別の共有オブジェクトが含められることを意味します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>         <span class="c"># a の参照対象に b の参照対象を含める</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
<span class="go">[[]] []</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
<span class="go">[[&#39;hello&#39;]] [&#39;hello&#39;]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> のプロキシ型は値による比較に対して何もサポートしません。そのため、インスタンスでは、</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="go">False</span>
</pre></div>
</div>
<p class="last">比較を行いたいときは参照対象のコピーを使用してください。</p>
</div>
<dl class="class">
<dt id="multiprocessing.managers.BaseProxy">
<em class="property">class </em><tt class="descclassname">multiprocessing.managers.</tt><tt class="descname">BaseProxy</tt><a class="headerlink" href="#multiprocessing.managers.BaseProxy" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロキシオブジェクトは <a class="reference internal" href="#multiprocessing.managers.BaseProxy" title="multiprocessing.managers.BaseProxy"><tt class="xref py py-class docutils literal"><span class="pre">BaseProxy</span></tt></a> のサブクラスのインスタンスです。</p>
<dl class="method">
<dt id="multiprocessing.managers.BaseProxy._callmethod">
<tt class="descname">_callmethod</tt><big>(</big><em>methodname</em><span class="optional">[</span>, <em>args</em><span class="optional">[</span>, <em>kwds</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.managers.BaseProxy._callmethod" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロキシの参照対象のメソッドの実行結果を返します。</p>
<p><tt class="docutils literal"><span class="pre">proxy</span></tt> がプロキシで、プロキシ内の参照対象が <tt class="docutils literal"><span class="pre">obj</span></tt> なら、</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">proxy</span><span class="o">.</span><span class="n">_callmethod</span><span class="p">(</span><span class="n">methodname</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">)</span>
</pre></div>
</div>
<p>は、</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">methodname</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</pre></div>
</div>
<p>マネージャプロセス内のこの式を評価します。</p>
<p>返される値はその呼び出し結果のコピーか、新たな共有オブジェクトに対するプロキシになります。詳細は <a class="reference internal" href="#multiprocessing.managers.BaseManager.register" title="multiprocessing.managers.BaseManager.register"><tt class="xref py py-meth docutils literal"><span class="pre">BaseManager.register()</span></tt></a> の <em>method_to_typeid</em> 引数のドキュメントを参照してください。</p>
<p>例外がその呼び出しによって発生する場合 <a class="reference internal" href="#multiprocessing.managers.BaseProxy._callmethod" title="multiprocessing.managers.BaseProxy._callmethod"><tt class="xref py py-meth docutils literal"><span class="pre">_callmethod()</span></tt></a> によって再発生させます。もし他の例外がマネージャプロセスで発生するなら、
<tt class="xref py py-exc docutils literal"><span class="pre">RemoteError</span></tt> 例外に変換されて <a class="reference internal" href="#multiprocessing.managers.BaseProxy._callmethod" title="multiprocessing.managers.BaseProxy._callmethod"><tt class="xref py py-meth docutils literal"><span class="pre">_callmethod()</span></tt></a> によって発生させます。</p>
<p>特に <em>methodname</em> が <em>公開</em> されていない場合は例外が発生することに注意してください。</p>
<p><a class="reference internal" href="#multiprocessing.managers.BaseProxy._callmethod" title="multiprocessing.managers.BaseProxy._callmethod"><tt class="xref py py-meth docutils literal"><span class="pre">_callmethod()</span></tt></a> の使用例になります。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">l</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span><span class="o">.</span><span class="n">_callmethod</span><span class="p">(</span><span class="s">&#39;__len__&#39;</span><span class="p">)</span>
<span class="go">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span><span class="o">.</span><span class="n">_callmethod</span><span class="p">(</span><span class="s">&#39;__getslice__&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>   <span class="c"># `l[2:7]` と等価</span>
<span class="go">[2, 3, 4, 5, 6]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span><span class="o">.</span><span class="n">_callmethod</span><span class="p">(</span><span class="s">&#39;__getitem__&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">20</span><span class="p">,))</span>     <span class="c"># `l[20]` と等価</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="nc">IndexError</span>: <span class="n-Identifier">list index out of range</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.BaseProxy._getvalue">
<tt class="descname">_getvalue</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.BaseProxy._getvalue" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>参照対象のコピーを返します。</p>
<p>参照対象が unpickle 化できるなら例外を発生します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.BaseProxy.__repr__">
<tt class="descname">__repr__</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.BaseProxy.__repr__" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロキシオブジェクトのオブジェクト表現を返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.managers.BaseProxy.__str__">
<tt class="descname">__str__</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.managers.BaseProxy.__str__" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>参照対象のオブジェクト表現を返します。</p>
</dd></dl>

</dd></dl>

<div class="section" id="id11">
<h4>16.6.2.8.1. クリーンアップ<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>プロキシオブジェクトは弱参照(weakref)コールバックを使用します。プロキシオブジェクトがガベージコレクトされるときにその参照対象が所有するマネージャからその登録を取り消せるようにするためです。</p>
<p>共有オブジェクトはプロキシが参照しなくなったときにマネージャプロセスから削除されます。</p>
</div>
</div>
<div class="section" id="module-multiprocessing.pool">
<span id="id12"></span><h3>16.6.2.9. プロセスプール<a class="headerlink" href="#module-multiprocessing.pool" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><tt class="xref py py-class docutils literal"><span class="pre">Pool</span></tt> クラスでタスクを実行するプロセスのプールを作成することができます。</p>
<dl class="class">
<dt id="multiprocessing.pool.multiprocessing.Pool">
<em class="property">class </em><tt class="descclassname">multiprocessing.</tt><tt class="descname">Pool</tt><big>(</big><span class="optional">[</span><em>processes</em><span class="optional">[</span>, <em>initializer</em><span class="optional">[</span>, <em>initargs</em><span class="optional">[</span>, <em>maxtasksperchild</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.pool.multiprocessing.Pool" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>プロセスプールオブジェクトはジョブが実行されるようにワーカープロセスのプールを制御します。タイムアウトやコールバックで非同期の実行をサポートして、並列 map 実装を持ちます。</p>
<p><em>processes</em> は使用するワーカープロセスの数です。 <em>processes</em> が <tt class="docutils literal"><span class="pre">None</span></tt> の場合
<tt class="xref py py-func docutils literal"><span class="pre">cpu_count()</span></tt> が返す数を使用します。 <em>initializer</em> が <tt class="docutils literal"><span class="pre">None</span></tt> の場合、各ワーカープロセスが開始時に <tt class="docutils literal"><span class="pre">initializer(*initargs)</span></tt> を呼び出します。</p>
<p class="versionadded">
<span class="versionmodified">バージョン 2.7 で追加: </span><em>maxtasksperchild</em> は、使われないリソースの開放のために
ワーカープロセスが退出して、新しい
ワーカープロセスで置き換えられるまでに完了できるタスクの数です。
デフォルトの <em>maxtasksperchild</em> は None で、ワーカープロセスが
プールと同じだけ残ることを意味します。</p>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last"><tt class="xref py py-class docutils literal"><span class="pre">Pool</span></tt> 中のワーカープロセスは典型的に、プールのワークキューの存続期間とちょうど同じだけ残ります。(Apache, mod_wsgi, 等のような)
他のシステムによく見られるパターンは、ワーカーが設定された量だけのワークを完了させるまでプールに置いたら退出させ、新しいプロセスが産まれて古いプロセスを置き換えるものです。
<tt class="xref py py-class docutils literal"><span class="pre">Pool</span></tt> の <em>maxtasksperchild</em> 引数は、この能力をエンドユーザに開放します。</p>
</div>
<dl class="method">
<dt id="multiprocessing.pool.multiprocessing.Pool.apply">
<tt class="descname">apply</tt><big>(</big><em>func</em><span class="optional">[</span>, <em>args</em><span class="optional">[</span>, <em>kwds</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.pool.multiprocessing.Pool.apply" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="functions.html#apply" title="apply"><tt class="xref py py-func docutils literal"><span class="pre">apply()</span></tt></a> 組み込み関数と同じです。その結果を返せるようになるまでブロックします。これらのブロックが与えられる場合、 <a class="reference internal" href="#multiprocessing.pool.multiprocessing.Pool.apply_async" title="multiprocessing.pool.multiprocessing.Pool.apply_async"><tt class="xref py py-meth docutils literal"><span class="pre">apply_async()</span></tt></a> の方がうまく並列実行を処理します。さらに関数はプールの中の一つのワーカーにのみ渡されます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.multiprocessing.Pool.apply_async">
<tt class="descname">apply_async</tt><big>(</big><em>func</em><span class="optional">[</span>, <em>args</em><span class="optional">[</span>, <em>kwds</em><span class="optional">[</span>, <em>callback</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.pool.multiprocessing.Pool.apply_async" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="functions.html#apply" title="apply"><tt class="xref py py-meth docutils literal"><span class="pre">apply()</span></tt></a> メソッドの一種で結果オブジェクトを返します。</p>
<p><em>callback</em> が指定された場合、1つの引数を受け取って呼び出されます。その結果を返せるようになったときに <em>callback</em> が結果オブジェクトに対して
(その呼び出しが失敗しない限り)適用されます。その結果を扱う別スレッドはブロックされるので <em>callback</em> はすぐに終了します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.multiprocessing.Pool.map">
<tt class="descname">map</tt><big>(</big><em>func</em>, <em>iterable</em><span class="optional">[</span>, <em>chunksize</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.pool.multiprocessing.Pool.map" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>並列な <a class="reference internal" href="functions.html#map" title="map"><tt class="xref py py-func docutils literal"><span class="pre">map()</span></tt></a> 組み込み関数と同じです( <em>iterable</em> な引数を1つだけサポートします)。その結果を返せるようになるまでブロックします。</p>
<p>このメソッドは独立したタスクのようにプロセスプールに対して実行するチャンク数に分割します。チャンク(概算)サイズは <em>chunksize</em> に正の整数を指定することで行います。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.multiprocessing.Pool.map_async">
<tt class="descname">map_async</tt><big>(</big><em>func</em>, <em>iterable</em><span class="optional">[</span>, <em>chunksize</em><span class="optional">[</span>, <em>callback</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.pool.multiprocessing.Pool.map_async" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="functions.html#map" title="map"><tt class="xref py py-meth docutils literal"><span class="pre">map()</span></tt></a> メソッドの一種で結果オブジェクトを返します。</p>
<p><em>callback</em> が指定された場合、1つの引数を受け取って呼び出されます。その結果を返せるようになったときに <em>callback</em> が結果オブジェクトに対して
(その呼び出しが失敗しない限り)適用されます。その結果を扱う別スレッドはブロックされるので <em>callback</em> はすぐに終了します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.multiprocessing.Pool.imap">
<tt class="descname">imap</tt><big>(</big><em>func</em>, <em>iterable</em><span class="optional">[</span>, <em>chunksize</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.pool.multiprocessing.Pool.imap" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="itertools.html#itertools.imap" title="itertools.imap"><tt class="xref py py-func docutils literal"><span class="pre">itertools.imap()</span></tt></a> と同じです。</p>
<p><em>chunksize</em> 引数は <a class="reference internal" href="functions.html#map" title="map"><tt class="xref py py-meth docutils literal"><span class="pre">map()</span></tt></a> メソッドで使用されるものと同じです。引数 iterable がとても大きいなら <em>chunksize</em> に大きな値を指定して使用する方がデフォルト値の <tt class="docutils literal"><span class="pre">1</span></tt> を使用するよりもジョブの完了が <strong>かなり</strong> 速くなります。</p>
<p>また <em>chunksize</em> が <tt class="docutils literal"><span class="pre">1</span></tt> の場合 <a class="reference internal" href="#multiprocessing.pool.multiprocessing.Pool.imap" title="multiprocessing.pool.multiprocessing.Pool.imap"><tt class="xref py py-meth docutils literal"><span class="pre">imap()</span></tt></a> メソッドが返すイテレータの
<a class="reference internal" href="functions.html#next" title="next"><tt class="xref py py-meth docutils literal"><span class="pre">next()</span></tt></a> メソッドはオプションで <em>timeout</em> パラメータを持ちます。
<tt class="docutils literal"><span class="pre">next(timeout)</span></tt> は、その結果が <em>timeout</em> 秒以内に返されないときに
<tt class="xref py py-exc docutils literal"><span class="pre">multiprocessing.TimeoutError</span></tt> を発生させます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.multiprocessing.Pool.imap_unordered">
<tt class="descname">imap_unordered</tt><big>(</big><em>func</em>, <em>iterable</em><span class="optional">[</span>, <em>chunksize</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.pool.multiprocessing.Pool.imap_unordered" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>イテレータが返す結果の順番が任意の順番で良いと見なされることを除けば <a class="reference internal" href="#multiprocessing.pool.multiprocessing.Pool.imap" title="multiprocessing.pool.multiprocessing.Pool.imap"><tt class="xref py py-meth docutils literal"><span class="pre">imap()</span></tt></a> と同じです。
(ワーカープロセスが1つしかない場合のみ &#8220;正しい&#8221; 順番になることが保証されます。)</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.multiprocessing.Pool.close">
<tt class="descname">close</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.pool.multiprocessing.Pool.close" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>これ以上プールでタスクが実行されないようにします。全てのタスクが完了した後でワーカープロセスが終了します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.multiprocessing.Pool.terminate">
<tt class="descname">terminate</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.pool.multiprocessing.Pool.terminate" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>実行中の処理を完了させずにワーカープロセスをすぐに停止します。プールオブジェクトがガベージコレクトされるときに <a class="reference internal" href="#multiprocessing.pool.multiprocessing.Pool.terminate" title="multiprocessing.pool.multiprocessing.Pool.terminate"><tt class="xref py py-meth docutils literal"><span class="pre">terminate()</span></tt></a> が呼び出されます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.multiprocessing.Pool.join">
<tt class="descname">join</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.pool.multiprocessing.Pool.join" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>ワーカープロセスが終了するのを待ちます。 <a class="reference internal" href="#multiprocessing.pool.multiprocessing.Pool.join" title="multiprocessing.pool.multiprocessing.Pool.join"><tt class="xref py py-meth docutils literal"><span class="pre">join()</span></tt></a> を使用する前に
<a class="reference internal" href="#multiprocessing.pool.multiprocessing.Pool.close" title="multiprocessing.pool.multiprocessing.Pool.close"><tt class="xref py py-meth docutils literal"><span class="pre">close()</span></tt></a> か <a class="reference internal" href="#multiprocessing.pool.multiprocessing.Pool.terminate" title="multiprocessing.pool.multiprocessing.Pool.terminate"><tt class="xref py py-meth docutils literal"><span class="pre">terminate()</span></tt></a> を呼び出さなければなりません。</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="multiprocessing.pool.AsyncResult">
<em class="property">class </em><tt class="descclassname">multiprocessing.pool.</tt><tt class="descname">AsyncResult</tt><a class="headerlink" href="#multiprocessing.pool.AsyncResult" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><tt class="xref py py-meth docutils literal"><span class="pre">Pool.apply_async()</span></tt> や <tt class="xref py py-meth docutils literal"><span class="pre">Pool.map_async()</span></tt> で返される結果のクラスです。</p>
<dl class="method">
<dt id="multiprocessing.pool.AsyncResult.get">
<tt class="descname">get</tt><big>(</big><span class="optional">[</span><em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.pool.AsyncResult.get" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>結果を受け取ったときに返します。 <em>timeout</em> が <tt class="docutils literal"><span class="pre">None</span></tt> ではなくて、その結果が <em>timeout</em> 秒以内に受け取れない場合
<tt class="xref py py-exc docutils literal"><span class="pre">multiprocessing.TimeoutError</span></tt> が発生します。リモートの呼び出しが例外を発生させる場合、その例外は <a class="reference internal" href="#multiprocessing.pool.AsyncResult.get" title="multiprocessing.pool.AsyncResult.get"><tt class="xref py py-meth docutils literal"><span class="pre">get()</span></tt></a> が再発生させます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.AsyncResult.wait">
<tt class="descname">wait</tt><big>(</big><span class="optional">[</span><em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.pool.AsyncResult.wait" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>その結果が有効になるか <em>timeout</em> 秒経つまで待ちます。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.AsyncResult.ready">
<tt class="descname">ready</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.pool.AsyncResult.ready" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>その呼び出しが完了しているかどうかを返します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.pool.AsyncResult.successful">
<tt class="descname">successful</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.pool.AsyncResult.successful" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>その呼び出しが例外を発生させることなく完了したかどうかを返します。その結果が返せる状態でない場合 <a class="reference internal" href="exceptions.html#exceptions.AssertionError" title="exceptions.AssertionError"><tt class="xref py py-exc docutils literal"><span class="pre">AssertionError</span></tt></a> が発生します。</p>
</dd></dl>

</dd></dl>

<p>次の例はプールの使用例を紹介します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>              <span class="c"># 4つのワーカープロセスで開始</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,))</span>   <span class="c"># 非同期で &quot;f(10)&quot; を評価</span>
    <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>           <span class="c"># あなたのコンピュータが *かなり* 遅くない限りは &quot;100&quot; を表示</span>

    <span class="k">print</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>          <span class="c"># &quot;[0, 1, 4,..., 81]&quot; を表示</span>

    <span class="n">it</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">print</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>                       <span class="c"># &quot;0&quot; を表示</span>
    <span class="k">print</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>                       <span class="c"># &quot;1&quot; を表示</span>
    <span class="k">print</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>              <span class="c"># あなたのコンピュータが *かなり* 遅くない限りは &quot;4&quot; を表示</span>

    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,))</span>
    <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>           <span class="c"># TimeoutError を発生</span>
</pre></div>
</div>
</div>
<div class="section" id="module-multiprocessing.connection">
<span id="listeners-and-clients"></span><span id="multiprocessing-listeners-clients"></span><h3>16.6.2.10. Listeners and Clients<a class="headerlink" href="#module-multiprocessing.connection" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>通常、プロセス間でメッセージを渡すにはキューを使用するか
<tt class="xref py py-func docutils literal"><span class="pre">Pipe()</span></tt> が返す <tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt> オブジェクトを使用します。</p>
<p>しかし <a class="reference internal" href="#module-multiprocessing.connection" title="multiprocessing.connection: API for dealing with sockets."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing.connection</span></tt></a> モジュールはさらに柔軟な仕組みがあります。基本的にはソケットもしくは Windows の名前付きパイプを扱う高レベルのメッセージ指向 API を提供して <a class="reference internal" href="hmac.html#module-hmac" title="hmac: メッセージ認証のための鍵付きハッシュ化 (HMAC: Keyed-Hashing for Message Authentication) アルゴリズムの Python 用実装"><tt class="xref py py-mod docutils literal"><span class="pre">hmac</span></tt></a> モジュールを使用して <em>ダイジェスト認証</em> もサポートします。</p>
<dl class="function">
<dt id="multiprocessing.connection.deliver_challenge">
<tt class="descclassname">multiprocessing.connection.</tt><tt class="descname">deliver_challenge</tt><big>(</big><em>connection</em>, <em>authkey</em><big>)</big><a class="headerlink" href="#multiprocessing.connection.deliver_challenge" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>ランダム生成したメッセージをコネクションの相手側へ送信して応答を待ちます。</p>
<p>その応答がキーとして <em>authkey</em> を使用するメッセージのダイジェストと一致する場合、コネクションの相手側へ歓迎メッセージを送信します。そうでなければ <a class="reference internal" href="#multiprocessing.connection.AuthenticationError" title="multiprocessing.connection.AuthenticationError"><tt class="xref py py-exc docutils literal"><span class="pre">AuthenticationError</span></tt></a> を発生させます。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.connection.answerChallenge">
<tt class="descclassname">multiprocessing.connection.</tt><tt class="descname">answerChallenge</tt><big>(</big><em>connection</em>, <em>authkey</em><big>)</big><a class="headerlink" href="#multiprocessing.connection.answerChallenge" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>メッセージを受信して、そのキーとして <em>authkey</em> を使用するメッセージのダイジェストを計算し、ダイジェストを送り返します。</p>
<p>歓迎メッセージを受け取れない場合 <a class="reference internal" href="#multiprocessing.connection.AuthenticationError" title="multiprocessing.connection.AuthenticationError"><tt class="xref py py-exc docutils literal"><span class="pre">AuthenticationError</span></tt></a> が発生します。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.connection.Client">
<tt class="descclassname">multiprocessing.connection.</tt><tt class="descname">Client</tt><big>(</big><em>address</em><span class="optional">[</span>, <em>family</em><span class="optional">[</span>, <em>authenticate</em><span class="optional">[</span>, <em>authkey</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.connection.Client" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><em>address</em> で渡したアドレスを使用するリスナーに対してコネクションを確立しようとして <a class="reference internal" href="#multiprocessing.Connection" title="multiprocessing.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a> を返します。</p>
<p>コネクション種別は <em>family</em> 引数で決定しますが、一般的には <em>address</em> のフォーマットから推測できるので、これは指定されません。
( <a class="reference internal" href="#multiprocessing-address-formats"><em>アドレスフォーマット</em></a> を参照してください)</p>
<p><em>authenticate</em> が <tt class="docutils literal"><span class="pre">True</span></tt> か <em>authkey</em> が文字列の場合、ダイジェスト認証が使用されます。認証に使用されるキーは <em>authkey</em> 、又は <em>authkey</em> が <tt class="docutils literal"><span class="pre">None</span></tt> の場合は <tt class="docutils literal"><span class="pre">current_process().authkey</span></tt> のどちらかです。認証が失敗した場合 <a class="reference internal" href="#multiprocessing.connection.AuthenticationError" title="multiprocessing.connection.AuthenticationError"><tt class="xref py py-exc docutils literal"><span class="pre">AuthenticationError</span></tt></a> が発生します。
<a class="reference internal" href="#multiprocessing-auth-keys"><em>認証キー</em></a> を参照してください。</p>
</dd></dl>

<dl class="class">
<dt id="multiprocessing.connection.Listener">
<em class="property">class </em><tt class="descclassname">multiprocessing.connection.</tt><tt class="descname">Listener</tt><big>(</big><span class="optional">[</span><em>address</em><span class="optional">[</span>, <em>family</em><span class="optional">[</span>, <em>backlog</em><span class="optional">[</span>, <em>authenticate</em><span class="optional">[</span>, <em>authkey</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#multiprocessing.connection.Listener" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>コネクションを &#8216;待ち受ける&#8217; 束縛されたソケットか Windows の名前付きパイプのラッパです。</p>
<p><em>address</em> はリスナーオブジェクトの束縛されたソケットか名前付きパイプが使用するアドレスです。</p>
<div class="admonition note">
<p class="first admonition-title">ノート</p>
<p class="last">&#8216;0.0.0.0&#8217; のアドレスを使用する場合、Windows 上の終点へ接続することができません。終点へ接続したい場合は &#8216;127.0.0.1&#8217; を使用すべきです。</p>
</div>
<p><em>family</em> は使用するソケット(名前付きパイプ)の種別です。これは <tt class="docutils literal"><span class="pre">'AF_INET'</span></tt> (TCP ソケット), <tt class="docutils literal"><span class="pre">'AF_UNIX'</span></tt> (Unix ドメインソケット)
又は <tt class="docutils literal"><span class="pre">'AF_PIPE'</span></tt> (Windows 名前付きパイプ) という文字列のどれか1つになります。これらのうち <tt class="docutils literal"><span class="pre">'AF_INET'</span></tt> のみが利用可能であることが保証されています。
<em>family</em> が <tt class="docutils literal"><span class="pre">None</span></tt> の場合 <em>address</em> のフォーマットから推測されたものが使用されます。
<em>address</em> も <tt class="docutils literal"><span class="pre">None</span></tt> の場合はデフォルトが選択されます。詳細は <a class="reference internal" href="#multiprocessing-address-formats"><em>アドレスフォーマット</em></a> を参照してください。
<em>family</em> が <tt class="docutils literal"><span class="pre">'AF_UNIX'</span></tt> で <em>address</em> が <tt class="docutils literal"><span class="pre">None</span></tt> の場合 <a class="reference internal" href="tempfile.html#tempfile.mkstemp" title="tempfile.mkstemp"><tt class="xref py py-func docutils literal"><span class="pre">tempfile.mkstemp()</span></tt></a> を使用して作成されたプライベートな一時ディレクトリにソケットが作成されます。</p>
<p>リスナーオブジェクトがソケットを使用する場合、ソケットに束縛されるときに
<em>backlog</em> (デフォルトでは1つ) がソケットの <tt class="xref py py-meth docutils literal"><span class="pre">listen()</span></tt> メソッドに対して渡されます。</p>
<p><em>authenticate</em> が <tt class="docutils literal"><span class="pre">True</span></tt>  (デフォルトでは <tt class="docutils literal"><span class="pre">False</span></tt> ) か
<em>authkey</em> が <tt class="docutils literal"><span class="pre">None</span></tt> ではない場合、ダイジェスト認証が使用されます。</p>
<p><em>authkey</em> が文字列の場合、認証キーとして使用されます。そうでない場合は <em>None</em> でなければいけません。</p>
<p><em>authkey</em> が <tt class="docutils literal"><span class="pre">None</span></tt> 且つ <em>authenticate</em> が <tt class="docutils literal"><span class="pre">True</span></tt> の場合
<tt class="docutils literal"><span class="pre">current_process().authkey</span></tt> が認証キーとして使用されます。
<em>authkey</em> が <tt class="docutils literal"><span class="pre">None</span></tt> 且つ <em>authentication</em> が <tt class="docutils literal"><span class="pre">False</span></tt> の場合、認証は行われません。もし認証が失敗した場合 <a class="reference internal" href="#multiprocessing.connection.AuthenticationError" title="multiprocessing.connection.AuthenticationError"><tt class="xref py py-exc docutils literal"><span class="pre">AuthenticationError</span></tt></a> が発生します。詳細 <a class="reference internal" href="#multiprocessing-auth-keys"><em>認証キー</em></a> を参照してください。</p>
<dl class="method">
<dt id="multiprocessing.connection.Listener.accept">
<tt class="descname">accept</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.connection.Listener.accept" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>リスナーオブジェクトの名前付きパイプか束縛されたソケット上でコネクションを受け付けて <tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt> オブジェクトを返します。認証が失敗した場合 <a class="reference internal" href="#multiprocessing.connection.AuthenticationError" title="multiprocessing.connection.AuthenticationError"><tt class="xref py py-exc docutils literal"><span class="pre">AuthenticationError</span></tt></a> が発生します。</p>
</dd></dl>

<dl class="method">
<dt id="multiprocessing.connection.Listener.close">
<tt class="descname">close</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.connection.Listener.close" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>リスナーオブジェクトの名前付きパイプか束縛されたソケットをクローズします。これはリスナーがガベージコレクトされるときに自動的に呼ばれます。そうは言っても、明示的に close() を呼び出す方が望ましいです。</p>
</dd></dl>

<p>リスナーオブジェクトは次の読み取り専用属性を持っています。</p>
<dl class="attribute">
<dt id="multiprocessing.connection.Listener.address">
<tt class="descname">address</tt><a class="headerlink" href="#multiprocessing.connection.Listener.address" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>リスナーオブジェクトが使用中のアドレスです。</p>
</dd></dl>

<dl class="attribute">
<dt id="multiprocessing.connection.Listener.last_accepted">
<tt class="descname">last_accepted</tt><a class="headerlink" href="#multiprocessing.connection.Listener.last_accepted" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>最後にコネクションを受け付けたアドレスです。有効なアドレスがない場合は <tt class="docutils literal"><span class="pre">None</span></tt> になります。</p>
</dd></dl>

</dd></dl>

<p>このモジュールは2つの例外を定義します。</p>
<dl class="exception">
<dt id="multiprocessing.connection.AuthenticationError">
<em class="property">exception </em><tt class="descclassname">multiprocessing.connection.</tt><tt class="descname">AuthenticationError</tt><a class="headerlink" href="#multiprocessing.connection.AuthenticationError" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>認証エラーが起こったときに例外が発生します。</p>
</dd></dl>

<p><strong>例</strong></p>
<p>次のサーバコードは認証キーとして <tt class="docutils literal"><span class="pre">'secret</span> <span class="pre">password'</span></tt> を使用するリスナーを作成します。このサーバはコネクションを待ってクライアントへデータを送信します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing.connection</span> <span class="kn">import</span> <span class="n">Listener</span>
<span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>

<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">6000</span><span class="p">)</span>     <span class="c"># family is deduced to be &#39;AF_INET&#39;</span>
<span class="n">listener</span> <span class="o">=</span> <span class="n">Listener</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;secret password&#39;</span><span class="p">)</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&#39;connection accepted from&#39;</span><span class="p">,</span> <span class="n">listener</span><span class="o">.</span><span class="n">last_accepted</span>

<span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="mf">2.25</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;junk&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span>

<span class="n">conn</span><span class="o">.</span><span class="n">send_bytes</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>

<span class="n">conn</span><span class="o">.</span><span class="n">send_bytes</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">1729</span><span class="p">]))</span>

<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">listener</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>次のコードはサーバへ接続して、サーバからデータを受信します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing.connection</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>

<span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">6000</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">authkey</span><span class="o">=</span><span class="s">&#39;secret password&#39;</span><span class="p">)</span>

<span class="k">print</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>                 <span class="c"># =&gt; [2.25, None, &#39;junk&#39;, float]</span>

<span class="k">print</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv_bytes</span><span class="p">()</span>            <span class="c"># =&gt; &#39;hello&#39;</span>

<span class="n">arr</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="k">print</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv_bytes_into</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>     <span class="c"># =&gt; 8</span>
<span class="k">print</span> <span class="n">arr</span>                         <span class="c"># =&gt; array(&#39;i&#39;, [42, 1729, 0, 0, 0])</span>

<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="multiprocessing-address-formats">
<span id="id13"></span><h4>16.6.2.10.1. アドレスフォーマット<a class="headerlink" href="#multiprocessing-address-formats" title="このヘッドラインへのパーマリンク">¶</a></h4>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">'AF_INET'</span></tt> アドレスは <tt class="docutils literal"><span class="pre">(hostname,</span> <span class="pre">port)</span></tt> のタプルになります。
<em>hostname</em> は文字列で <em>port</em> は整数です。</li>
<li><tt class="docutils literal"><span class="pre">'AF_UNIX'</span></tt> アドレスはファイルシステム上のファイル名の文字列です。</li>
<li><tt class="docutils literal"><span class="pre">'AF_PIPE'</span></tt> アドレスは <tt class="samp docutils literal"><span class="pre">r'\\.\pipe\</span><em><span class="pre">PipeName</span></em><span class="pre">'</span></tt> の文字列です。
<em>ServerName</em> というリモートコンピュータ上の名前付きパイプに接続するために
<a class="reference internal" href="#multiprocessing.connection.Client" title="multiprocessing.connection.Client"><tt class="xref py py-func docutils literal"><span class="pre">Client()</span></tt></a> を使用するには、代わりに
<tt class="samp docutils literal"><span class="pre">r'\\</span><em><span class="pre">ServerName</span></em><span class="pre">\pipe\</span><em><span class="pre">PipeName</span></em><span class="pre">'</span></tt> のアドレスを使用すべきです。</li>
</ul>
<p>デフォルトでは、2つのバックスラッシュで始まる文字列は <tt class="docutils literal"><span class="pre">'AF_UNIX'</span></tt> よりも
<tt class="docutils literal"><span class="pre">'AF_PIPE'</span></tt> として推測されることに注意してください。</p>
</div>
</div>
<div class="section" id="multiprocessing-auth-keys">
<span id="id14"></span><h3>16.6.2.11. 認証キー<a class="headerlink" href="#multiprocessing-auth-keys" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><tt class="xref py py-meth docutils literal"><span class="pre">Connection.recv()</span></tt> を使用するとき、データは自動的に unpickle されて受信します。信頼できない接続元からのデータを unpickle することはセキュリティリスクがあります。そのため <a class="reference internal" href="#multiprocessing.connection.Listener" title="multiprocessing.connection.Listener"><tt class="xref py py-class docutils literal"><span class="pre">Listener</span></tt></a> や <a class="reference internal" href="#multiprocessing.connection.Client" title="multiprocessing.connection.Client"><tt class="xref py py-func docutils literal"><span class="pre">Client()</span></tt></a> はダイジェスト認証を提供するために
<a class="reference internal" href="hmac.html#module-hmac" title="hmac: メッセージ認証のための鍵付きハッシュ化 (HMAC: Keyed-Hashing for Message Authentication) アルゴリズムの Python 用実装"><tt class="xref py py-mod docutils literal"><span class="pre">hmac</span></tt></a> モジュールを使用します。</p>
<p>認証キーはパスワードとして見なされる文字列です。コネクションが確立すると、双方の終点で正しい接続先であることを証明するために知っているお互いの認証キーを要求します。
(双方の終点が同じキーを使用して通信しようとしても、コネクション上でそのキーを送信することは <strong>できません</strong> 。)</p>
<p>認証が要求されて認証キーが指定されている場合
<tt class="docutils literal"><span class="pre">current_process().authkey</span></tt> の返す値が使用されます。
(詳細は <a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a> を参照してください。)
この値はカレントプロセスを作成する <a class="reference internal" href="#multiprocessing.Process" title="multiprocessing.Process"><tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt></a>
オブジェクトによって自動的に継承されます。これは(デフォルトでは)複数プロセスのプログラムの全プロセスが相互にコネクションを確立するときに使用される1つの認証キーを共有することを意味します。</p>
<p>適当な認証キーを <a class="reference internal" href="os.html#os.urandom" title="os.urandom"><tt class="xref py py-func docutils literal"><span class="pre">os.urandom()</span></tt></a> を使用して生成することもできます。</p>
</div>
<div class="section" id="id15">
<h3>16.6.2.12. ロギング<a class="headerlink" href="#id15" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ロギングのために幾つかの機能が利用可能です。しかし <a class="reference internal" href="logging.html#module-logging" title="logging: アプリケーションのための、柔軟なエラーロギングシステム"><tt class="xref py py-mod docutils literal"><span class="pre">logging</span></tt></a> パッケージは、
(ハンドラ種別に依存して)違うプロセスからのメッセージがごちゃ混ぜになるので、プロセスの共有ロックを使用しないことに注意してください。</p>
<dl class="function">
<dt id="multiprocessing.get_logger">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">get_logger</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.get_logger" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> が使用するロガーを返します。必要に応じて新たなロガーを作成します。</p>
<p>最初に作成するとき、ロガーはレベルに <tt class="xref py py-data docutils literal"><span class="pre">logging.NOTSET</span></tt> が設定されていてデフォルトハンドラがありません。このロガーへ送られるメッセージはデフォルトではルートロガーへ伝播されません。</p>
<p>Windows 上では子プロセスが親プロセスのロガーレベルを継承しないことに注意してください。さらにその他のロガーのカスタマイズ内容も全て継承されません。</p>
</dd></dl>

<dl class="function">
<dt id="multiprocessing.log_to_stderr">
<tt class="descclassname">multiprocessing.</tt><tt class="descname">log_to_stderr</tt><big>(</big><big>)</big><a class="headerlink" href="#multiprocessing.log_to_stderr" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>この関数は <a class="reference internal" href="#multiprocessing.get_logger" title="multiprocessing.get_logger"><tt class="xref py py-func docutils literal"><span class="pre">get_logger()</span></tt></a> に対する呼び出しを実行しますが、
get_logger によって作成されるロガーを返すことに加えて、
<tt class="docutils literal"><span class="pre">'[%(levelname)s/%(processName)s]</span> <span class="pre">%(message)s'</span></tt> のフォーマットを使用して
<a class="reference internal" href="sys.html#sys.stderr" title="sys.stderr"><tt class="xref py py-data docutils literal"><span class="pre">sys.stderr</span></tt></a> へ出力を送るハンドラを追加します。</p>
</dd></dl>

<p>以下にロギングを有効にした例を紹介します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">multiprocessing</span><span class="o">,</span> <span class="nn">logging</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">log_to_stderr</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;doomed&#39;</span><span class="p">)</span>
<span class="go">[WARNING/MainProcess] doomed</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
<span class="go">[INFO/SyncManager-...] child process calling self.run()</span>
<span class="go">[INFO/SyncManager-...] created temp directory /.../pymp-...</span>
<span class="go">[INFO/SyncManager-...] manager serving at &#39;/.../listener-...&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">m</span>
<span class="go">[INFO/MainProcess] sending shutdown message to manager</span>
<span class="go">[INFO/SyncManager-...] manager exiting with exitcode 0</span>
</pre></div>
</div>
<p>これらの2つのロギング関数があることに加えて、
multiprocessing モジュールも2つの追加ロギングレベル属性を提供します。それは <tt class="xref py py-const docutils literal"><span class="pre">SUBWARNING</span></tt> と <tt class="xref py py-const docutils literal"><span class="pre">SUBDEBUG</span></tt> です。次の表は通常のレベル階層にうまく適合していることを表します。</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Level</th>
<th class="head">Numeric value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">SUBWARNING</span></tt></td>
<td>25</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">SUBDEBUG</span></tt></td>
<td>5</td>
</tr>
</tbody>
</table>
<p>完全なロギングレベルの表については <a class="reference internal" href="logging.html#module-logging" title="logging: アプリケーションのための、柔軟なエラーロギングシステム"><tt class="xref py py-mod docutils literal"><span class="pre">logging</span></tt></a> モジュールを参照してください。</p>
<p>こういった追加のロギングレベルは主に multiprocessing モジュールの信頼できるデバッグメッセージのために使用されます。以下に上述の例に <tt class="xref py py-const docutils literal"><span class="pre">SUBDEBUG</span></tt> を有効にしたものを紹介します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">multiprocessing</span><span class="o">,</span> <span class="nn">logging</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">log_to_stderr</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">SUBDEBUG</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;doomed&#39;</span><span class="p">)</span>
<span class="go">[WARNING/MainProcess] doomed</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
<span class="go">[INFO/SyncManager-...] child process calling self.run()</span>
<span class="go">[INFO/SyncManager-...] created temp directory /.../pymp-...</span>
<span class="go">[INFO/SyncManager-...] manager serving at &#39;/.../pymp-.../listener-...&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">m</span>
<span class="go">[SUBDEBUG/MainProcess] finalizer calling ...</span>
<span class="go">[INFO/MainProcess] sending shutdown message to manager</span>
<span class="go">[DEBUG/SyncManager-1] manager received shutdown message</span>
<span class="go">[SUBDEBUG/SyncManager-...] calling &lt;Finalize object, callback=unlink, ...</span>
<span class="go">[SUBDEBUG/SyncManager-...] finalizer calling &lt;built-in function unlink&gt; ...</span>
<span class="go">[SUBDEBUG/SyncManager-...] calling &lt;Finalize object, dead&gt;</span>
<span class="go">[SUBDEBUG/SyncManager-...] finalizer calling &lt;function rmtree at 0x5aa730&gt; ...</span>
<span class="go">[INFO/SyncManager-...] manager exiting with exitcode 0</span>
</pre></div>
</div>
</div>
<div class="section" id="module-multiprocessing.dummy">
<span id="multiprocessing-dummy"></span><h3>16.6.2.13. <a class="reference internal" href="#module-multiprocessing.dummy" title="multiprocessing.dummy: Dumb wrapper around threading."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing.dummy</span></tt></a> モジュール<a class="headerlink" href="#module-multiprocessing.dummy" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#module-multiprocessing.dummy" title="multiprocessing.dummy: Dumb wrapper around threading."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing.dummy</span></tt></a> は <a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> の API を複製しますが
<a class="reference internal" href="threading.html#module-threading" title="threading: 高水準のスレッドインタフェース"><tt class="xref py py-mod docutils literal"><span class="pre">threading</span></tt></a> モジュールのラッパーでしかありません。</p>
</div>
</div>
<div class="section" id="multiprocessing-programming">
<span id="id16"></span><h2>16.6.3. プログラミングガイドライン<a class="headerlink" href="#multiprocessing-programming" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> を使用するときに守るべき確かなガイドラインとイディオムです。</p>
<div class="section" id="id17">
<h3>16.6.3.1. 全てのプラットホーム<a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>共有状態を避ける</p>
<blockquote>
<div><p>できるだけプロセス間で巨大なデータを移動することは避けるようにすべきです。</p>
<p><a class="reference internal" href="threading.html#module-threading" title="threading: 高水準のスレッドインタフェース"><tt class="xref py py-mod docutils literal"><span class="pre">threading</span></tt></a> モジュールのプリミティブな低レベルの同期を使用するよりも、キューかパイプをプロセス間通信に使用することがおそらく最善の方法です。</p>
</div></blockquote>
<p>pickle 機能</p>
<blockquote>
<div>プロキシのメソッドへの引数は pickle 化できることを保証します。</div></blockquote>
<p>プロキシのスレッドセーフ</p>
<blockquote>
<div><p>プロキシオブジェクトをロックで保護しない限り1つ以上のスレッドから使用してはいけません。</p>
<p>(違うプロセスで <em>同じ</em> プロキシを使用することは問題ではありません。)</p>
</div></blockquote>
<p>ゾンビプロセスを join する</p>
<blockquote>
<div>Unix 上ではプロセスが終了したときに join しないと、そのプロセスはゾンビになります。新たなプロセスが開始する(又は <tt class="xref py py-func docutils literal"><span class="pre">active_children()</span></tt> が呼ばれる)ときに、
join されていない全ての完了プロセスが join されるので、あまり多くにはならないでしょう。また、終了したプロセスの
<tt class="xref py py-meth docutils literal"><span class="pre">Process.is_alive()</span></tt> はそのプロセスを join します。そうは言っても、自分で開始した全てのプロセスを明示的に join することはおそらく良いプラクティスです。</div></blockquote>
<p>pickle/unpickle より継承する方が良い</p>
<blockquote>
<div>Windows 上では <a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> の多くの型を子プロセスが使用するために
pickle 化する必要があります。しかし、パイプやキューを使用する他のプロセスへ共有オブジェクトを送ることは一般的に避けるべきです。その代わり、どこかに作成された共有リソースへアクセスが必要なプロセスは他のプロセスから継承できるようにそのプログラムを修正すべきです。</div></blockquote>
<p>プロセスを強制終了させることを避ける</p>
<blockquote>
<div><p>あるプロセスを停止するために <tt class="xref py py-meth docutils literal"><span class="pre">Process.terminate()</span></tt> メソッドを使用すると、そのプロセスが現在使用されている(ロック、セマフォ、パイプやキューのような)共有リソースを破壊したり他のプロセスから利用できない状態を引き起こし易いです。</p>
<p>そのため、共有リソースを使用しないプロセスでのみ <tt class="xref py py-meth docutils literal"><span class="pre">Process.terminate()</span></tt> を使用するように考慮することがおそらく最善の方法です。</p>
</div></blockquote>
<p>キューを使用するプロセスを join する</p>
<blockquote>
<div><p>キューに要素を追加するプロセスは、全てのバッファされた要素が &#8220;feeder&#8221; スレッドによって下位層のパイプに対してフィードされるまで終了を待つということを覚えておいてください。
(子プロセスはこの動作を避けるためにキューの <tt class="xref py py-meth docutils literal"><span class="pre">Queue.cancel_join_thread()</span></tt>
メソッドを呼ぶことができます。)</p>
<p>これはキューを使用するときに、キューに追加された全ての要素が最終的にそのプロセスが join される前に削除されていることを確認する必要があることを意味します。そうしないと、そのキューに要素が追加したプロセスの終了を保証できません。デーモンではないプロセスは自動的に join されることも覚えておいてください。</p>
<p>次の例はデッドロックを引き起こします。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;X&#39;</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">queue</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>                    <span class="c"># これはデッドロックします</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
<p>修正するには最後の2行を入れ替えます(または単純に <tt class="docutils literal"><span class="pre">p.join()</span></tt> の行を削除します)。</p>
</div></blockquote>
<p>明示的に子プロセスへリソースを渡す</p>
<blockquote>
<div><p>Unix 上では子プロセスはグローバルなリソースを使用する親プロセスが作成した共有リソースを使用することができます。しかし、引数としてそのオブジェクトを子プロセスのコンストラクタへ渡す方が良いです。</p>
<p>(潜在的に) Windows 互換なコードを作成することは別として、さらにこれは子プロセスが生き続ける限り、そのオブジェクトは親プロセスでガベージコレクトされないことも保証します。これは親プロセスでそのオブジェクトがガベージコレクトされるときにリソースが開放される場合に重要になるでしょう。</p>
<p>そのため、例えば、</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Lock</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="o">...</span> <span class="n">do</span> <span class="n">something</span> <span class="n">using</span> <span class="s">&quot;lock&quot;</span> <span class="o">...</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>次のように書き直すべきです。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Lock</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="o">...</span> <span class="n">do</span> <span class="n">something</span> <span class="n">using</span> <span class="s">&quot;l&quot;</span> <span class="o">...</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
   <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lock</span><span class="p">,))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
<p>sys.stdin をファイル形式のオブジェクトへ置き換えることに注意してください</p>
<blockquote>
<div><p><tt class="xref py py-mod docutils literal"><span class="pre">muliprocessing</span></tt> は元々 <tt class="xref py py-meth docutils literal"><span class="pre">muliprocessing.Process.__bootstrap()</span></tt> の中で無条件に</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
</pre></div>
</div>
<p>を呼び出していました &#8212; これはプロセス間で問題が起こしてしまいます。そこで、これは以下のように変更されました。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">)</span>
</pre></div>
</div>
<p>これによってプロセス間同士が衝突して bad file descripter エラーを起こすという基本的な問題は解決しました、しかし、アプリケーションの出力バッファーを
<a class="reference internal" href="sys.html#sys.stdin" title="sys.stdin"><tt class="xref py py-func docutils literal"><span class="pre">sys.stdin()</span></tt></a> からファイル形式のオブジェクトに置き換えるという潜在的危険を持ち込みます。複数のプロセスがファイル形式オブジェクトの <tt class="xref py py-func docutils literal"><span class="pre">close()</span></tt> を呼び出した場合、オブジェクトに同じデータが何度もフラッシュされ、衝突が起きる危険があります。</p>
<p>もし、ファイル形式オブジェクトを書いて、独自のキャッシュ実装する場合、キャッシュする時に常に pid を記録しておく、
pid が変わったらキュッシュを捨てることでフォークセーフにできます。例:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>
</pre></div>
</div>
<p>より詳しい情報は <a class="reference external" href="http://bugs.python.org/issue5155">issue 5155</a> 、 <a class="reference external" href="http://bugs.python.org/issue5351">issue 5351</a> 、 <a class="reference external" href="http://bugs.python.org/issue5331">issue 5331</a> を見てください。</p>
</div></blockquote>
</div>
<div class="section" id="windows">
<h3>16.6.3.2. Windows<a class="headerlink" href="#windows" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Windows では <a class="reference internal" href="os.html#os.fork" title="os.fork"><tt class="xref py py-func docutils literal"><span class="pre">os.fork()</span></tt></a> がないので幾つか追加制限があります。</p>
<p>さらなる pickle 機能</p>
<blockquote>
<div><p><tt class="xref py py-meth docutils literal"><span class="pre">Process.__init__()</span></tt> へ渡す全ての引数は pickle 化できることを保証します。これは特に束縛、又は非束縛メソッドが Windows 上の <tt class="docutils literal"><span class="pre">target</span></tt> 引数として直接的に使用できないことを意味します。その代わり、まさに関数を定義してください。</p>
<p>また <tt class="xref py py-class docutils literal"><span class="pre">Process</span></tt> をサブクラス化する場合、そのインスタンスが
<tt class="xref py py-meth docutils literal"><span class="pre">Process.start()</span></tt> メソッドが呼ばれたときに pickle 化できることを保証します。</p>
</div></blockquote>
<p>グローバル変数</p>
<blockquote>
<div><p>子プロセスで実行されるコードがグローバル変数にアクセスしようとする場合、子プロセスが見るその値は <tt class="xref py py-meth docutils literal"><span class="pre">Process.start()</span></tt> が呼ばれたときの親プロセスのその値と同じではない可能性があります。</p>
<p>しかし、単にモジュールレベルの定数であるグローバル変数なら問題にはなりません。</p>
</div></blockquote>
<p>メインモジュールの安全なインポート</p>
<blockquote>
<div><p>新たに Python インタプリタによって、意図しない副作用(新たなプロセスを開始する等)
を起こさずにメインモジュールを安全にインポートできることを保証します。</p>
<p>例えば Windows で次のモジュールを実行しようとすると <a class="reference internal" href="exceptions.html#exceptions.RuntimeError" title="exceptions.RuntimeError"><tt class="xref py py-exc docutils literal"><span class="pre">RuntimeError</span></tt></a> で失敗します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&#39;hello&#39;</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">foo</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>代わりに、次のように <tt class="docutils literal"><span class="pre">if</span> <span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__':</span></tt> を使用してプログラムの &#8220;エントリポイント&#8221; を保護すべきです。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">freeze_support</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&#39;hello&#39;</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">freeze_support</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">foo</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>( <tt class="docutils literal"><span class="pre">freeze_support()</span></tt> 行はプログラムが固まらずに実行されるなら通常は取り除かれます。)</p>
<p>これは新たに生成された Python インタプリタがそのモジュールを安全にインポートして、モジュールの <tt class="docutils literal"><span class="pre">foo()</span></tt> 関数を実行します。</p>
<p>プール又はマネージャがメインモジュールで作成される場合に似たような制限が適用されます。</p>
</div></blockquote>
</div>
</div>
<div class="section" id="multiprocessing-examples">
<span id="id18"></span><h2>16.6.4. 例<a class="headerlink" href="#multiprocessing-examples" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>カスタマイズされたマネージャやプロキシの作成方法と使用方法を紹介します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#</span>
<span class="c"># This module shows how to use arbitrary callables with a subclass of</span>
<span class="c"># `BaseManager`.</span>
<span class="c">#</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">freeze_support</span>
<span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">BaseManager</span><span class="p">,</span> <span class="n">BaseProxy</span>
<span class="kn">import</span> <span class="nn">operator</span>

<span class="c">##</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;you called Foo.f()&#39;</span>
    <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;you called Foo.g()&#39;</span>
    <span class="k">def</span> <span class="nf">_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;you called Foo._h()&#39;</span>

<span class="c"># A simple generator function</span>
<span class="k">def</span> <span class="nf">baz</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span><span class="o">*</span><span class="n">i</span>

<span class="c"># Proxy type for generator objects</span>
<span class="k">class</span> <span class="nc">GeneratorProxy</span><span class="p">(</span><span class="n">BaseProxy</span><span class="p">):</span>
    <span class="n">_exposed_</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;next&#39;</span><span class="p">,</span> <span class="s">&#39;__next__&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callmethod</span><span class="p">(</span><span class="s">&#39;next&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callmethod</span><span class="p">(</span><span class="s">&#39;__next__&#39;</span><span class="p">)</span>

<span class="c"># Function to return the operator module</span>
<span class="k">def</span> <span class="nf">get_operator_module</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">operator</span>

<span class="c">##</span>

<span class="k">class</span> <span class="nc">MyManager</span><span class="p">(</span><span class="n">BaseManager</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c"># register the Foo class; make `f()` and `g()` accessible via proxy</span>
<span class="n">MyManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;Foo1&#39;</span><span class="p">,</span> <span class="n">Foo</span><span class="p">)</span>

<span class="c"># register the Foo class; make `g()` and `_h()` accessible via proxy</span>
<span class="n">MyManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;Foo2&#39;</span><span class="p">,</span> <span class="n">Foo</span><span class="p">,</span> <span class="n">exposed</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="s">&#39;_h&#39;</span><span class="p">))</span>

<span class="c"># register the generator function baz; use `GeneratorProxy` to make proxies</span>
<span class="n">MyManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;baz&#39;</span><span class="p">,</span> <span class="n">baz</span><span class="p">,</span> <span class="n">proxytype</span><span class="o">=</span><span class="n">GeneratorProxy</span><span class="p">)</span>

<span class="c"># register get_operator_module(); make public functions accessible via proxy</span>
<span class="n">MyManager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;operator&#39;</span><span class="p">,</span> <span class="n">get_operator_module</span><span class="p">)</span>

<span class="c">##</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">MyManager</span><span class="p">()</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">print</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span>

    <span class="n">f1</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Foo1</span><span class="p">()</span>
    <span class="n">f1</span><span class="o">.</span><span class="n">f</span><span class="p">()</span>
    <span class="n">f1</span><span class="o">.</span><span class="n">g</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="s">&#39;_h&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">f1</span><span class="o">.</span><span class="n">_exposed_</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">([</span><span class="s">&#39;f&#39;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">])</span>

    <span class="k">print</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span>

    <span class="n">f2</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">Foo2</span><span class="p">()</span>
    <span class="n">f2</span><span class="o">.</span><span class="n">g</span><span class="p">()</span>
    <span class="n">f2</span><span class="o">.</span><span class="n">_h</span><span class="p">()</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="s">&#39;f&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">_exposed_</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">([</span><span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="s">&#39;_h&#39;</span><span class="p">])</span>

    <span class="k">print</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span>

    <span class="n">it</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">baz</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;&lt;</span><span class="si">%d</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
    <span class="k">print</span>

    <span class="k">print</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span>

    <span class="n">op</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">operator</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;op.add(23, 45) =&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;op.pow(2, 94) =&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">94</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;op.getslice(range(10), 2, 6) =&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">getslice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;op.repeat(range(5), 3) =&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;op._exposed_ =&#39;</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">_exposed_</span>

<span class="c">##</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">freeze_support</span><span class="p">()</span>
    <span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<p><tt class="xref py py-class docutils literal"><span class="pre">Pool</span></tt> の使用例を紹介します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#</span>
<span class="c"># A test of `multiprocessing.Pool` class</span>
<span class="c">#</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c">#</span>
<span class="c"># Functions used by test code</span>
<span class="c">#</span>

<span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> says that </span><span class="si">%s%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">result</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">calculatestar</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">calculate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">plus</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">5.0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pow3</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span>

<span class="k">def</span> <span class="nf">noop</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c">#</span>
<span class="c"># Test code</span>
<span class="c">#</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&#39;cpu_count() = </span><span class="si">%d</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>

    <span class="c">#</span>
    <span class="c"># Create pool</span>
    <span class="c">#</span>

    <span class="n">PROCESSES</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">print</span> <span class="s">&#39;Creating pool with </span><span class="si">%d</span><span class="s"> processes</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">PROCESSES</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">PROCESSES</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;pool = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pool</span>
    <span class="k">print</span>

    <span class="c">#</span>
    <span class="c"># Tests</span>
    <span class="c">#</span>

    <span class="n">TASKS</span> <span class="o">=</span> <span class="p">[(</span><span class="n">mul</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span> <span class="o">+</span> \
            <span class="p">[(</span><span class="n">plus</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">calculate</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">TASKS</span><span class="p">]</span>
    <span class="n">imap_it</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">calculatestar</span><span class="p">,</span> <span class="n">TASKS</span><span class="p">)</span>
    <span class="n">imap_unordered_it</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">calculatestar</span><span class="p">,</span> <span class="n">TASKS</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&#39;Ordered results using pool.apply_async():&#39;</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">print</span>

    <span class="k">print</span> <span class="s">&#39;Ordered results using pool.imap():&#39;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">imap_it</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">x</span>
    <span class="k">print</span>

    <span class="k">print</span> <span class="s">&#39;Unordered results using pool.imap_unordered():&#39;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">imap_unordered_it</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">x</span>
    <span class="k">print</span>

    <span class="k">print</span> <span class="s">&#39;Ordered results using pool.map() --- will block till complete:&#39;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calculatestar</span><span class="p">,</span> <span class="n">TASKS</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">x</span>
    <span class="k">print</span>

    <span class="c">#</span>
    <span class="c"># Simple benchmarks</span>
    <span class="c">#</span>

    <span class="n">N</span> <span class="o">=</span> <span class="mi">100000</span>
    <span class="k">print</span> <span class="s">&#39;def pow3(x): return x**3&#39;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">pow3</span><span class="p">,</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">map(pow3, xrange(</span><span class="si">%d</span><span class="s">)):</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s"> seconds&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">pow3</span><span class="p">,</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">pool.map(pow3, xrange(</span><span class="si">%d</span><span class="s">)):</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s"> seconds&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">C</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">pow3</span><span class="p">,</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">chunksize</span><span class="o">=</span><span class="n">N</span><span class="o">//</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">list(pool.imap(pow3, xrange(</span><span class="si">%d</span><span class="s">), chunksize=</span><span class="si">%d</span><span class="s">)):</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s">&#39;</span> \
          <span class="s">&#39; seconds&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="o">//</span><span class="mi">8</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">A</span> <span class="o">==</span> <span class="n">B</span> <span class="o">==</span> <span class="n">C</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
    <span class="k">print</span>

    <span class="n">L</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000000</span>
    <span class="k">print</span> <span class="s">&#39;def noop(x): pass&#39;</span>
    <span class="k">print</span> <span class="s">&#39;L = [None] * 1000000&#39;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">map(noop, L):</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s"> seconds&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">pool.map(noop, L):</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s"> seconds&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">C</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">noop</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">//</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">list(pool.imap(noop, L, chunksize=</span><span class="si">%d</span><span class="s">)):</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s"> seconds&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="o">//</span><span class="mi">8</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">A</span> <span class="o">==</span> <span class="n">B</span> <span class="o">==</span> <span class="n">C</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>
    <span class="k">print</span>

    <span class="k">del</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">L</span>

    <span class="c">#</span>
    <span class="c"># Test error handling</span>
    <span class="c">#</span>

    <span class="k">print</span> <span class="s">&#39;Testing error handling:&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,))</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">Got ZeroDivisionError as expected from pool.apply()&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">,</span> <span class="s">&#39;expected ZeroDivisionError&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">Got ZeroDivisionError as expected from pool.map()&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">,</span> <span class="s">&#39;expected ZeroDivisionError&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span> <span class="nb">list</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">Got ZeroDivisionError as expected from list(pool.imap())&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">,</span> <span class="s">&#39;expected ZeroDivisionError&#39;</span>

    <span class="n">it</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">,</span> <span class="s">&#39;expected ZeroDivisionError&#39;</span>

    <span class="k">assert</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">9</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">Got ZeroDivisionError as expected from IMapIterator.next()&#39;</span>
    <span class="k">print</span>

    <span class="c">#</span>
    <span class="c"># Testing timeouts</span>
    <span class="c">#</span>

    <span class="k">print</span> <span class="s">&#39;Testing ApplyResult.get() with timeout:&#39;</span><span class="p">,</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">calculate</span><span class="p">,</span> <span class="n">TASKS</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\t</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mf">0.02</span><span class="p">))</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">print</span>
    <span class="k">print</span>

    <span class="k">print</span> <span class="s">&#39;Testing IMapIterator.next() with timeout:&#39;</span><span class="p">,</span>
    <span class="n">it</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">calculatestar</span><span class="p">,</span> <span class="n">TASKS</span><span class="p">)</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\t</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="mf">0.02</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">print</span>
    <span class="k">print</span>

    <span class="c">#</span>
    <span class="c"># Testing callback</span>
    <span class="c">#</span>

    <span class="k">print</span> <span class="s">&#39;Testing callback:&#39;</span>

    <span class="n">A</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B</span> <span class="o">=</span> <span class="p">[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">343</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">729</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">callback</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map_async</span><span class="p">(</span><span class="n">pow3</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">callback</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">extend</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">A</span> <span class="o">==</span> <span class="n">B</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">callbacks succeeded</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">*** callbacks failed</span><span class="se">\n\t\t</span><span class="si">%s</span><span class="s"> != </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>

    <span class="c">#</span>
    <span class="c"># Check there are no outstanding tasks</span>
    <span class="c">#</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span> <span class="s">&#39;cache = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pool</span><span class="o">.</span><span class="n">_cache</span>

    <span class="c">#</span>
    <span class="c"># Check close() methods</span>
    <span class="c">#</span>

    <span class="k">print</span> <span class="s">&#39;Testing close():&#39;</span>

    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">_pool</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">worker</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">])</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="ow">is</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">_pool</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">worker</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>

    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">close() succeeded</span><span class="se">\n</span><span class="s">&#39;</span>

    <span class="c">#</span>
    <span class="c"># Check terminate() method</span>
    <span class="c">#</span>

    <span class="k">print</span> <span class="s">&#39;Testing terminate():&#39;</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">DELTA</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">ignore</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pow3</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">,</span> <span class="p">[</span><span class="n">DELTA</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">_pool</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">worker</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>

    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">terminate() succeeded</span><span class="se">\n</span><span class="s">&#39;</span>

    <span class="c">#</span>
    <span class="c"># Check garbage collection</span>
    <span class="c">#</span>

    <span class="k">print</span> <span class="s">&#39;Testing garbage collection:&#39;</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">DELTA</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">_pool</span>
    <span class="n">ignore</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pow3</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">,</span> <span class="p">[</span><span class="n">DELTA</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">DELTA</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">worker</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>

    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">garbage collection succeeded</span><span class="se">\n</span><span class="s">&#39;</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;processes&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39; Using processes &#39;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;threads&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39; Using threads &#39;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">as</span> <span class="nn">multiprocessing</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Usage:</span><span class="se">\n\t</span><span class="si">%s</span><span class="s"> [processes | threads]&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<p>ロック、コンディションやキューのような同期の例を紹介します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#</span>
<span class="c"># A test file for the `multiprocessing` package</span>
<span class="c">#</span>

<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">Queue</span> <span class="kn">import</span> <span class="n">Empty</span>

<span class="kn">import</span> <span class="nn">multiprocessing</span>               <span class="c"># may get overwritten</span>


<span class="c">#### TEST_VALUE</span>

<span class="k">def</span> <span class="nf">value_func</span><span class="p">(</span><span class="n">running</span><span class="p">,</span> <span class="n">mutex</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t\t\t</span><span class="s">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">())</span> <span class="o">+</span> <span class="s">&#39; has finished&#39;</span>
    <span class="n">running</span><span class="o">.</span><span class="n">value</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_value</span><span class="p">():</span>
    <span class="n">TASKS</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">running</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="n">TASKS</span><span class="p">)</span>
    <span class="n">mutex</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TASKS</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">value_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">running</span><span class="p">,</span> <span class="n">mutex</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">running</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.08</span><span class="p">)</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">print</span> <span class="n">running</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">print</span>
    <span class="k">print</span> <span class="s">&#39;No more running processes&#39;</span>


<span class="c">#### TEST_QUEUE</span>

<span class="k">def</span> <span class="nf">queue_func</span><span class="p">(</span><span class="n">queue</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">i</span><span class="p">)</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;STOP&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_queue</span><span class="p">():</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">queue_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">o</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="n">o</span> <span class="o">!=</span> <span class="s">&#39;STOP&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">o</span><span class="p">,</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;TIMEOUT&#39;</span>

    <span class="k">print</span>


<span class="c">#### TEST_CONDITION</span>

<span class="k">def</span> <span class="nf">condition_func</span><span class="p">(</span><span class="n">cond</span><span class="p">):</span>
    <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">child is notifying&#39;</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
    <span class="n">cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_condition</span><span class="p">():</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">condition_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cond</span><span class="p">,))</span>
    <span class="k">print</span> <span class="n">cond</span>

    <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">cond</span>
    <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">cond</span>

    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">print</span> <span class="s">&#39;main is waiting&#39;</span>
    <span class="n">cond</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;main has woken up&#39;</span>

    <span class="k">print</span> <span class="n">cond</span>
    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">cond</span>
    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">cond</span>


<span class="c">#### TEST_SEMAPHORE</span>

<span class="k">def</span> <span class="nf">semaphore_func</span><span class="p">(</span><span class="n">sema</span><span class="p">,</span> <span class="n">mutex</span><span class="p">,</span> <span class="n">running</span><span class="p">):</span>
    <span class="n">sema</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

    <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="n">running</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span> <span class="n">running</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;tasks are running&#39;</span>
    <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="n">running</span><span class="o">.</span><span class="n">value</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> has finished&#39;</span> <span class="o">%</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span>
    <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="n">sema</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_semaphore</span><span class="p">():</span>
    <span class="n">sema</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">mutex</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
    <span class="n">running</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">semaphore_func</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sema</span><span class="p">,</span> <span class="n">mutex</span><span class="p">,</span> <span class="n">running</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="c">#### TEST_JOIN_TIMEOUT</span>

<span class="k">def</span> <span class="nf">join_timeout_func</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">child sleeping&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">5.5</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">child terminating&#39;</span>

<span class="k">def</span> <span class="nf">test_join_timeout</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">join_timeout_func</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">print</span> <span class="s">&#39;waiting for process to finish&#39;</span>

    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">break</span>
        <span class="k">print</span> <span class="s">&#39;.&#39;</span><span class="p">,</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>


<span class="c">#### TEST_EVENT</span>

<span class="k">def</span> <span class="nf">event_func</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="si">%r</span><span class="s"> is waiting&#39;</span> <span class="o">%</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span>
    <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="si">%r</span><span class="s"> has woken up&#39;</span> <span class="o">%</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_event</span><span class="p">():</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

    <span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">event_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">event</span><span class="p">,))</span>
                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">print</span> <span class="s">&#39;main is sleeping&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&#39;main is setting event&#39;</span>
    <span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="c">#### TEST_SHAREDVALUES</span>

<span class="k">def</span> <span class="nf">sharedvalues_func</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">shared_values</span><span class="p">,</span> <span class="n">shared_arrays</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sv</span> <span class="o">=</span> <span class="n">shared_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="n">sv</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shared_arrays</span><span class="p">[</span><span class="n">i</span><span class="p">][:])</span>
        <span class="k">assert</span> <span class="n">a</span> <span class="o">==</span> <span class="n">sa</span>

    <span class="k">print</span> <span class="s">&#39;Tests passed&#39;</span>

<span class="k">def</span> <span class="nf">test_sharedvalues</span><span class="p">():</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;h&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span>
        <span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.25</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]),</span>
        <span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
        <span class="p">]</span>

    <span class="n">shared_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="n">shared_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arrays</span><span class="p">]</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
        <span class="n">target</span><span class="o">=</span><span class="n">sharedvalues_func</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">shared_values</span><span class="p">,</span> <span class="n">shared_arrays</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">==</span> <span class="mi">0</span>


<span class="c">####</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="n">multiprocessing</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">multiprocessing</span>

    <span class="n">multiprocessing</span> <span class="o">=</span> <span class="n">namespace</span>

    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">[</span> <span class="n">test_value</span><span class="p">,</span> <span class="n">test_queue</span><span class="p">,</span> <span class="n">test_condition</span><span class="p">,</span>
                  <span class="n">test_semaphore</span><span class="p">,</span> <span class="n">test_join_timeout</span><span class="p">,</span> <span class="n">test_event</span><span class="p">,</span>
                  <span class="n">test_sharedvalues</span> <span class="p">]:</span>

        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">func</span><span class="p">()</span>

    <span class="n">ignore</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">active_children</span><span class="p">()</span>      <span class="c"># cleanup any old processes</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">multiprocessing</span><span class="p">,</span> <span class="s">&#39;_debug_info&#39;</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">_debug_info</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">info</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="s">&#39;there should be no positive refcounts left&#39;</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;processes&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39; Using processes &#39;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">multiprocessing</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;manager&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39; Using processes and a manager &#39;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
        <span class="n">namespace</span><span class="o">.</span><span class="n">Process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span>
        <span class="n">namespace</span><span class="o">.</span><span class="n">current_process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span>
        <span class="n">namespace</span><span class="o">.</span><span class="n">active_children</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">active_children</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;threads&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39; Using threads &#39;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">as</span> <span class="nn">namespace</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Usage:</span><span class="se">\n\t</span><span class="si">%s</span><span class="s"> [processes | manager | threads]&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">,</span> <span class="mi">2</span>

    <span class="n">test</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>
</pre></div>
</div>
<p>ワーカープロセスのコレクションに対するタスクをフィードするキューの使用方法とその結果をまとめる方法の例をを紹介します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#</span>
<span class="c"># Simple example which uses a pool of workers to carry out some tasks.</span>
<span class="c">#</span>
<span class="c"># Notice that the results will probably not come out of the output</span>
<span class="c"># queue in the same in the same order as the corresponding tasks were</span>
<span class="c"># put on the input queue.  If it is important to get the results back</span>
<span class="c"># in the original order then consider using `Pool.map()` or</span>
<span class="c"># `Pool.imap()` (which will save on the amount of code needed anyway).</span>
<span class="c">#</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">current_process</span><span class="p">,</span> <span class="n">freeze_support</span>

<span class="c">#</span>
<span class="c"># Function run by worker processes</span>
<span class="c">#</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s">&#39;STOP&#39;</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">calculate</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Function used to calculate result</span>
<span class="c">#</span>

<span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> says that </span><span class="si">%s%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
        <span class="p">(</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Functions referenced by tasks</span>
<span class="c">#</span>

<span class="k">def</span> <span class="nf">mul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">plus</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">NUMBER_OF_PROCESSES</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">TASKS1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">mul</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>
    <span class="n">TASKS2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">plus</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>

    <span class="c"># Create queues</span>
    <span class="n">task_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">done_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

    <span class="c"># Submit tasks</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">TASKS1</span><span class="p">:</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="c"># Start worker processes</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_PROCESSES</span><span class="p">):</span>
        <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">task_queue</span><span class="p">,</span> <span class="n">done_queue</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c"># Get and print results</span>
    <span class="k">print</span> <span class="s">&#39;Unordered results:&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TASKS1</span><span class="p">)):</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">done_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="c"># Add more tasks using `put()`</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">TASKS2</span><span class="p">:</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="c"># Get and print some more results</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TASKS2</span><span class="p">)):</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">done_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="c"># Tell child processes to stop</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_OF_PROCESSES</span><span class="p">):</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;STOP&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">freeze_support</span><span class="p">()</span>
    <span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<p>ワーカープロセスのプールが1つのソケットを共有してそれぞれの <tt class="xref py py-class docutils literal"><span class="pre">SimpleHTTPServer.HttpServer</span></tt> インスタンスを実行する方法の例を紹介します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#</span>
<span class="c"># Example where a pool of http servers share a single listening socket</span>
<span class="c">#</span>
<span class="c"># On Windows this module depends on the ability to pickle a socket</span>
<span class="c"># object so that the worker processes can inherit a copy of the server</span>
<span class="c"># object.  (We import `multiprocessing.reduction` to enable this pickling.)</span>
<span class="c">#</span>
<span class="c"># Not sure if we should synchronize access to `socket.accept()` method by</span>
<span class="c"># using a process-shared lock -- does not seem to be necessary.</span>
<span class="c">#</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">current_process</span><span class="p">,</span> <span class="n">freeze_support</span>
<span class="kn">from</span> <span class="nn">BaseHTTPServer</span> <span class="kn">import</span> <span class="n">HTTPServer</span>
<span class="kn">from</span> <span class="nn">SimpleHTTPServer</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">multiprocessing.reduction</span>    <span class="c"># make sockets pickable/inheritable</span>


<span class="k">def</span> <span class="nf">note</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">]</span><span class="se">\t</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">format</span><span class="o">%</span><span class="n">args</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="c"># we override log_message() to show which process is handling the request</span>
    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">note</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="n">server</span><span class="p">):</span>
    <span class="n">note</span><span class="p">(</span><span class="s">&#39;starting server&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">runpool</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">number_of_processes</span><span class="p">):</span>
    <span class="c"># create a single server object -- children will each inherit a copy</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>

    <span class="c"># create child processes to act as workers</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_processes</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">serve_forever</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">server</span><span class="p">,))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c"># main process also acts as a worker</span>
    <span class="n">serve_forever</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;..&#39;</span><span class="p">)</span>
    <span class="n">ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
    <span class="n">NUMBER_OF_PROCESSES</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">print</span> <span class="s">&#39;Serving at http://</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s"> using </span><span class="si">%d</span><span class="s"> worker processes&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="n">ADDRESS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ADDRESS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">NUMBER_OF_PROCESSES</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;To exit press Ctrl-&#39;</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="s">&#39;Break&#39;</span><span class="p">][</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s">&#39;win32&#39;</span><span class="p">]</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">DIR</span><span class="p">)</span>
    <span class="n">runpool</span><span class="p">(</span><span class="n">ADDRESS</span><span class="p">,</span> <span class="n">NUMBER_OF_PROCESSES</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">freeze_support</span><span class="p">()</span>
    <span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference internal" href="#module-multiprocessing" title="multiprocessing: Process-based &quot;threading&quot; interface."><tt class="xref py py-mod docutils literal"><span class="pre">multiprocessing</span></tt></a> と <a class="reference internal" href="threading.html#module-threading" title="threading: 高水準のスレッドインタフェース"><tt class="xref py py-mod docutils literal"><span class="pre">threading</span></tt></a> を比較した簡単なベンチマークです。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#</span>
<span class="c"># Simple benchmarks for the multiprocessing package</span>
<span class="c">#</span>

<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">multiprocessing</span><span class="o">,</span> <span class="nn">threading</span><span class="o">,</span> <span class="nn">Queue</span><span class="o">,</span> <span class="nn">gc</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;win32&#39;</span><span class="p">:</span>
    <span class="n">_timer</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_timer</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span>

<span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span>


<span class="c">#### TEST_QUEUESPEED</span>

<span class="k">def</span> <span class="nf">queuespeed_func</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">iterations</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="s">&#39;0&#39;</span> <span class="o">*</span> <span class="mi">256</span>
    <span class="n">c</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;STOP&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_queuespeed</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">:</span>
        <span class="n">iterations</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">queuespeed_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">iterations</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_timer</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">result</span> <span class="o">!=</span> <span class="s">&#39;STOP&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">_timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>

        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">print</span> <span class="n">iterations</span><span class="p">,</span> <span class="s">&#39;objects passed through the queue in&#39;</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span>
    <span class="k">print</span> <span class="s">&#39;average number/sec:&#39;</span><span class="p">,</span> <span class="n">iterations</span><span class="o">/</span><span class="n">elapsed</span>


<span class="c">#### TEST_PIPESPEED</span>

<span class="k">def</span> <span class="nf">pipe_func</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">iterations</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="s">&#39;0&#39;</span> <span class="o">*</span> <span class="mi">256</span>
    <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="n">cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
        <span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#39;STOP&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_pipespeed</span><span class="p">():</span>
    <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pipe</span><span class="p">()</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">:</span>
        <span class="n">iterations</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">pipe_func</span><span class="p">,</span>
                                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="n">iterations</span><span class="p">))</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_timer</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">result</span> <span class="o">!=</span> <span class="s">&#39;STOP&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">_timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">print</span> <span class="n">iterations</span><span class="p">,</span> <span class="s">&#39;objects passed through connection in&#39;</span><span class="p">,</span><span class="n">elapsed</span><span class="p">,</span><span class="s">&#39;seconds&#39;</span>
    <span class="k">print</span> <span class="s">&#39;average number/sec:&#39;</span><span class="p">,</span> <span class="n">iterations</span><span class="o">/</span><span class="n">elapsed</span>


<span class="c">#### TEST_SEQSPEED</span>

<span class="k">def</span> <span class="nf">test_seqspeed</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">:</span>
        <span class="n">iterations</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">_timer</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">_timer</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

    <span class="k">print</span> <span class="n">iterations</span><span class="p">,</span> <span class="s">&#39;iterations in&#39;</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span>
    <span class="k">print</span> <span class="s">&#39;average number/sec:&#39;</span><span class="p">,</span> <span class="n">iterations</span><span class="o">/</span><span class="n">elapsed</span>


<span class="c">#### TEST_LOCK</span>

<span class="k">def</span> <span class="nf">test_lockspeed</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">:</span>
        <span class="n">iterations</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">_timer</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">l</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">l</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">_timer</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

    <span class="k">print</span> <span class="n">iterations</span><span class="p">,</span> <span class="s">&#39;iterations in&#39;</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span>
    <span class="k">print</span> <span class="s">&#39;average number/sec:&#39;</span><span class="p">,</span> <span class="n">iterations</span><span class="o">/</span><span class="n">elapsed</span>


<span class="c">#### TEST_CONDITION</span>

<span class="k">def</span> <span class="nf">conditionspeed_func</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">c</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>

    <span class="n">c</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_conditionspeed</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">iterations</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">:</span>
        <span class="n">iterations</span> <span class="o">*=</span> <span class="mi">2</span>

        <span class="n">c</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">conditionspeed_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">iterations</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">_timer</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">_timer</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

        <span class="n">c</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">print</span> <span class="n">iterations</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;waits in&#39;</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="s">&#39;seconds&#39;</span>
    <span class="k">print</span> <span class="s">&#39;average number/sec:&#39;</span><span class="p">,</span> <span class="n">iterations</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">elapsed</span>

<span class="c">####</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">manager</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>

    <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing Queue.Queue</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_queuespeed</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">,</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(),</span>
                    <span class="n">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">())</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing multiprocessing.Queue</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_queuespeed</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">,</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">(),</span>
                    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Condition</span><span class="p">())</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing Queue managed by server process</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_queuespeed</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">Queue</span><span class="p">(),</span>
                    <span class="n">manager</span><span class="o">.</span><span class="n">Condition</span><span class="p">())</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing multiprocessing.Pipe</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_pipespeed</span><span class="p">()</span>

    <span class="k">print</span>

    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing list</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_seqspeed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing list managed by server process</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_seqspeed</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing Array(&quot;i&quot;, ..., lock=False)</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_seqspeed</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">lock</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing Array(&quot;i&quot;, ..., lock=True)</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_seqspeed</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Array</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">lock</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

    <span class="k">print</span>

    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing threading.Lock</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_lockspeed</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">())</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing threading.RLock</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_lockspeed</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">())</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing multiprocessing.Lock</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_lockspeed</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">())</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing multiprocessing.RLock</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_lockspeed</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">RLock</span><span class="p">())</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing lock managed by server process</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_lockspeed</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">Lock</span><span class="p">())</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing rlock managed by server process</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_lockspeed</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">RLock</span><span class="p">())</span>

    <span class="k">print</span>

    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing threading.Condition</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_conditionspeed</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">())</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing multiprocessing.Condition</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_conditionspeed</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">,</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Condition</span><span class="p">())</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n\t</span><span class="s">######## testing condition managed by a server process</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="n">test_conditionspeed</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">Condition</span><span class="p">())</span>

    <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">multiprocessing</span><span class="o">.</span><span class="n">freeze_support</span><span class="p">()</span>
    <span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="mmap.html" title="16.7. mmap — メモリマップファイル"
             >次へ</a> |</li>
        <li class="right" >
          <a href="dummy_thread.html" title="16.5. dummy_thread — thread の代替モジュール"
             >前へ</a> |</li>
        <li><img src="../_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="../index.html">Python 2.7ja1 documentation</a> &raquo;</li>

          <li><a href="index.html" >Python 標準ライブラリ</a> &raquo;</li>
          <li><a href="someos.html" >16. オプションのオペレーティングシステムサービス</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 1990-2011, Python Software Foundation.
      最終更新: 2011-12-26
      このドキュメントは <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/02cb752c6a9e で生成しました。
    </div>
  </body>
</html>