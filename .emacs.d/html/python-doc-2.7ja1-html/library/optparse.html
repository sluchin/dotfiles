

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>15.5. optparse — コマンドラインオプション解析器 &mdash; Python 2.7ja1 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.7ja1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Python 2.7ja1 documentation 内を検索"
          href="../_static/opensearch.xml"/>
    <link rel="author" title="このドキュメントについて" href="../about.html" />
    <link rel="copyright" title="著作権" href="../copyright.html" />
    <link rel="top" title="Python 2.7ja1 documentation" href="../index.html" />
    <link rel="up" title="15. 汎用オペレーティングシステムサービス" href="allos.html" />
    <link rel="next" title="15.6. getopt — C言語スタイルのコマンドラインオプションパーサ" href="getopt.html" />
    <link rel="prev" title="15.4. argparse — コマンドラインオプション、引数、サブコマンドのパーサー" href="argparse.html" />
    <link rel="shortcut icon" type="image/png" href="../_static/py.png" />
    <script type="text/javascript" src="../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/_jp.js"></script>
    
 

  </head>
  <body>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="getopt.html" title="15.6. getopt — C言語スタイルのコマンドラインオプションパーサ"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="argparse.html" title="15.4. argparse — コマンドラインオプション、引数、サブコマンドのパーサー"
             accesskey="P">前へ</a> |</li>
        <li><img src="../_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="../index.html">Python 2.7ja1 documentation</a> &raquo;</li>

          <li><a href="index.html" >Python 標準ライブラリ</a> &raquo;</li>
          <li><a href="allos.html" accesskey="U">15. 汎用オペレーティングシステムサービス</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../contents.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">15.5. <tt class="docutils literal"><span class="pre">optparse</span></tt> &#8212; コマンドラインオプション解析器</a><ul>
<li><a class="reference internal" href="#optparse-background">15.5.1. 背景</a><ul>
<li><a class="reference internal" href="#optparse-terminology">15.5.1.1. 用語集</a></li>
<li><a class="reference internal" href="#optparse-what-options-for">15.5.1.2. オプションとは何か</a></li>
<li><a class="reference internal" href="#optparse-what-positional-arguments-for">15.5.1.3. 固定引数とは何か</a></li>
</ul>
</li>
<li><a class="reference internal" href="#optparse-tutorial">15.5.2. チュートリアル</a><ul>
<li><a class="reference internal" href="#optparse-understanding-option-actions">15.5.2.1. オプション・アクションを理解する</a></li>
<li><a class="reference internal" href="#store">15.5.2.2. store アクション</a></li>
<li><a class="reference internal" href="#optparse-handling-boolean-options">15.5.2.3. ブール値 (フラグ) オプションの処理</a></li>
<li><a class="reference internal" href="#optparse-other-actions">15.5.2.4. その他のアクション</a></li>
<li><a class="reference internal" href="#optparse-default-values">15.5.2.5. デフォルト値</a></li>
<li><a class="reference internal" href="#optparse-generating-help">15.5.2.6. ヘルプの生成</a><ul>
<li><a class="reference internal" href="#id11">15.5.2.6.1. オプションをグループ化する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#optparse-printing-version-string">15.5.2.7. バージョン番号の出力</a></li>
<li><a class="reference internal" href="#optparse-how-optparse-handles-errors">15.5.2.8. <tt class="docutils literal"><span class="pre">optparse</span></tt> のエラー処理法</a></li>
<li><a class="reference internal" href="#optparse-putting-it-all-together">15.5.2.9. 全てをつなぎ合わせる</a></li>
</ul>
</li>
<li><a class="reference internal" href="#optparse-reference-guide">15.5.3. リファレンスガイド</a><ul>
<li><a class="reference internal" href="#parser">15.5.3.1. parserを作る</a></li>
<li><a class="reference internal" href="#optparse-populating-parser">15.5.3.2. パーザへのオプション追加</a></li>
<li><a class="reference internal" href="#optparse-defining-options">15.5.3.3. オプションの定義</a></li>
<li><a class="reference internal" href="#optparse-option-attributes">15.5.3.4. オプション属性</a></li>
<li><a class="reference internal" href="#optparse-standard-option-actions">15.5.3.5. 標準的なオプション・アクション</a></li>
<li><a class="reference internal" href="#optparse-standard-option-types">15.5.3.6. 標準のオプション型</a></li>
<li><a class="reference internal" href="#optparse-parsing-arguments">15.5.3.7. 引数の解析</a></li>
<li><a class="reference internal" href="#optparse-querying-manipulating-option-parser">15.5.3.8. オプション解析器への問い合わせと操作</a></li>
<li><a class="reference internal" href="#optparse-conflicts-between-options">15.5.3.9. オプション間の衝突</a></li>
<li><a class="reference internal" href="#optparse-cleanup">15.5.3.10. クリーンアップ</a></li>
<li><a class="reference internal" href="#optparse-other-methods">15.5.3.11. その他のメソッド</a></li>
</ul>
</li>
<li><a class="reference internal" href="#optparse-option-callbacks">15.5.4. オプション処理コールバック</a><ul>
<li><a class="reference internal" href="#callback">15.5.4.1. callbackオプションの定義</a></li>
<li><a class="reference internal" href="#optparse-how-callbacks-called">15.5.4.2. コールバック関数はどのように呼び出されるか</a></li>
<li><a class="reference internal" href="#optparse-raising-errors-in-callback">15.5.4.3. コールバック中で例外を送出する</a></li>
<li><a class="reference internal" href="#optparse-callback-example-1">15.5.4.4. コールバックの例 1: ありふれたコールバック</a></li>
<li><a class="reference internal" href="#optparse-callback-example-2">15.5.4.5. コールバックの例 2: オプションの順番をチェックする</a></li>
<li><a class="reference internal" href="#optparse-callback-example-3">15.5.4.6. コールバックの例 3: オプションの順番をチェックする (汎用的)</a></li>
<li><a class="reference internal" href="#optparse-callback-example-4">15.5.4.7. コールバックの例 4: 任意の条件をチェックする</a></li>
<li><a class="reference internal" href="#optparse-callback-example-5">15.5.4.8. コールバックの例5: 固定引数</a></li>
<li><a class="reference internal" href="#optparse-callback-example-6">15.5.4.9. コールバックの例6: 可変個の引数</a></li>
</ul>
</li>
<li><a class="reference internal" href="#optparse-extending-optparse">15.5.5. <tt class="docutils literal"><span class="pre">optparse</span></tt> の拡張</a><ul>
<li><a class="reference internal" href="#optparse-adding-new-types">15.5.5.1. 新しい型の追加</a></li>
<li><a class="reference internal" href="#optparse-adding-new-actions">15.5.5.2. 新しいアクションの追加</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="argparse.html"
                        title="前の章へ">15.4. <tt class="docutils literal docutils literal"><span class="pre">argparse</span></tt> &#8212; コマンドラインオプション、引数、サブコマンドのパーサー</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="getopt.html"
                        title="次の章へ">15.6. <tt class="docutils literal docutils literal docutils literal"><span class="pre">getopt</span></tt> &#8212; C言語スタイルのコマンドラインオプションパーサ</a></p>
  <h3>このページ</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/library/optparse.txt"
           rel="nofollow">ソースコードを表示</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>クイック検索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="検索" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    モジュール、クラス、または関数名を入力してください
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-optparse">
<span id="optparse"></span><h1>15.5. <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> &#8212; コマンドラインオプション解析器<a class="headerlink" href="#module-optparse" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p class="deprecated">
<span class="versionmodified">バージョン 2.7 で撤廃: </span><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> モジュールは廃止予定で、今後開発はされません。
今後の開発は <a class="reference internal" href="argparse.html#module-argparse" title="argparse: コマンドラインオプションと引数のパーサーライブラリ"><tt class="xref py py-mod docutils literal"><span class="pre">argparse</span></tt></a> モジュールに対して行われます。</p>
<p class="versionadded">
<span class="versionmodified">バージョン 2.3 で追加.</span></p>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> モジュールは、昔からある <a class="reference internal" href="getopt.html#module-getopt" title="getopt: ポータブルなコマンドラインオプションのパーサ。 長短の両方の形式をサポートします。"><tt class="xref py py-mod docutils literal"><span class="pre">getopt</span></tt></a> よりも簡便で、柔軟性に富み、かつ強力なコマンドライン解析ライブラリです。
<a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> では、より宣言的なスタイルのコマンドライン解析手法、すなわち
<a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> のインスタンスを作成してオプションを追加してゆき、そのインスタンスでコマンドラインを解析するという手法をとっています。
<a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> を使うと、GNU/POSIX 構文でオプションを指定できるだけでなく、使用法やヘルプメッセージの生成も行えます。</p>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> を使った簡単なスクリプトの例を以下に示します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>

<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;--file&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;filename&quot;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&quot;write report to FILE&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;FILE&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="s">&quot;--quiet&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_false&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&quot;don&#39;t print status messages to stdout&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</pre></div>
</div>
<p>このようにわずかな行数のコードによって、スクリプトのユーザはコマンドライン上で例えば以下のような「よくある使い方」を実行できるようになります。</p>
<div class="highlight-python"><pre>&lt;yourscript&gt; --file=outfile -q</pre>
</div>
<p>コマンドライン解析の中で、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はユーザの指定したコマンドライン引数値に応じて <tt class="xref py py-meth docutils literal"><span class="pre">parse_args()</span></tt> の返す
<tt class="docutils literal"><span class="pre">options</span></tt> の属性値を設定してゆきます。 <tt class="xref py py-meth docutils literal"><span class="pre">parse_args()</span></tt> がコマンドライン解析から処理を戻したとき、
<tt class="docutils literal"><span class="pre">options.filename</span></tt> は <tt class="docutils literal"><span class="pre">&quot;outfile&quot;</span></tt> に、 <tt class="docutils literal"><span class="pre">options.verbose</span></tt> は <tt class="docutils literal"><span class="pre">False</span></tt>
になっているはずです。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は長い形式と短い形式の両方のオプション表記をサポートしており、短い形式は結合して指定できます。また、様々な形でオプションに引数値を関連付けられます。従って、以下のコマンドラインは全て上の例と同じ意味になります。</p>
<div class="highlight-python"><pre>&lt;yourscript&gt; -f outfile --quiet
&lt;yourscript&gt; --quiet --file outfile
&lt;yourscript&gt; -q -foutfile
&lt;yourscript&gt; -qfoutfile</pre>
</div>
<p>さらに、ユーザが</p>
<div class="highlight-python"><pre>&lt;yourscript&gt; -h
&lt;yourscript&gt; --help</pre>
</div>
<p>のいずれかを実行すると、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はスクリプトのオプションについて簡単にまとめた内容を出力します。</p>
<div class="highlight-text"><div class="highlight"><pre>Usage: &lt;yourscript&gt; [options]

Options:
  -h, --help            show this help message and exit
  -f FILE, --file=FILE  write report to FILE
  -q, --quiet           don&#39;t print status messages to stdout
</pre></div>
</div>
<p><em>yourscript</em> の中身は実行時に決まります (通常は <tt class="docutils literal"><span class="pre">sys.argv[0]</span></tt> になります)。</p>
<div class="section" id="optparse-background">
<span id="id1"></span><h2>15.5.1. 背景<a class="headerlink" href="#optparse-background" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は、素直で慣習に則ったコマンドラインインタフェースを備えたプログラムの作成を援助する目的で設計されました。その結果、Unix
で慣習的に使われているコマンドラインの構文や機能だけをサポートするに留まっています。こうした慣習に詳しくなければ、よく知っておくためにもこの節を読んでおきましょう。</p>
<div class="section" id="optparse-terminology">
<span id="id2"></span><h3>15.5.1.1. 用語集<a class="headerlink" href="#optparse-terminology" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="docutils">
<dt>引数 (argument)</dt>
<dd><p class="first">コマンドラインでユーザが入力するテキストの塊で、シェルが <tt class="xref c c-func docutils literal"><span class="pre">execl()</span></tt> や <tt class="xref c c-func docutils literal"><span class="pre">execv()</span></tt> に引き渡すものです。Python
では、引数は <tt class="docutils literal"><span class="pre">sys.argv[1:]</span></tt> の要素となります。(<tt class="docutils literal"><span class="pre">sys.argv[0]</span></tt>
は実行しようとしているプログラムの名前です。引数解析に関しては、この要素はあまり重要ではありません。) Unix シェルでは、「語 (word)」という用語も使います。</p>
<p class="last">場合によっては <tt class="docutils literal"><span class="pre">sys.argv[1:]</span></tt> 以外の引数リストを代入する方が望ましいことがあるので、「引数」は「 <tt class="docutils literal"><span class="pre">sys.argv[1:]</span></tt>
または <tt class="docutils literal"><span class="pre">sys.argv[1:]</span></tt> の代替として提供される別のリストの要素」と読むべきでしょう。</p>
</dd>
<dt>オプション (option)</dt>
<dd><p class="first">追加的な情報を与えるための引数で、プログラムの実行に対する教示やカスタマイズを行います。オプションには多様な文法が存在します。伝統的な Unix
における書法はハイフン (&#8220;-&#8221;) の後ろに一文字が続くもので、例えば <tt class="docutils literal"><span class="pre">-x</span></tt> や <tt class="docutils literal"><span class="pre">-F</span></tt> です。また、伝統的な Unix における書法では、複数のオプションを一つの引数にまとめられます。例えば <tt class="docutils literal"><span class="pre">-x</span> <span class="pre">-F</span></tt> は <tt class="docutils literal"><span class="pre">-xF</span></tt> と等価です。 GNU プロジェクトでは
<tt class="docutils literal"><span class="pre">--</span></tt> の後ろにハイフンで区切りの語を指定する方法、例えば <tt class="docutils literal"><span class="pre">--file</span></tt> や
<tt class="docutils literal"><span class="pre">--dry-run</span></tt> も提供しています。
<a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は、これら二種類のオプション書法だけをサポートしています。</p>
<p>他に見られる他のオプション書法には以下のようなものがあります:</p>
<ul class="simple">
<li>ハイフンの後ろに数個の文字が続くもので、例えば <tt class="docutils literal"><span class="pre">-pf</span></tt>
(このオプションは複数のオプションを一つにまとめたものとは <em>違います</em>)</li>
<li>ハイフンの後ろに語が続くもので、例えば <tt class="docutils literal"><span class="pre">-file</span></tt>
(これは技術的には上の書式と同じですが、通常同じプログラム上で一緒に使うことはありません)</li>
<li>プラス記号の後ろに一文字、数個の文字、または語を続けたもので、例えば
<tt class="docutils literal"><span class="pre">+f</span></tt>, <tt class="docutils literal"><span class="pre">+rgb</span></tt></li>
<li>スラッシュ記号の後ろに一文字、数個の文字、または語を続けたもので、例えば
<tt class="docutils literal"><span class="pre">/f</span></tt>, <tt class="docutils literal"><span class="pre">/file</span></tt></li>
</ul>
<p class="last">上記のオプション書法は <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> ではサポートしておらず、今後もサポートする予定はありません。これは故意によるものです:
最初の三つはどの環境の標準でもなく、最後の一つは VMS や MS-DOS, そして Windows を対象にしているときにしか意味をなさないからです。</p>
</dd>
<dt>オプション引数 (option argument)</dt>
<dd><p class="first">あるオプションの後ろに続く引数で、そのオプションに密接な関連をもち、オプションと同時に引数リストから取り出されます。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
では、オプション引数は以下のように別々の引数にできます。</p>
<div class="highlight-text"><div class="highlight"><pre>-f foo
--file foo
</pre></div>
</div>
<p>また、一つの引数中にも入れられます。</p>
<div class="highlight-text"><div class="highlight"><pre>-ffoo
--file=foo
</pre></div>
</div>
<p class="last">通常、オプションは引数をとることもとらないこともあります。あるオプションは引数をとることがなく、またあるオプションは常に引数をとります。多くの人々が「オプションのオプション引数」機能を欲しています。これは、あるオプションが引数が指定されている場合には引数をとり、そうでない場合には引数をもたないようにするという機能です。この機能は引数解析をあいまいにするため、議論の的となっています: 例えば、もし
<tt class="docutils literal"><span class="pre">-a</span></tt> がオプション引数をとり、 <tt class="docutils literal"><span class="pre">-b</span></tt> がまったく別のオプションだとしたら、
<tt class="docutils literal"><span class="pre">-ab</span></tt> をどうやって解析すればいいのでしょうか？こうした曖昧さが存在するため、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は今のところこの機能をサポートしていません。</p>
</dd>
<dt>固定引数 (positional argument)</dt>
<dd>他のオプションが解析される、すなわち他のオプションとその引数が解析されて引数リストから除去された後に引数リストに置かれているものです。</dd>
<dt>必須のオプション (required option)</dt>
<dd>コマンドラインで与えなければならないオプションです; 「必須なオプション (required
option)」という語は、英語では矛盾した言葉です。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
では必須オプションの実装を妨げてはいませんが、とりたてて実装上役立つこともしていません。</dd>
</dl>
<p>例えば、下記のような架空のコマンドラインを考えてみましょう:</p>
<div class="highlight-python"><pre>prog -v --report /tmp/report.txt foo bar</pre>
</div>
<p><tt class="docutils literal"><span class="pre">-v</span></tt> と <tt class="docutils literal"><span class="pre">--report</span></tt> はどちらもオプションです。 <tt class="docutils literal"><span class="pre">--report</span></tt> オプションが引数をとるとすれば、
<tt class="docutils literal"><span class="pre">/tmp/report.txt</span></tt> はオプションの引数です。
<tt class="docutils literal"><span class="pre">foo</span></tt> と <tt class="docutils literal"><span class="pre">bar</span></tt> は固定引数になります。</p>
</div>
<div class="section" id="optparse-what-options-for">
<span id="id3"></span><h3>15.5.1.2. オプションとは何か<a class="headerlink" href="#optparse-what-options-for" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>オプションはプログラムの実行を調整したり、カスタマイズしたりするための補助的な情報を与えるために使います。もっとはっきりいうと、オプションはあくまでもオプション
(省略可能)であるということです。本来、プログラムはともかくもオプションなしでうまく実行できてしかるべきです。(Unix やGNU
ツールセットのプログラムをランダムにピックアップしてみてください。オプションを全く指定しなくてもちゃんと動くでしょう？例外は <tt class="docutils literal"><span class="pre">find</span></tt>,
<tt class="docutils literal"><span class="pre">tar</span></tt>, <tt class="docutils literal"><span class="pre">dd</span></tt> くらいです&#8212;これらの例外は、オプション文法が標準的でなく、インタフェースが混乱を招くと酷評されてきた変種のはみ出しものなのです)</p>
<p>多くの人が自分のプログラムに「必須のオプション」を持たせたいと考えます。しかしよく考えてください。必須なら、それは <em>オプション(省略可能) ではないのです！</em>
プログラムを正しく動作させるのに絶対的に必要な情報があるとすれば、そこには固定引数を割り当てるべきなのです。</p>
<p>良くできたコマンドラインインタフェース設計として、ファイルのコピーに使われる <tt class="docutils literal"><span class="pre">cp</span></tt> ユーティリティのことを考えてみましょう。ファイルのコピーでは、コピー先を指定せずにファイルをコピーするのは無意味な操作ですし、少なくとも一つのコピー元が必要です。従って、 <tt class="docutils literal"><span class="pre">cp</span></tt> は引数無しで実行すると失敗します。とはいえ、 <tt class="docutils literal"><span class="pre">cp</span></tt> はオプションを全く必要としない柔軟で便利なコマンドライン文法を備えています:</p>
<div class="highlight-python"><pre>cp SOURCE DEST
cp SOURCE ... DEST-DIR</pre>
</div>
<p>まだあります。ほとんどの <tt class="docutils literal"><span class="pre">cp</span></tt> の実装では、ファイルモードや変更時刻を変えずにコピーする、シンボリックリンクの追跡を行わない、すでにあるファイルを上書きする前にユーザに尋ねる、など、ファイルをコピーする方法をいじるための一連のオプションを実装しています。しかし、こうしたオプションは、一つのファイルを別の場所にコピーする、または複数のファイルを別のディレクトリにコピーするという、 <tt class="docutils literal"><span class="pre">cp</span></tt>
の中心的な処理を乱すことはないのです。</p>
</div>
<div class="section" id="optparse-what-positional-arguments-for">
<span id="id4"></span><h3>15.5.1.3. 固定引数とは何か<a class="headerlink" href="#optparse-what-positional-arguments-for" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>固定引数とは、プログラムを動作させる上で絶対的に必要な情報となる引数です。</p>
<p>よいユーザインタフェースとは、可能な限り少ない固定引数をもつものです。プログラムを正しく動作させるために 17 個もの別個の情報が必要だとしたら、その <em>方法</em> はさして問題にはなりません &#8212;ユーザはプログラムを正しく動作させられないうちに諦め、立ち去ってしまうからです。ユーザインタフェースがコマンドラインでも、設定ファイルでも、GUI やその他の何であっても同じです: 多くの要求をユーザに押し付ければ、ほとんどのユーザはただ音をあげてしまうだけなのです。</p>
<p>要するに、ユーザが絶対に提供しなければならない情報だけに制限する &#8212; そして可能な限りよく練られたデフォルト設定を使うよう試みてください。もちろん、プログラムには適度な柔軟性を持たせたいとも望むはずですが、それこそがオプションの果たす役割です。繰り返しますが、設定ファイルのエントリであろうが、
GUI でできた「環境設定」ダイアログ上のウィジェットであろうが、コマンドラインオプションであろうが関係ありません &#8212;
より多くのオプションを実装すればプログラムはより柔軟性を持ちますが、実装はより難解になるのです。高すぎる柔軟性はユーザを閉口させ、コードの維持をより難しくするのです。</p>
</div>
</div>
<div class="section" id="optparse-tutorial">
<span id="id5"></span><h2>15.5.2. チュートリアル<a class="headerlink" href="#optparse-tutorial" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はとても柔軟で強力でありながら、ほとんどの場合には簡単に利用できます。この節では、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
ベースのプログラムで広く使われているコードパターンについて述べます。</p>
<p>まず、 <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> クラスを import しておかねばなりません。次に、プログラムの冒頭で
<a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> インスタンスを生成しておきます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">()</span>
</pre></div>
</div>
<p>これでオプションを定義できるようになりました。基本的な構文は以下の通りです:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">opt_str</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
                  <span class="n">attr</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>各オプションには、 <tt class="docutils literal"><span class="pre">-f</span></tt> や <tt class="docutils literal"><span class="pre">--file</span></tt> のような一つまたは複数のオプション文字列と、パーザがコマンドライン上のオプションを見つけた際に、何を準備し、何を行うべきかを <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
に教えるためのオプション属性 (option attribute)がいくつか入ります。</p>
<p>通常、各オプションには短いオプション文字列と長いオプション文字列があります。例えば:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;--file&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>といった具合です。</p>
<p>オプション文字列は、(ゼロ文字の場合も含め)いくらでも短く、またいくらでも長くできます。ただしオプション文字列は少なくとも一つなければなりません。</p>
<p><tt class="xref py py-meth docutils literal"><span class="pre">add_option()</span></tt> に渡されたオプション文字列は、実際にはこの関数で定義したオプションに対するラベルになります。簡単のため、以後ではコマンドライン上で <em>オプションを見つける</em> という表現をしばしば使いますが、これは実際には <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
がコマンドライン上の <em>オプション文字列</em> を見つけ、対応づけされているオプションを捜し出す、という処理に相当します。</p>
<p>オプションを全て定義したら、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> にコマンドラインを解析するように指示します:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</pre></div>
</div>
<p>(お望みなら、 <tt class="xref py py-meth docutils literal"><span class="pre">parse_args()</span></tt> に自作の引数リストを渡してもかまいません。とはいえ、実際にはそうした必要はほとんどないでしょう:
<tt class="xref py py-mod docutils literal"><span class="pre">optionparser</span></tt> はデフォルトで <tt class="docutils literal"><span class="pre">sys.argv[1:]</span></tt> を使うからです。)</p>
<p><tt class="xref py py-meth docutils literal"><span class="pre">parse_args()</span></tt> は二つの値を返します:</p>
<ul class="simple">
<li>全てのオプションに対する値の入ったオブジェクト <tt class="docutils literal"><span class="pre">options</span></tt> &#8212; 例えば、 <tt class="docutils literal"><span class="pre">--file</span></tt>
が単一の文字列引数をとる場合、 <tt class="docutils literal"><span class="pre">options.file</span></tt> はユーザが指定したファイル名になります。オプションを指定しなかった場合には <tt class="docutils literal"><span class="pre">None</span></tt>
になります。</li>
<li>オプションの解析後に残った固定引数からなるリスト <tt class="docutils literal"><span class="pre">args</span></tt> 。</li>
</ul>
<p>このチュートリアルの節では、最も重要な四つのオプション属性:
<a class="reference internal" href="#optparse.Option.action" title="optparse.Option.action"><tt class="xref py py-attr docutils literal"><span class="pre">action</span></tt></a>, <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a>, <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a>
(destination), <a class="reference internal" href="#optparse.Option.help" title="optparse.Option.help"><tt class="xref py py-attr docutils literal"><span class="pre">help</span></tt></a> についてしか触れません。このうち最も重要なのは <a class="reference internal" href="#optparse.Option.action" title="optparse.Option.action"><tt class="xref py py-attr docutils literal"><span class="pre">action</span></tt></a> です。</p>
<div class="section" id="optparse-understanding-option-actions">
<span id="id6"></span><h3>15.5.2.1. オプション・アクションを理解する<a class="headerlink" href="#optparse-understanding-option-actions" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>アクション(action)は <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> がコマンドライン上にあるオプションを見つけたときに何をすべきかを指示します。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> には押し着せのアクションのセットがハードコードされています。新たなアクションの追加は上級者向けの話題であり、 <a class="reference internal" href="#optparse-extending-optparse"><em>optparse の拡張</em></a> で触れます。ほとんどのアクションは、値を何らかの変数に記憶するよう <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> に指示します &#8212;
例えば、文字列をコマンドラインから取り出して、 <tt class="docutils literal"><span class="pre">options</span></tt> の属性の中に入れる、といった具合にです。</p>
<p>オプション・アクションを指定しない場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> のデフォルトの動作は <tt class="docutils literal"><span class="pre">store</span></tt> になります。</p>
</div>
<div class="section" id="store">
<span id="optparse-store-action"></span><h3>15.5.2.2. store アクション<a class="headerlink" href="#store" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>もっとも良く使われるアクションは <tt class="docutils literal"><span class="pre">store</span></tt> です。このアクションは次の引数 (あるいは現在の引数の残りの部分) を取り出し、正しい型の値か確かめ、指定した保存先に保存するよう <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> に指示します。</p>
<p>例えば:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;--file&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;filename&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>のように指定しておき、偽のコマンドラインを作成して <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> に解析させてみましょう:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;foo.txt&quot;</span><span class="p">]</span>
<span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>オプション文字列 <tt class="docutils literal"><span class="pre">-f</span></tt> を見つけると、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は次の引数である <tt class="docutils literal"><span class="pre">foo.txt</span></tt> を消費し、その値を
<tt class="docutils literal"><span class="pre">options.filename</span></tt> に保存します。従って、この <tt class="xref py py-meth docutils literal"><span class="pre">parse_args()</span></tt> 呼び出し後には
<tt class="docutils literal"><span class="pre">options.filename</span></tt> は <tt class="docutils literal"><span class="pre">&quot;foo.txt&quot;</span></tt> になっています。</p>
<p>オプションの型として、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は他にも <tt class="docutils literal"><span class="pre">int</span></tt> や <tt class="docutils literal"><span class="pre">float</span></tt> をサポートしています。</p>
<p>整数の引数を想定したオプションの例を示します:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;num&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>このオプションには長い形式のオプション文字列がないため、設定に問題がないということに注意してください。また、デフォルトのアクションは <tt class="docutils literal"><span class="pre">store</span></tt>
なので、ここでは action を明示的に指定していません。</p>
<p>架空のコマンドラインをもう一つ解析してみましょう。今度は、オプション引数をオプションの右側にぴったりくっつけて一緒くたにします: <tt class="docutils literal"><span class="pre">-n42</span></tt>
(一つの引数のみ) は <tt class="docutils literal"><span class="pre">-n</span> <span class="pre">42</span></tt> (二つの引数からなる) と等価になるので、</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">([</span><span class="s">&quot;-n42&quot;</span><span class="p">])</span>
<span class="k">print</span> <span class="n">options</span><span class="o">.</span><span class="n">num</span>
</pre></div>
</div>
<p>は <tt class="docutils literal"><span class="pre">42</span></tt> を出力します。</p>
<p>型を指定しない場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は引数を <tt class="docutils literal"><span class="pre">string</span></tt> であると仮定します。デフォルトのアクションが <tt class="docutils literal"><span class="pre">store</span></tt>
であることも併せて考えると、最初の例はもっと短くなります:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;--file&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;filename&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>保存先 (destination) を指定しない場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はデフォルト値としてオプション文字列から気のきいた名前を設定します:
最初に指定した長い形式のオプション文字列が <tt class="docutils literal"><span class="pre">--foo-bar</span></tt> であれば、デフォルトの保存先は <tt class="docutils literal"><span class="pre">foo_bar</span></tt>
になります。長い形式のオプション文字列がなければ、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は最初に指定した短い形式のオプション文字列を探します:
例えば、 <tt class="docutils literal"><span class="pre">-f</span></tt> に対する保存先は <tt class="docutils literal"><span class="pre">f</span></tt> になります。</p>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> では、 <tt class="docutils literal"><span class="pre">long</span></tt> や <tt class="docutils literal"><span class="pre">complex</span></tt> といった組み込み型も取り入れています。型の追加は
<a class="reference internal" href="#optparse-extending-optparse"><em>optparse の拡張</em></a> で触れています。</p>
</div>
<div class="section" id="optparse-handling-boolean-options">
<span id="id7"></span><h3>15.5.2.3. ブール値 (フラグ) オプションの処理<a class="headerlink" href="#optparse-handling-boolean-options" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>フラグオプション&#8212;特定のオプションに対して真または偽の値の値を設定するオプション&#8212; はよく使われます。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
では、二つのアクション、 <tt class="docutils literal"><span class="pre">store_true</span></tt> および <tt class="docutils literal"><span class="pre">store_false</span></tt> をサポートしています。例えば、 <tt class="docutils literal"><span class="pre">verbose</span></tt>
というフラグを <tt class="docutils literal"><span class="pre">-v</span></tt> で有効にして、 <tt class="docutils literal"><span class="pre">-q</span></tt> で無効にしたいとします:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_false&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>ここでは二つのオプションに同じ保存先を指定していますが、全く問題ありません (下記のように、デフォルト値の設定を少し注意深く行わねばならないだけです)</p>
<p><tt class="docutils literal"><span class="pre">-v</span></tt> をコマンドライン上に見つけると、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は <tt class="docutils literal"><span class="pre">options.verbose</span></tt> を <tt class="docutils literal"><span class="pre">True</span></tt>
に設定します。 <tt class="docutils literal"><span class="pre">-q</span></tt> を見つければ、 <tt class="docutils literal"><span class="pre">options.verbose</span></tt> は <tt class="docutils literal"><span class="pre">False</span></tt> にセットされます。</p>
</div>
<div class="section" id="optparse-other-actions">
<span id="id8"></span><h3>15.5.2.4. その他のアクション<a class="headerlink" href="#optparse-other-actions" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>この他にも、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は以下のようなアクションをサポートしています:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">&quot;store_const&quot;</span></tt></dt>
<dd>定数値を保存します。</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;append&quot;</span></tt></dt>
<dd>オプションの引数を指定のリストに追加します。</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;count&quot;</span></tt></dt>
<dd>指定のカウンタを 1 増やします。</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;callback&quot;</span></tt></dt>
<dd>指定の関数を呼び出します。</dd>
</dl>
<p>これらのアクションについては、 <a class="reference internal" href="#optparse-reference-guide"><em>リファレンスガイド</em></a> 節の「リファレンスガイド」および
<a class="reference internal" href="#optparse-option-callbacks"><em>オプション処理コールバック</em></a> 節で触れます。</p>
</div>
<div class="section" id="optparse-default-values">
<span id="id9"></span><h3>15.5.2.5. デフォルト値<a class="headerlink" href="#optparse-default-values" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>上記の例は全て、何らかのコマンドラインオプションが見つかった時に何らかの変数 (保存先: destination) に値を設定していました。では、該当するオプションが見つからなかった場合には何が起きるのでしょうか？デフォルトは全く与えていないため、これらの値は全て <tt class="docutils literal"><span class="pre">None</span></tt> になります。たいていはこれで十分ですが、もっときちんと制御したい場合もあります。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> では各保存先に対してデフォルト値を指定し、コマンドラインの解析前にデフォルト値が設定されるようにできます。</p>
<p>まず、 verbose/quiet の例について考えてみましょう。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> に対して、 <tt class="docutils literal"><span class="pre">-q</span></tt> がない限り
<tt class="docutils literal"><span class="pre">verbose</span></tt> を <tt class="docutils literal"><span class="pre">True</span></tt> に設定させたいなら、以下のようにします:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_false&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>デフォルトの値は特定のオプションではなく <em>保存先</em> に対して適用されます。また、これら二つのオプションはたまたま同じ保存先を持っているにすぎないため、上のコードは下のコードと全く等価になります:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_false&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>下のような場合を考えてみましょう:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_false&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>やはり <tt class="docutils literal"><span class="pre">verbose</span></tt> のデフォルト値は <tt class="docutils literal"><span class="pre">True</span></tt> になります; 特定の目的変数に対するデフォルト値として有効なのは、最後に指定した値だからです。</p>
<p>デフォルト値をすっきりと指定するには、 <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> の <tt class="xref py py-meth docutils literal"><span class="pre">set_defaults()</span></tt>
メソッドを使います。このメソッドは <tt class="xref py py-meth docutils literal"><span class="pre">parse_args()</span></tt> を呼び出す前ならいつでも使えます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</pre></div>
</div>
<p>前の例と同様、あるオプションの値の保存先に対するデフォルトの値は最後に指定した値になります。コードを読みやすくするため、デフォルト値を設定するときには両方のやり方を混ぜるのではなく、片方だけを使うようにしましょう。</p>
</div>
<div class="section" id="optparse-generating-help">
<span id="id10"></span><h3>15.5.2.6. ヘルプの生成<a class="headerlink" href="#optparse-generating-help" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> にはヘルプと使い方の説明 (usage text) を生成する機能があり、ユーザに優しいコマンドラインインタフェースを作成する上で役立ちます。やらなければならないのは、各オプションに対する <a class="reference internal" href="#optparse.Option.help" title="optparse.Option.help"><tt class="xref py py-attr docutils literal"><span class="pre">help</span></tt></a> の値と、必要ならプログラム全体の使用法を説明する短いメッセージを与えることだけです。</p>
<p>ユーザフレンドリな (ドキュメント付きの) オプションを追加した <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> を以下に示します:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">usage</span> <span class="o">=</span> <span class="s">&quot;usage: %prog [options] arg1 arg2&quot;</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="s">&quot;--verbose&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&quot;make lots of noise [default]&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="s">&quot;--quiet&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_false&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&quot;be vewwy quiet (I&#39;m hunting wabbits)&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;--filename&quot;</span><span class="p">,</span>
                  <span class="n">metavar</span><span class="o">=</span><span class="s">&quot;FILE&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;write output to FILE&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-m&quot;</span><span class="p">,</span> <span class="s">&quot;--mode&quot;</span><span class="p">,</span>
                  <span class="n">default</span><span class="o">=</span><span class="s">&quot;intermediate&quot;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&quot;interaction mode: novice, intermediate, &quot;</span>
                       <span class="s">&quot;or expert [default: </span><span class="si">%d</span><span class="s">efault]&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> がコマンドライン上で <tt class="docutils literal"><span class="pre">-h</span></tt> や <tt class="docutils literal"><span class="pre">--help</span></tt> を見つけた場合や、 <tt class="xref py py-meth docutils literal"><span class="pre">parser.print_help()</span></tt> を呼び出した場合、この <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a>
は以下のようなメッセージを標準出力に出力します。</p>
<div class="highlight-text"><div class="highlight"><pre>Usage: &lt;yourscript&gt; [options] arg1 arg2

Options:
  -h, --help            show this help message and exit
  -v, --verbose         make lots of noise [default]
  -q, --quiet           be vewwy quiet (I&#39;m hunting wabbits)
  -f FILE, --filename=FILE
                        write output to FILE
  -m MODE, --mode=MODE  interaction mode: novice, intermediate, or
                        expert [default: intermediate]
</pre></div>
</div>
<p>(help オプションでヘルプを出力した場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は出力後にプログラムを終了します。)</p>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> ができるだけうまくメッセージを生成するよう手助けするには、他にもまだまだやるべきことがあります:</p>
<ul>
<li><p class="first">スクリプト自体の利用法を表すメッセージを定義します:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">usage</span> <span class="o">=</span> <span class="s">&quot;usage: %prog [options] arg1 arg2&quot;</span>
</pre></div>
</div>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は <tt class="docutils literal"><span class="pre">%prog</span></tt> を現在のプログラム名、すなわち <tt class="docutils literal"><span class="pre">os.path.basename(sys.argv[0])</span></tt>
と置き換えます。この文字列は詳細なオプションヘルプの前に展開され出力されます。</p>
<p>usage の文字列を指定しない場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は型どおりとはいえ気の利いたデフォルト値、
<tt class="docutils literal"><span class="pre">&quot;Usage:</span> <span class="pre">%prog</span> <span class="pre">[options]&quot;</span></tt> を使います。固定引数をとらないスクリプトの場合はこれで十分でしょう。</p>
</li>
<li><p class="first">全てのオプションにヘルプ文字列を定義します。行の折り返しは気にしなくてかまいません &#8212; <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
は行の折り返しに気を配り、見栄えのよいヘルプ出力を生成します。</p>
</li>
<li><p class="first">オプションが値をとるということは自動的に生成されるヘルプメッセージの中で分かります。例えば、&#8221;mode&#8221; option の場合には:</p>
<div class="highlight-python"><pre>-m MODE, --mode=MODE</pre>
</div>
<p>のようになります。</p>
<p>ここで &#8220;MODE&#8221; はメタ変数 (meta-variable) と呼ばれます: メタ変数は、ユーザが
<tt class="docutils literal"><span class="pre">-m</span></tt>/<tt class="docutils literal"><span class="pre">--mode</span></tt> に対して指定するはずの引数を表します。デフォルトでは、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
は保存先の変数名を大文字だけにしたものをメタ変数に使います。これは時として期待通りの結果になりません &#8212;
例えば、上の例の <tt class="docutils literal"><span class="pre">--filename</span></tt> オプションでは明示的に <tt class="docutils literal"><span class="pre">metavar=&quot;FILE&quot;</span></tt> を設定しており、その結果自動生成されたオプション説明テキストは:</p>
<div class="highlight-python"><pre>-f FILE, --filename=FILE</pre>
</div>
<p>のようになります。</p>
<p>この機能の重要さは、単に表示スペースを節約するといった理由にとどまりません:
上の例では、手作業で書いたヘルプテキストの中でメタ変数として <tt class="docutils literal"><span class="pre">FILE</span></tt> を使っています。その結果、ユーザに対してやや堅苦しい表現の書法 <tt class="docutils literal"><span class="pre">-f</span> <span class="pre">FILE</span></tt> と、より平易に意味付けを説明した &#8220;write output to FILE&#8221;
との間に対応があるというヒントを与えています。これは、エンドユーザにとってより明解で便利なヘルプテキストを作成する単純でありながら効果的な手法なのです。</p>
</li>
</ul>
<p class="versionadded">
<span class="versionmodified">バージョン 2.4 で追加: </span>デフォルト値を持つオプションのヘルプ文字列には <tt class="docutils literal"><span class="pre">%default</span></tt> を入れられます &#8212; <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
は <tt class="docutils literal"><span class="pre">%default</span></tt> をデフォルト値の <a class="reference internal" href="functions.html#str" title="str"><tt class="xref py py-func docutils literal"><span class="pre">str()</span></tt></a> で置き換えます。該当するオプションにデフォルト値がない場合 (あるいはデフォルト値が
<tt class="docutils literal"><span class="pre">None</span></tt> である場合) <tt class="docutils literal"><span class="pre">%default</span></tt> の展開結果は <tt class="docutils literal"><span class="pre">none</span></tt> になります。</p>
<div class="section" id="id11">
<h4>15.5.2.6.1. オプションをグループ化する<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>たくさんのオプションを扱う場合、オプションをグループ分けするとヘルプ出力が見やすくなります。 <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> は、複数のオプションをまとめたオプショングループを複数持つことができます。</p>
<p>オプションのグループは、 <a class="reference internal" href="#optparse.OptionGroup" title="optparse.OptionGroup"><tt class="xref py py-class docutils literal"><span class="pre">OptionGroup</span></tt></a> を使って作成します:</p>
<dl class="class">
<dt id="optparse.OptionGroup">
<em class="property">class </em><tt class="descclassname">optparse.</tt><tt class="descname">OptionGroup</tt><big>(</big><em>parser</em>, <em>title</em>, <em>description=None</em><big>)</big><a class="headerlink" href="#optparse.OptionGroup" title="この定義へのパーマリンク">¶</a></dt>
<dd><ul class="simple">
<li><em>parser</em> は、このグループが属する  <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> のインスタンスです</li>
<li><em>title</em> はグループのタイトルです</li>
<li><em>description</em> はオプションで、グループの長い説明です</li>
</ul>
</dd></dl>

<p><a class="reference internal" href="#optparse.OptionGroup" title="optparse.OptionGroup"><tt class="xref py py-class docutils literal"><span class="pre">OptionGroup</span></tt></a> は (<a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> のように) <tt class="xref py py-class docutils literal"><span class="pre">OptionContainer</span></tt>
を継承していて、オプションをグループに追加するために <tt class="xref py py-meth docutils literal"><span class="pre">add_option()</span></tt>
メソッドを利用できます。</p>
<p>全てのオプションを定義したら、 <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> の <tt class="xref py py-meth docutils literal"><span class="pre">add_option_group()</span></tt>
メソッドを使ってグループを定義済みのパーサーに追加します。</p>
<p>前のセクションで定義したパーサーに、続けて <a class="reference internal" href="#optparse.OptionGroup" title="optparse.OptionGroup"><tt class="xref py py-class docutils literal"><span class="pre">OptionGroup</span></tt></a> を追加します:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">group</span> <span class="o">=</span> <span class="n">OptionGroup</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="s">&quot;Dangerous Options&quot;</span><span class="p">,</span>
                    <span class="s">&quot;Caution: use these options at your own risk.  &quot;</span>
                    <span class="s">&quot;It is believed that some of them bite.&quot;</span><span class="p">)</span>
<span class="n">group</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-g&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;Group option.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</pre></div>
</div>
<p>この結果のヘルプ出力は次のようになります。</p>
<div class="highlight-text"><div class="highlight"><pre>Usage: &lt;yourscript&gt; [options] arg1 arg2

Options:
  -h, --help            show this help message and exit
  -v, --verbose         make lots of noise [default]
  -q, --quiet           be vewwy quiet (I&#39;m hunting wabbits)
  -f FILE, --filename=FILE
                        write output to FILE
  -m MODE, --mode=MODE  interaction mode: novice, intermediate, or
                        expert [default: intermediate]

  Dangerous Options:
    Caution: use these options at your own risk.  It is believed that some
    of them bite.

    -g                  Group option.
</pre></div>
</div>
<p>さらにサンプルを拡張して、複数のグループを使うようにしてみます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">group</span> <span class="o">=</span> <span class="n">OptionGroup</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="s">&quot;Dangerous Options&quot;</span><span class="p">,</span>
                    <span class="s">&quot;Caution: use these options at your own risk.  &quot;</span>
                    <span class="s">&quot;It is believed that some of them bite.&quot;</span><span class="p">)</span>
<span class="n">group</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-g&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;Group option.&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

<span class="n">group</span> <span class="o">=</span> <span class="n">OptionGroup</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="s">&quot;Debug Options&quot;</span><span class="p">)</span>
<span class="n">group</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-d&quot;</span><span class="p">,</span> <span class="s">&quot;--debug&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                 <span class="n">help</span><span class="o">=</span><span class="s">&quot;Print debug information&quot;</span><span class="p">)</span>
<span class="n">group</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-s&quot;</span><span class="p">,</span> <span class="s">&quot;--sql&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                 <span class="n">help</span><span class="o">=</span><span class="s">&quot;Print all SQL statements executed&quot;</span><span class="p">)</span>
<span class="n">group</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-e&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;Print every action done&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</pre></div>
</div>
<p>出力結果は次のようになります:</p>
<div class="highlight-text"><div class="highlight"><pre>Usage: &lt;yourscript&gt; [options] arg1 arg2

Options:
  -h, --help            show this help message and exit
  -v, --verbose         make lots of noise [default]
  -q, --quiet           be vewwy quiet (I&#39;m hunting wabbits)
  -f FILE, --filename=FILE
                        write output to FILE
  -m MODE, --mode=MODE  interaction mode: novice, intermediate, or expert
                        [default: intermediate]

  Dangerous Options:
    Caution: use these options at your own risk.  It is believed that some
    of them bite.

    -g                  Group option.

  Debug Options:
    -d, --debug         Print debug information
    -s, --sql           Print all SQL statements executed
    -e                  Print every action done
</pre></div>
</div>
<p>もう1つの、特にオプショングループをプログラムから操作するときに利用できるメソッドがあります:</p>
<dl class="method">
<dt id="optparse.OptionParser.get_option_group">
<tt class="descclassname">OptionParser.</tt><tt class="descname">get_option_group</tt><big>(</big><em>opt_str</em><big>)</big><a class="headerlink" href="#optparse.OptionParser.get_option_group" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><em>opt_str</em> と同じ title か long description を持っている <a class="reference internal" href="#optparse.OptionGroup" title="optparse.OptionGroup"><tt class="xref py py-class docutils literal"><span class="pre">OptionGroup</span></tt></a>
があれば返します。</p>
</dd></dl>

</div>
</div>
<div class="section" id="optparse-printing-version-string">
<span id="id12"></span><h3>15.5.2.7. バージョン番号の出力<a class="headerlink" href="#optparse-printing-version-string" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> では、使用法メッセージと同様にプログラムのバージョン文字列を出力できます。 <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a>
の <tt class="docutils literal"><span class="pre">version</span></tt> 引数に文字列を渡します:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="s">&quot;%prog [-f] [-q]&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;%prog 1.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">%prog</span></tt> は <em>usage</em> と同じような展開を受けます。その他にも <tt class="docutils literal"><span class="pre">version</span></tt> には何でも好きな内容を入れられます。
<tt class="docutils literal"><span class="pre">version</span></tt> を指定した場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は自動的に <tt class="docutils literal"><span class="pre">--version</span></tt> オプションをパーザに渡します。コマンドライン中に <tt class="docutils literal"><span class="pre">--version</span></tt> が見つかると、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は <tt class="docutils literal"><span class="pre">version</span></tt> 文字列を展開して
(<tt class="docutils literal"><span class="pre">%prog</span></tt> を置き換えて) 標準出力に出力し、プログラムを終了します。</p>
<p>例えば、 <tt class="docutils literal"><span class="pre">/usr/bin/foo</span></tt> という名前のスクリプトなら:</p>
<div class="highlight-python"><pre>$ /usr/bin/foo --version
foo 1.0</pre>
</div>
<p>のようになります。</p>
<p>以下の2つのメソッドを、 <tt class="docutils literal"><span class="pre">version</span></tt> 文字列を表示するために利用できます。</p>
<dl class="method">
<dt id="optparse.OptionParser.print_version">
<tt class="descclassname">OptionParser.</tt><tt class="descname">print_version</tt><big>(</big><em>file=None</em><big>)</big><a class="headerlink" href="#optparse.OptionParser.print_version" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>現在のプログラムのバージョン (<tt class="docutils literal"><span class="pre">self.version</span></tt>) を <em>file</em> (デフォルト: stdout)
へ表示します。 <a class="reference internal" href="#optparse.OptionParser.print_usage" title="optparse.OptionParser.print_usage"><tt class="xref py py-meth docutils literal"><span class="pre">print_usage()</span></tt></a> と同じく、 <tt class="docutils literal"><span class="pre">self.version</span></tt> の中の全ての
<tt class="docutils literal"><span class="pre">%prog</span></tt> が現在のプログラム名に置き換えられます。
<tt class="docutils literal"><span class="pre">self.version</span></tt> が空文字列だだったり未定義だったときは何もしません。</p>
</dd></dl>

<dl class="method">
<dt id="optparse.OptionParser.get_version">
<tt class="descclassname">OptionParser.</tt><tt class="descname">get_version</tt><big>(</big><big>)</big><a class="headerlink" href="#optparse.OptionParser.get_version" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#optparse.OptionParser.print_version" title="optparse.OptionParser.print_version"><tt class="xref py py-meth docutils literal"><span class="pre">print_version()</span></tt></a> と同じですが、バージョン文字列を表示する代わりに返します。</p>
</dd></dl>

</div>
<div class="section" id="optparse-how-optparse-handles-errors">
<span id="id13"></span><h3>15.5.2.8. <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> のエラー処理法<a class="headerlink" href="#optparse-how-optparse-handles-errors" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> を使う場合に気を付けねばならないエラーには、大きく分けてプログラマ側のエラーとユーザ側のエラーという二つの種類があります。プログラマ側のエラーの多くは、例えば不正なオプション文字列や定義されていないオプション属性の指定、あるいはオプション属性を指定し忘れるといった、誤った <tt class="docutils literal"><span class="pre">OptionParser.add_option()</span></tt> 呼び出しによるものです。こうした誤りは通常通りに処理されます。すなわち、例外(<tt class="xref py py-exc docutils literal"><span class="pre">optparse.OptionError</span></tt> や <a class="reference internal" href="exceptions.html#exceptions.TypeError" title="exceptions.TypeError"><tt class="xref py py-exc docutils literal"><span class="pre">TypeError</span></tt></a>)
を送出して、プログラムをクラッシュさせます。</p>
<p>もっと重要なのはユーザ側のエラーの処理です。というのも、ユーザの操作エラーというものはコードの安定性に関係なく起こるからです。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は、誤ったオプション引数の指定 (整数を引数にとるオプション
<tt class="docutils literal"><span class="pre">-n</span></tt> に対して <tt class="docutils literal"><span class="pre">-n</span> <span class="pre">4x</span></tt> と指定してしまうなど) や、引数を指定し忘れた場合 (<tt class="docutils literal"><span class="pre">-n</span></tt>
が何らかの引数をとるオプションであるのに、 <tt class="docutils literal"><span class="pre">-n</span></tt> が引数の末尾に来ている場合) といった、ユーザによるエラーを自動的に検出します。また、アプリケーション側で定義されたエラー条件が起きた場合、
<tt class="xref py py-func docutils literal"><span class="pre">OptionParser.error()</span></tt> を呼び出してエラーを通知できます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">a</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">b</span><span class="p">:</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;options -a and -b are mutually exclusive&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>いずれの場合にも <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はエラーを同じやり方で処理します。すなわち、プログラムの使用法メッセージとエラーメッセージを標準エラー出力に出力して、終了ステータス 2 でプログラムを終了させます。</p>
<p>上に挙げた最初の例、すなわち整数を引数にとるオプションにユーザが <tt class="docutils literal"><span class="pre">4x</span></tt> を指定した場合を考えてみましょう:</p>
<div class="highlight-python"><pre>$ /usr/bin/foo -n 4x
Usage: foo [options]

foo: error: option -n: invalid integer value: '4x'</pre>
</div>
<p>値を全く指定しない場合には、以下のようになります:</p>
<div class="highlight-python"><pre>$ /usr/bin/foo -n
Usage: foo [options]

foo: error: -n option requires an argument</pre>
</div>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は、常にエラーを引き起こしたオプションについて説明の入ったエラーメッセージを生成するよう気を配ります;
従って、 <tt class="xref py py-func docutils literal"><span class="pre">OptionParser.error()</span></tt> をアプリケーションコードから呼び出す場合にも、同じようなメッセージになるようにしてください。</p>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> のデフォルトのエラー処理動作が気に入らないのなら、 <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a>
をサブクラス化して、 <tt class="xref py py-meth docutils literal"><span class="pre">exit()</span></tt> かつ/または
<tt class="xref py py-meth docutils literal"><span class="pre">error()</span></tt> をオーバライドする必要があります。</p>
</div>
<div class="section" id="optparse-putting-it-all-together">
<span id="id14"></span><h3>15.5.2.9. 全てをつなぎ合わせる<a class="headerlink" href="#optparse-putting-it-all-together" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> を使ったスクリプトは、通常以下のようになります:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s">&quot;usage: %prog [options] arg&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;--file&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;filename&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&quot;read data from FILENAME&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="s">&quot;--verbose&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="s">&quot;--quiet&quot;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_false&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">)</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;incorrect number of arguments&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;reading </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">filename</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="optparse-reference-guide">
<span id="id15"></span><h2>15.5.3. リファレンスガイド<a class="headerlink" href="#optparse-reference-guide" title="このヘッドラインへのパーマリンク">¶</a></h2>
<span class="target" id="optparse-creating-parser"></span><div class="section" id="parser">
<h3>15.5.3.1. parserを作る<a class="headerlink" href="#parser" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> を使う最初の一歩は OptionParser インスタンスを作ることです。</p>
<dl class="class">
<dt id="optparse.OptionParser">
<em class="property">class </em><tt class="descclassname">optparse.</tt><tt class="descname">OptionParser</tt><big>(</big><em>...</em><big>)</big><a class="headerlink" href="#optparse.OptionParser" title="この定義へのパーマリンク">¶</a></dt>
<dd></dd></dl>

<p>OptionParser のコンストラクタの引数はどれも必須ではありませんが、いくつものキーワード引数がオプションとして使えます。これらはキーワード引数として渡さなければなりません。すなわち、引数が宣言されている順番に頼ってはいけません。</p>
<blockquote>
<div><dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">usage</span></tt> (デフォルト: <tt class="docutils literal"><span class="pre">&quot;%prog</span> <span class="pre">[options]&quot;</span></tt>)</dt>
<dd>プログラムが間違った方法で実行されるかまたはヘルプオプションを付けて実行された場合に表示される使用法です。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は使用法の文字列を表示する際に <tt class="docutils literal"><span class="pre">%prog</span></tt> を <tt class="docutils literal"><span class="pre">os.path.basename(sys.argv[0])</span></tt> (または <tt class="docutils literal"><span class="pre">prog</span></tt>
キーワード引数が指定されていればその値) に展開します。使用法メッセージを抑制するためには特別な
<tt class="xref py py-data docutils literal"><span class="pre">optparse.SUPPRESS_USAGE</span></tt> という値を指定します。</dd>
<dt><tt class="docutils literal"><span class="pre">option_list</span></tt> (デフォルト: <tt class="docutils literal"><span class="pre">[]</span></tt>)</dt>
<dd>パーザに追加する Option オブジェクトのリストです。 <tt class="docutils literal"><span class="pre">option_list</span></tt> の中のオプションは <tt class="docutils literal"><span class="pre">standard_option_list</span></tt>
(OptionParser のサブクラスでセットされる可能性のあるクラス属性) の後に追加されますが、バージョンやヘルプのオプションよりは前になります。このオプションの使用は推奨されません。パーザを作成した後で、 <tt class="xref py py-meth docutils literal"><span class="pre">add_option()</span></tt> を使って追加してください。</dd>
<dt><tt class="docutils literal"><span class="pre">option_class</span></tt> (デフォルト: optparse.Option)</dt>
<dd><tt class="xref py py-meth docutils literal"><span class="pre">add_option()</span></tt> でパーザにオプションを追加するときに使用されるクラス。</dd>
<dt><tt class="docutils literal"><span class="pre">version</span></tt> (デフォルト: <tt class="docutils literal"><span class="pre">None</span></tt>)</dt>
<dd>ユーザがバージョンオプションを与えたときに表示されるバージョン文字列です。 <tt class="docutils literal"><span class="pre">version</span></tt> に真の値を与えると、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
は自動的に単独のオプション文字列 <tt class="docutils literal"><span class="pre">--version</span></tt> とともにバージョンオプションを追加します。部分文字列 <tt class="docutils literal"><span class="pre">%prog</span></tt> は
<tt class="docutils literal"><span class="pre">usage</span></tt> と同様に展開されます。</dd>
<dt><tt class="docutils literal"><span class="pre">conflict_handler</span></tt> (デフォルト: <tt class="docutils literal"><span class="pre">&quot;error&quot;</span></tt>)</dt>
<dd>オプション文字列が衝突するようなオプションがパーザに追加されたときにどうするかを指定します。
<a class="reference internal" href="#optparse-conflicts-between-options"><em>オプション間の衝突</em></a> 節を参照して下さい。</dd>
<dt><tt class="docutils literal"><span class="pre">description</span></tt> (デフォルト: <tt class="docutils literal"><span class="pre">None</span></tt>)</dt>
<dd>プログラムの概要を表す一段落のテキストです。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はユーザがヘルプを要求したときにこの概要を現在のターミナルの幅に合わせて整形し直して表示します (<tt class="docutils literal"><span class="pre">usage</span></tt> の後、オプションリストの前に表示されます)。</dd>
<dt><tt class="docutils literal"><span class="pre">formatter</span></tt> (デフォルト: 新しい <tt class="xref py py-class docutils literal"><span class="pre">IndentedHelpFormatter</span></tt>)</dt>
<dd>ヘルプテキストを表示する際に使われる optparse.HelpFormatter のインスタンスです。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
はこの目的のためにすぐ使えるクラスを二つ提供しています。 IndentedHelpFormatter と TitledHelpFormatter がそれです。</dd>
<dt><tt class="docutils literal"><span class="pre">add_help_option</span></tt> (デフォルト: <tt class="docutils literal"><span class="pre">True</span></tt>)</dt>
<dd>もし真ならば、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はパーザにヘルプオプションを (オプション文字列
<tt class="docutils literal"><span class="pre">-h</span></tt> と <tt class="docutils literal"><span class="pre">--help</span></tt> とともに)追加します。</dd>
<dt><tt class="docutils literal"><span class="pre">prog</span></tt></dt>
<dd><tt class="docutils literal"><span class="pre">usage</span></tt> や <tt class="docutils literal"><span class="pre">version</span></tt> の中の <tt class="docutils literal"><span class="pre">%prog</span></tt> を展開するときに
<tt class="docutils literal"><span class="pre">os.path.basename(sys.argv[0])</span></tt> の代わりに使われる文字列です。</dd>
</dl>
<p><tt class="docutils literal"><span class="pre">epilog</span></tt> (default: <tt class="docutils literal"><span class="pre">None</span></tt>)</p>
<blockquote>
<div>オプションのヘルプの後に表示されるヘルプテキスト.</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="optparse-populating-parser">
<span id="id16"></span><h3>15.5.3.2. パーザへのオプション追加<a class="headerlink" href="#optparse-populating-parser" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>パーザにオプションを加えていくにはいくつか方法があります。推奨するのは <a class="reference internal" href="#optparse-tutorial"><em>チュートリアル</em></a> 節で示したような
meth:<tt class="docutils literal"><span class="pre">OptionParser.add_option()</span></tt> を使う方法です。
<tt class="xref py py-meth docutils literal"><span class="pre">add_option()</span></tt> は以下の二つのうちいずれかの方法で呼び出せます。</p>
<ul class="simple">
<li>(<tt class="xref py py-func docutils literal"><span class="pre">make_option()</span></tt> などが返す) <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> インスタンスを渡します。</li>
<li><tt class="xref py py-func docutils literal"><span class="pre">make_option()</span></tt> に (すなわち <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> のコンストラクタに)
固定引数とキーワード引数の組み合わせを渡して、 <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> インスタンスを生成させます。</li>
</ul>
<p>もう一つの方法は、あらかじめ作成しておいた <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> インスタンスからなるリストを、以下のようにして
<a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> のコンストラクタに渡すというものです:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">option_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">make_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;--filename&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;filename&quot;</span><span class="p">),</span>
    <span class="n">make_option</span><span class="p">(</span><span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="s">&quot;--quiet&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_false&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">option_list</span><span class="o">=</span><span class="n">option_list</span><span class="p">)</span>
</pre></div>
</div>
<p>(<tt class="xref py py-func docutils literal"><span class="pre">make_option()</span></tt> は <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> インスタンスを生成するファクトリ関数です;
現在のところ、この関数は <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> のコンストラクタの別名にすぎません。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> の将来のバージョンでは、 <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> を複数のクラスに分割し、 <tt class="xref py py-func docutils literal"><span class="pre">make_option()</span></tt> は適切なクラスを選んでインスタンスを生成するようになる予定です。従って、 <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> を直接インスタンス化しないでください。)</p>
</div>
<div class="section" id="optparse-defining-options">
<span id="id17"></span><h3>15.5.3.3. オプションの定義<a class="headerlink" href="#optparse-defining-options" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>各々の <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> インスタンス、は <tt class="docutils literal"><span class="pre">-f</span></tt> や <tt class="docutils literal"><span class="pre">--file</span></tt>
といった同義のコマンドラインオプションからなる集合を表現しています。一つの <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> には任意の数のオプションを短い形式でも長い形式でも指定できます。ただし、少なくとも一つは指定せねばなりません。</p>
<p>正しい方法で <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> インスタンスを生成するには、 <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a>
の <tt class="xref py py-meth docutils literal"><span class="pre">add_option()</span></tt> を使います。</p>
<dl class="method">
<dt id="optparse.OptionParser.add_option">
<tt class="descclassname">OptionParser.</tt><tt class="descname">add_option</tt><big>(</big><em>opt_str</em><span class="optional">[</span>, <em>...</em><span class="optional">]</span>, <em>attr=value</em>, <em>...</em><big>)</big><a class="headerlink" href="#optparse.OptionParser.add_option" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>短い形式のオプション文字列を一つだけ持つようなオプションを生成するには次のようにします。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>また、長い形式のオプション文字列を一つだけ持つようなオプションの定義は次のようになります。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--foo&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>キーワード引数は新しい <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> オブジェクトの属性を定義します。オプションの属性のうちでもっとも重要なのは <a class="reference internal" href="#optparse.Option.action" title="optparse.Option.action"><tt class="xref py py-attr docutils literal"><span class="pre">action</span></tt></a> です。この属性は、他のどの属性と関連があるか、そしてどの属性が必要かに大きく作用します。関係のないオプション属性を指定したり、必要な属性を指定し忘れたりすると、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は誤りを解説した <tt class="xref py py-exc docutils literal"><span class="pre">OptionError</span></tt> 例外を送出します。</p>
<p>コマンドライン上にあるオプションが見つかったときの <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> の振舞いを決定しているのは <em>アクション(action)</em> です。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> でハードコードされている標準的なアクションには以下のようなものがあります:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">&quot;store&quot;</span></tt></dt>
<dd>オプションの引数を保存します (デフォルトの動作です)</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;store_const&quot;</span></tt></dt>
<dd>定数を保存します</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;store_true&quot;</span></tt></dt>
<dd>真 (<a class="reference internal" href="constants.html#True" title="True"><tt class="xref py py-const docutils literal"><span class="pre">True</span></tt></a>) を保存します</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;store_false&quot;</span></tt></dt>
<dd>偽 (<a class="reference internal" href="constants.html#False" title="False"><tt class="xref py py-const docutils literal"><span class="pre">False</span></tt></a>) を保存します</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;append&quot;</span></tt></dt>
<dd>オプションの引数をリストに追加します</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;append_const&quot;</span></tt></dt>
<dd>定数をリストに追加します</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;count&quot;</span></tt></dt>
<dd>カウンタを一つ増やします</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;callback&quot;</span></tt></dt>
<dd>指定された関数を呼び出します</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;help&quot;</span></tt></dt>
<dd>全てのオプションとそのドキュメントの入った使用法メッセージを出力します。</dd>
</dl>
<p>(アクションを指定しない場合、デフォルトは <tt class="docutils literal"><span class="pre">&quot;store&quot;</span></tt> になります。このアクションでは、 <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> および <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a>
オプション属性を指定できます。
<a class="reference internal" href="#optparse-standard-option-actions"><em>標準的なオプション・アクション</em></a> を参照してください。)</p>
</dd></dl>

<p>すでにお分かりのように、ほとんどのアクションはどこかに値を保存したり、値を更新したりします。この目的のために、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
は常に特別なオブジェクトを作り出し、それは通常 <tt class="docutils literal"><span class="pre">options</span></tt> と呼ばれます
(<tt class="xref py py-class docutils literal"><span class="pre">optparse.Values</span></tt> のインスタンスになっています)。オプションの引数
(や、その他の様々な値) は、 <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> (保存先:  destination)
オプション属性に従って、 <em>options</em> の属性として保存されます。</p>
<p>例えば、</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</pre></div>
</div>
<p>を呼び出した場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はまず <tt class="docutils literal"><span class="pre">options</span></tt> オブジェクトを生成します:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">options</span> <span class="o">=</span> <span class="n">Values</span><span class="p">()</span>
</pre></div>
</div>
<p>パーザ中で以下のようなオプション</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;--file&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;string&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;filename&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>が定義されていて、パーズしたコマンドラインに以下のいずれかが入っていた場合:</p>
<div class="highlight-python"><pre>-ffoo
-f foo
--file=foo
--file foo</pre>
</div>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はこのオプションを見つけて、</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">options</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;foo&quot;</span>
</pre></div>
</div>
<p>と同等の処理を行います。</p>
<p><a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> および <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> オプション属性は
<a class="reference internal" href="#optparse.Option.action" title="optparse.Option.action"><tt class="xref py py-attr docutils literal"><span class="pre">action</span></tt></a> と同じくらい重要ですが、 <em>全ての</em>
オプションで意味をなすのは <a class="reference internal" href="#optparse.Option.action" title="optparse.Option.action"><tt class="xref py py-attr docutils literal"><span class="pre">action</span></tt></a> だけなのです。</p>
</div>
<div class="section" id="optparse-option-attributes">
<span id="id18"></span><h3>15.5.3.4. オプション属性<a class="headerlink" href="#optparse-option-attributes" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下のオプション属性は <tt class="xref py py-meth docutils literal"><span class="pre">parser.add_option()</span></tt> へのキーワード引数として渡すことができます。特定のオプションに無関係なオプション属性を渡した場合、または必須のオプションを渡しそこなった場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は <tt class="xref py py-exc docutils literal"><span class="pre">OptionError</span></tt>
を送出します。</p>
<dl class="attribute">
<dt id="optparse.Option.action">
<tt class="descclassname">Option.</tt><tt class="descname">action</tt><a class="headerlink" href="#optparse.Option.action" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>(デフォルト: <tt class="docutils literal"><span class="pre">&quot;store&quot;</span></tt>)</p>
<p>このオプションがコマンドラインにあった場合に <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> に何をさせるかを決めます。取りうるオプションについては
<a class="reference internal" href="#optparse-standard-option-actions"><em>こちら</em></a> を参照してください。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.type">
<tt class="descclassname">Option.</tt><tt class="descname">type</tt><a class="headerlink" href="#optparse.Option.type" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>(デフォルト: <tt class="docutils literal"><span class="pre">&quot;string&quot;</span></tt>)</p>
<p>このオプションに与えられる引数の型 (たとえば <tt class="docutils literal"><span class="pre">&quot;string&quot;</span></tt> や <tt class="docutils literal"><span class="pre">&quot;int&quot;</span></tt>)
です。取りうるオプションについては
<a class="reference internal" href="#optparse-standard-option-types"><em>こちら</em></a> を参照してください。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.dest">
<tt class="descclassname">Option.</tt><tt class="descname">dest</tt><a class="headerlink" href="#optparse.Option.dest" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>(デフォルト: オプション文字列を使う)</p>
<p>このオプションのアクションがある値をどこかに書いたり書き換えたりを意味する場合、これは <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> にその書く場所を教えます。詳しく言えば
<a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> には <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> がコマンドラインを解析しながら組み立てる <tt class="docutils literal"><span class="pre">options</span></tt> オブジェクトの属性の名前を指定します。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.default">
<tt class="descclassname">Option.</tt><tt class="descname">default</tt><a class="headerlink" href="#optparse.Option.default" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>コマンドラインに指定がなかったときにこのオプションの対象に使われる値です。
<a class="reference internal" href="#optparse.OptionParser.set_defaults" title="optparse.OptionParser.set_defaults"><tt class="xref py py-meth docutils literal"><span class="pre">OptionParser.set_defaults()</span></tt></a> も参照してください。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.nargs">
<tt class="descclassname">Option.</tt><tt class="descname">nargs</tt><a class="headerlink" href="#optparse.Option.nargs" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>(デフォルト: 1)</p>
<p>このオプションがあったときに幾つの <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> 型の引数が消費されるべきかを指定します。 1 より大きい場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は
<a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> に値のタプルを格納します。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.const">
<tt class="descclassname">Option.</tt><tt class="descname">const</tt><a class="headerlink" href="#optparse.Option.const" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>定数を格納する動作のための、その定数です。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.choices">
<tt class="descclassname">Option.</tt><tt class="descname">choices</tt><a class="headerlink" href="#optparse.Option.choices" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><tt class="docutils literal"><span class="pre">&quot;choice&quot;</span></tt> 型オプションに対してユーザが選べる選択肢となる文字列のリストです。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.callback">
<tt class="descclassname">Option.</tt><tt class="descname">callback</tt><a class="headerlink" href="#optparse.Option.callback" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>アクションが <tt class="docutils literal"><span class="pre">&quot;callback&quot;</span></tt> であるオプションに対し、このオプションがあったときに呼ばれる呼び出し可能オブジェクトです。呼び出し時に渡される引数の詳細については、 <a class="reference internal" href="#optparse-option-callbacks"><em>オプション処理コールバック</em></a> を参照してください。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.callback_args">
<tt class="descclassname">Option.</tt><tt class="descname">callback_args</tt><a class="headerlink" href="#optparse.Option.callback_args" title="この定義へのパーマリンク">¶</a></dt>
<dt id="optparse.Option.callback_kwargs">
<tt class="descclassname">Option.</tt><tt class="descname">callback_kwargs</tt><a class="headerlink" href="#optparse.Option.callback_kwargs" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><tt class="docutils literal"><span class="pre">callback</span></tt> に渡される標準的な4つのコールバック引数の後ろに追加する、位置指定引数とキーワード引数。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.help">
<tt class="descclassname">Option.</tt><tt class="descname">help</tt><a class="headerlink" href="#optparse.Option.help" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>ユーザが <a class="reference internal" href="#optparse.Option.help" title="optparse.Option.help"><tt class="xref py py-attr docutils literal"><span class="pre">help</span></tt></a> オプション(<tt class="docutils literal"><span class="pre">--help</span></tt> のような)を指定したときに表示される、使用可能な全オプションのリストの中のこのオプションに関する説明文です。説明文を提供しておかなければ、オプションは説明文なしで表示されます。オプションを隠すには特殊な値 <tt class="xref py py-data docutils literal"><span class="pre">optparse.SUPPRESS_HELP</span></tt> を使います。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.metavar">
<tt class="descclassname">Option.</tt><tt class="descname">metavar</tt><a class="headerlink" href="#optparse.Option.metavar" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>(デフォルト: オプション文字列から)</p>
<p>説明文を表示する際にオプションの引数の身代わりになるものです。例は <a class="reference internal" href="#optparse-tutorial"><em>チュートリアル</em></a> 節を参照してください。</p>
</dd></dl>

</div>
<div class="section" id="optparse-standard-option-actions">
<span id="id19"></span><h3>15.5.3.5. 標準的なオプション・アクション<a class="headerlink" href="#optparse-standard-option-actions" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>様々なオプション・アクションにはどれも互いに少しづつ異なった条件と作用があります。ほとんどのアクションに関連するオプション属性がいくつかあり、値を指定して <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> の挙動を操作できます。いくつかのアクションには必須の属性があり、必ず値を指定せねばなりません。</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;store&quot;</span></tt> [関連: <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a>, <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a>,
<a class="reference internal" href="#optparse.Option.nargs" title="optparse.Option.nargs"><tt class="xref py py-attr docutils literal"><span class="pre">nargs</span></tt></a>, <a class="reference internal" href="#optparse.Option.choices" title="optparse.Option.choices"><tt class="xref py py-attr docutils literal"><span class="pre">choices</span></tt></a>]</p>
<p>オプションの後には必ず引数が続きます。引数は <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> に従って値に変換されて <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> に保存されます。
<a class="reference internal" href="#optparse.Option.nargs" title="optparse.Option.nargs"><tt class="xref py py-attr docutils literal"><span class="pre">nargs</span></tt></a> &gt; 1 の場合、複数の引数をコマンドラインから取り出します。引数は全て <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> に従って変換され、 <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a>
にタプルとして保存されます。 <a class="reference internal" href="#optparse-standard-option-types"><em>標準のオプション型</em></a> 節を参照してください。</p>
<p><a class="reference internal" href="#optparse.Option.choices" title="optparse.Option.choices"><tt class="xref py py-attr docutils literal"><span class="pre">choices</span></tt></a> を(文字列のリストかタプルで) 指定した場合、型のデフォルト値は <tt class="docutils literal"><span class="pre">&quot;choice&quot;</span></tt> になります。</p>
<p><a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> を指定しない場合、デフォルトの値は <tt class="docutils literal"><span class="pre">&quot;string&quot;</span></tt> です。</p>
<p><a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> を指定しない場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は保存先を最初の長い形式のオプション文字列から導出します
(例えば、 <tt class="docutils literal"><span class="pre">--foo-bar</span></tt> は <tt class="docutils literal"><span class="pre">foo_bar</span></tt> になります)。長い形式のオプション文字列がない場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は最初の短い形式のオプションから保存先の変数名を導出します (<tt class="docutils literal"><span class="pre">-f</span></tt> は <tt class="docutils literal"><span class="pre">f</span></tt> になります)。</p>
<p>例えば:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-f&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-p&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;float&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;point&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>とすると、以下のようなコマンドライン:</p>
<div class="highlight-python"><pre>-f foo.txt -p 1 -3.5 4 -fbar.txt</pre>
</div>
<p>を解析した場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">options</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="s">&quot;foo.txt&quot;</span>
<span class="n">options</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span>
<span class="n">options</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="s">&quot;bar.txt&quot;</span>
</pre></div>
</div>
<p>のように設定を行います。</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;store_const&quot;</span></tt> [関連: <a class="reference internal" href="#optparse.Option.const" title="optparse.Option.const"><tt class="xref py py-attr docutils literal"><span class="pre">const</span></tt></a>; 関連:
<a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a>]</p>
<p>値 <tt class="xref py py-attr docutils literal"><span class="pre">cost</span></tt> を <tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt> に保存します。</p>
<p>例えば:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="s">&quot;--quiet&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_const&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="s">&quot;--verbose&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_const&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--noisy&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_const&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>とします。 <tt class="docutils literal"><span class="pre">--noisy</span></tt> が見つかると、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">options</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
<p>のように設定を行います。</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;store_true&quot;</span></tt> [関連: <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a>]</p>
<p><tt class="docutils literal"><span class="pre">&quot;store_const&quot;</span></tt> の特殊なケースで、真 (True) を <tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt> に保存します。</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;store_false&quot;</span></tt> [関連:<a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a>]</p>
<p><tt class="docutils literal"><span class="pre">&quot;store_true&quot;</span></tt> と似ていて、偽 (False) を保存します。</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--clobber&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;clobber&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--no-clobber&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_false&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;clobber&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;append&quot;</span></tt> [関連: <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a>, <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a>,
<a class="reference internal" href="#optparse.Option.nargs" title="optparse.Option.nargs"><tt class="xref py py-attr docutils literal"><span class="pre">nargs</span></tt></a>, <a class="reference internal" href="#optparse.Option.choices" title="optparse.Option.choices"><tt class="xref py py-attr docutils literal"><span class="pre">choices</span></tt></a>]</p>
<p>このオプションの後ろには必ず引数が続きます。引数は <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> のリストに追加されます。 <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> のデフォルト値を指定しなかった場合、
<a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> がこのオプションを最初にみつけた時点で空のリストを自動的に生成します。
<a class="reference internal" href="#optparse.Option.nargs" title="optparse.Option.nargs"><tt class="xref py py-attr docutils literal"><span class="pre">nargs</span></tt></a> &gt; 1 の場合、複数の引数をコマンドラインから取り出し、長さ <a class="reference internal" href="#optparse.Option.nargs" title="optparse.Option.nargs"><tt class="xref py py-attr docutils literal"><span class="pre">nargs</span></tt></a> のタプルを生成して <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> に追加します。</p>
<p><a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> および <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> のデフォルト値は <tt class="docutils literal"><span class="pre">&quot;store&quot;</span></tt>
アクションと同じです。</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-t&quot;</span><span class="p">,</span> <span class="s">&quot;--tracks&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;append&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;int&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">-t3</span></tt> がコマンドライン上で見つかると、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">options</span><span class="o">.</span><span class="n">tracks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">options</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s">&quot;3&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>と同等の処理を行います。</p>
<p>その後、 <tt class="docutils literal"><span class="pre">--tracks=4</span></tt> が見つかると:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">options</span><span class="o">.</span><span class="n">tracks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s">&quot;4&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>を実行します。</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;append_const&quot;</span></tt> [関連: <a class="reference internal" href="#optparse.Option.const" title="optparse.Option.const"><tt class="xref py py-attr docutils literal"><span class="pre">const</span></tt></a>; 関連:
<a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a>]</p>
<p><tt class="docutils literal"><span class="pre">&quot;store_const&quot;</span></tt> と同様ですが、 <a class="reference internal" href="#optparse.Option.const" title="optparse.Option.const"><tt class="xref py py-attr docutils literal"><span class="pre">const</span></tt></a> の値は
<a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> に追加(append)されます。 <tt class="docutils literal"><span class="pre">&quot;append&quot;</span></tt>
の場合と同じように <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> のデフォルトは <tt class="docutils literal"><span class="pre">None</span></tt>
ですがこのオプションを最初にみつけた時点で空のリストを自動的に生成します。</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;count&quot;</span></tt> [関連: <a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a>]</p>
<p><a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> に保存されている整数値をインクリメントします。
<a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> は (デフォルトの値を指定しない限り)
最初にインクリメントを行う前にゼロに設定されます。</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbosity&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>コマンドライン上で最初に <tt class="docutils literal"><span class="pre">-v</span></tt> が見つかると、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>と同等の処理を行います。</p>
<p>以後、 <tt class="docutils literal"><span class="pre">-v</span></tt> が見つかるたびに、</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">options</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>を実行します。</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;callback&quot;</span></tt> [必須: <a class="reference internal" href="#optparse.Option.callback" title="optparse.Option.callback"><tt class="xref py py-attr docutils literal"><span class="pre">callback</span></tt></a>; 関連:
<a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a>, <a class="reference internal" href="#optparse.Option.nargs" title="optparse.Option.nargs"><tt class="xref py py-attr docutils literal"><span class="pre">nargs</span></tt></a>, <a class="reference internal" href="#optparse.Option.callback_args" title="optparse.Option.callback_args"><tt class="xref py py-attr docutils literal"><span class="pre">callback_args</span></tt></a>,
<a class="reference internal" href="#optparse.Option.callback_kwargs" title="optparse.Option.callback_kwargs"><tt class="xref py py-attr docutils literal"><span class="pre">callback_kwargs</span></tt></a>]</p>
<p><a class="reference internal" href="#optparse.Option.callback" title="optparse.Option.callback"><tt class="xref py py-attr docutils literal"><span class="pre">callback</span></tt></a> に指定された関数を次のように呼び出します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">func</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt_str</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>詳細は、 <a class="reference internal" href="#optparse-option-callbacks"><em>オプション処理コールバック</em></a> 節を参照してください。</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;help&quot;</span></tt></p>
<p>現在のオプションパーザ内の全てのオプションに対する完全なヘルプメッセージを出力します。ヘルプメッセージは <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a>
のコンストラクタに渡した <tt class="docutils literal"><span class="pre">usage</span></tt>  文字列と、各オプションに渡した
<a class="reference internal" href="#optparse.Option.help" title="optparse.Option.help"><tt class="xref py py-attr docutils literal"><span class="pre">help</span></tt></a> 文字列から生成します。</p>
<p>オプションに <a class="reference internal" href="#optparse.Option.help" title="optparse.Option.help"><tt class="xref py py-attr docutils literal"><span class="pre">help</span></tt></a> 文字列が指定されていなくても、オプションはヘルプメッセージ中に列挙されます。オプションを完全に表示させないようにするには、特殊な値 <tt class="xref py py-data docutils literal"><span class="pre">optparse.SUPPRESS_HELP</span></tt> を使ってください。</p>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は全ての <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> に自動的に <a class="reference internal" href="#optparse.Option.help" title="optparse.Option.help"><tt class="xref py py-attr docutils literal"><span class="pre">help</span></tt></a>
オプションを追加するので、通常自分で生成する必要はありません。</p>
<p>例:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span><span class="p">,</span> <span class="n">SUPPRESS_HELP</span>

<span class="c"># 通常、 help オプションは自動的に追加されますが、</span>
<span class="c"># add_help_option 引数を使って抑制することができます。</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">add_help_option</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-h&quot;</span><span class="p">,</span> <span class="s">&quot;--help&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;help&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-v&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&quot;Be moderately verbose&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--file&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;filename&quot;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&quot;Input file to read data from&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--secret&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">SUPPRESS_HELP</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> がコマンドライン上に <tt class="docutils literal"><span class="pre">-h</span></tt> または  <tt class="docutils literal"><span class="pre">--help</span></tt> を見つけると、以下のようなヘルプメッセージを標準出力に出力します
(<tt class="docutils literal"><span class="pre">sys.argv[0]</span></tt> は <tt class="docutils literal"><span class="pre">&quot;foo.py&quot;</span></tt> だとします)。</p>
<div class="highlight-text"><div class="highlight"><pre>Usage: foo.py [options]

Options:
  -h, --help        Show this help message and exit
  -v                Be moderately verbose
  --file=FILENAME   Input file to read data from
</pre></div>
</div>
<p>ヘルプメッセージの出力後、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は <tt class="docutils literal"><span class="pre">sys.exit(0)</span></tt> でプロセスを終了します。</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;version&quot;</span></tt></p>
<p><a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> に指定されているバージョン番号を標準出力に出力して終了します。バージョン番号は、実際には <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> の
<tt class="xref py py-meth docutils literal"><span class="pre">print_version()</span></tt> メソッドで書式化されてから出力されます。通常、 <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> のコンストラクタに <tt class="docutils literal"><span class="pre">version</span></tt> 引数が指定されたときのみ関係のあるアクションです。 <a class="reference internal" href="#optparse.Option.help" title="optparse.Option.help"><tt class="xref py py-attr docutils literal"><span class="pre">help</span></tt></a> オプションと同様、
<a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はこのオプションを必要に応じて自動的に追加するので、
<tt class="docutils literal"><span class="pre">version</span></tt> オプションを作成することはほとんどないでしょう。</p>
</li>
</ul>
</div>
<div class="section" id="optparse-standard-option-types">
<span id="id20"></span><h3>15.5.3.6. 標準のオプション型<a class="headerlink" href="#optparse-standard-option-types" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> には、 <tt class="docutils literal"><span class="pre">&quot;string&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;int&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;long&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;choice&quot;</span></tt>,
<tt class="docutils literal"><span class="pre">&quot;float&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;complex&quot;</span></tt> の 6 種類のビルトインのオプション型があります。新たなオプションの型を追加したければ、 <a class="reference internal" href="#optparse-extending-optparse"><em>optparse の拡張</em></a>
節を参照してください。</p>
<p>文字列オプションの引数はチェックや変換を一切受けません: コマンドライン上のテキストは保存先にそのまま保存されます (またはコールバックに渡されます)。</p>
<p>整数引数 (<tt class="docutils literal"><span class="pre">&quot;int&quot;</span></tt> 型や <tt class="docutils literal"><span class="pre">&quot;long&quot;</span></tt> 型) は次のように読み取られます。</p>
<ul class="simple">
<li>数が <tt class="docutils literal"><span class="pre">0x</span></tt> から始まるならば、16進数として読み取られます</li>
<li>数が <tt class="docutils literal"><span class="pre">0</span></tt> から始まるならば、8進数として読み取られます</li>
<li>数が <tt class="docutils literal"><span class="pre">0b</span></tt> から始まるならば、2進数として読み取られます</li>
<li>それ以外の場合、数は10進数として読み取られます</li>
</ul>
<p>変換は適切な底(2, 8, 10, 16 のどれか)とともに <a class="reference internal" href="functions.html#int" title="int"><tt class="xref py py-func docutils literal"><span class="pre">int()</span></tt></a> または <a class="reference internal" href="functions.html#long" title="long"><tt class="xref py py-func docutils literal"><span class="pre">long()</span></tt></a>
を呼び出すことで行なわれます。この変換が失敗した場合 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> の処理も失敗に終わりますが、より役に立つエラーメッセージを出力します。</p>
<p><tt class="docutils literal"><span class="pre">&quot;float&quot;</span></tt> および <tt class="docutils literal"><span class="pre">&quot;complex&quot;</span></tt> のオプション引数は直接 <a class="reference internal" href="functions.html#float" title="float"><tt class="xref py py-func docutils literal"><span class="pre">float()</span></tt></a> や
<a class="reference internal" href="functions.html#complex" title="complex"><tt class="xref py py-func docutils literal"><span class="pre">complex()</span></tt></a> で変換されます。エラーは同様の扱いです。</p>
<p><tt class="docutils literal"><span class="pre">&quot;choice&quot;</span></tt> オプションは <tt class="docutils literal"><span class="pre">&quot;string&quot;</span></tt> オプションのサブタイプです。
<tt class="xref py py-attr docutils literal"><span class="pre">choice</span></tt> オプションの属性 (文字列からなるシーケンス) には、利用できるオプション引数のセットを指定します。 <tt class="xref py py-func docutils literal"><span class="pre">optparse.check_choice()</span></tt>
はユーザの指定したオプション引数とマスタリストを比較して、無効な文字列が指定された場合には <tt class="xref py py-exc docutils literal"><span class="pre">OptionValueError</span></tt> を送出します。</p>
</div>
<div class="section" id="optparse-parsing-arguments">
<span id="id21"></span><h3>15.5.3.7. 引数の解析<a class="headerlink" href="#optparse-parsing-arguments" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>OptionParser を作成してオプションを追加していく上で大事なポイントは、 <tt class="xref py py-meth docutils literal"><span class="pre">parse_args()</span></tt> メソッドの呼び出しです。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p>ここで入力パラメータは</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">args</span></tt></dt>
<dd>処理する引数のリスト (デフォルト: <tt class="docutils literal"><span class="pre">sys.argv[1:]</span></tt>)</dd>
<dt><tt class="docutils literal"><span class="pre">values</span></tt></dt>
<dd>オプション引数を格納する <tt class="xref py py-class docutils literal"><span class="pre">optparse.Values</span></tt> のオブジェクト
(デフォルト: 新しい <tt class="xref py py-class docutils literal"><span class="pre">Values</span></tt> のインスタンス) &#8211;
既存のオブジェクトを指定した場合、オプションのデフォルトは初期化されません。</dd>
</dl>
<p>であり、戻り値は</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">options</span></tt></dt>
<dd><tt class="docutils literal"><span class="pre">values</span></tt> に渡されたものと同じオブジェクト、または <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
によって生成された optparse.Values インスタンス</dd>
<dt><tt class="docutils literal"><span class="pre">args</span></tt></dt>
<dd>全てのオプションの処理が終わった後で残った位置引数</dd>
</dl>
<p>です。</p>
<p>一番普通の使い方は一切キーワード引数を使わないというものです。
<tt class="docutils literal"><span class="pre">values</span></tt> を指定した場合、それは繰り返される <a class="reference internal" href="functions.html#setattr" title="setattr"><tt class="xref py py-func docutils literal"><span class="pre">setattr()</span></tt></a>
の呼び出し (大雑把に言うと保存される各オプション引数につき一回ずつ) で更新されていき、 <tt class="xref py py-meth docutils literal"><span class="pre">parse_args()</span></tt> で返されます。</p>
<p><tt class="xref py py-meth docutils literal"><span class="pre">parse_args()</span></tt> が引数リストでエラーに遭遇した場合、 OptionParser の <tt class="xref py py-meth docutils literal"><span class="pre">error()</span></tt>
メソッドを適切なエンドユーザ向けのエラーメッセージとともに呼び出します。この呼び出しにより、最終的に終了ステータス 2 (伝統的な Unix
におけるコマンドラインエラーの終了ステータス) でプロセスを終了させることになります。</p>
</div>
<div class="section" id="optparse-querying-manipulating-option-parser">
<span id="id22"></span><h3>15.5.3.8. オプション解析器への問い合わせと操作<a class="headerlink" href="#optparse-querying-manipulating-option-parser" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>オプションパーザのデフォルトの振る舞いは、ある程度カスタマイズすることができます。また、オプションパーザの中を調べることもできます。
<a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> は幾つかのヘルパーメソッドを提供しています。</p>
<dl class="method">
<dt id="optparse.OptionParser.disable_interspersed_args">
<tt class="descclassname">OptionParser.</tt><tt class="descname">disable_interspersed_args</tt><big>(</big><big>)</big><a class="headerlink" href="#optparse.OptionParser.disable_interspersed_args" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>オプションで無い最初の引数を見つけた時点でパースを止めるように設定します。例えば、 <tt class="docutils literal"><span class="pre">-a</span></tt> と <tt class="docutils literal"><span class="pre">-b</span></tt> が両方とも引数を取らないシンプルなオプションだったとすると、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は通常次の構文を受け付け、</p>
<div class="highlight-python"><pre>prog -a arg1 -b arg2</pre>
</div>
<p>それを次と同じように扱います。</p>
<div class="highlight-python"><pre>prog -a -b arg1 arg2</pre>
</div>
<p>この機能を無効にしたいときは、 <a class="reference internal" href="#optparse.OptionParser.disable_interspersed_args" title="optparse.OptionParser.disable_interspersed_args"><tt class="xref py py-meth docutils literal"><span class="pre">disable_interspersed_args()</span></tt></a> メソッドを呼び出してください。古典的な Unix システムのように、最初のオプションでない引数を見つけたときにオプションの解析を止めるようになります。</p>
<p>別のコマンドを実行するコマンドをプロセッサを作成する際、別のコマンドのオプションと自身のオプションが混ざるのを防ぐために利用することができます。例えば、各コマンドがそれぞれ異なるオプションのセットを持つ場合などに有効です。</p>
</dd></dl>

<dl class="method">
<dt id="optparse.OptionParser.enable_interspersed_args">
<tt class="descclassname">OptionParser.</tt><tt class="descname">enable_interspersed_args</tt><big>(</big><big>)</big><a class="headerlink" href="#optparse.OptionParser.enable_interspersed_args" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>オプションで無い最初の引数を見つけてもパースを止めないように設定します。オプションとコマンド引数の順序が混ざっても良いようになります。これはデフォルトの動作です。</p>
</dd></dl>

<dl class="method">
<dt id="optparse.OptionParser.get_option">
<tt class="descclassname">OptionParser.</tt><tt class="descname">get_option</tt><big>(</big><em>opt_str</em><big>)</big><a class="headerlink" href="#optparse.OptionParser.get_option" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>オプション文字列 <tt class="docutils literal"><span class="pre">opt_str</span></tt> に対する <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> インスタンスを返します。該当するオプションがなければ <tt class="docutils literal"><span class="pre">None</span></tt> を返します。</p>
</dd></dl>

<dl class="method">
<dt id="optparse.OptionParser.has_option">
<tt class="descclassname">OptionParser.</tt><tt class="descname">has_option</tt><big>(</big><em>opt_str</em><big>)</big><a class="headerlink" href="#optparse.OptionParser.has_option" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> に(<tt class="docutils literal"><span class="pre">-q</span></tt> や <tt class="docutils literal"><span class="pre">--verbose</span></tt> のような) オプション
<tt class="docutils literal"><span class="pre">opt_str</span></tt> がある場合、真を返します。</p>
</dd></dl>

<dl class="method">
<dt id="optparse.OptionParser.remove_option">
<tt class="descclassname">OptionParser.</tt><tt class="descname">remove_option</tt><big>(</big><em>opt_str</em><big>)</big><a class="headerlink" href="#optparse.OptionParser.remove_option" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> に <tt class="docutils literal"><span class="pre">opt_str</span></tt> に対応するオプションがある場合、そのオプションを削除します。該当するオプションに他のオプション文字列が指定されていた場合、それらのオプション文字列は全て無効になります。
<em>opt_str</em> がこの <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> オブジェクトのどのオプションにも属さない場合、 <a class="reference internal" href="exceptions.html#exceptions.ValueError" title="exceptions.ValueError"><tt class="xref py py-exc docutils literal"><span class="pre">ValueError</span></tt></a> を送出します。</p>
</dd></dl>

</div>
<div class="section" id="optparse-conflicts-between-options">
<span id="id23"></span><h3>15.5.3.9. オプション間の衝突<a class="headerlink" href="#optparse-conflicts-between-options" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>注意が足りないと、衝突するオプションを定義してしまうことがあります。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="s">&quot;--dry-run&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="s">&quot;--noisy&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>(とりわけ、 <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> から標準的なオプションを備えた自前のサブクラスを定義してしまった場合にはよく起きます。)</p>
<p>ユーザがオプションを追加するたびに、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は既存のオプションとの衝突がないかチェックします。何らかの衝突が見付かると、現在設定されている衝突処理メカニズムを呼び出します。衝突処理メカニズムはコンストラクタ中で呼び出せます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">conflict_handler</span><span class="o">=</span><span class="n">handler</span><span class="p">)</span>
</pre></div>
</div>
<p>個別にも呼び出せます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">set_conflict_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</pre></div>
</div>
<p>衝突時の処理をおこなうハンドラ(handler)には、以下のものが利用できます:</p>
<blockquote>
<div><dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">&quot;error&quot;</span></tt> (デフォルトの設定)</dt>
<dd>オプション間の衝突をプログラム上のエラーとみなし、
<tt class="xref py py-exc docutils literal"><span class="pre">OptionConflictError</span></tt> を送出します。</dd>
<dt><tt class="docutils literal"><span class="pre">&quot;resolve&quot;</span></tt></dt>
<dd>オプション間の衝突をインテリジェントに解決します (下記参照)。</dd>
</dl>
</div></blockquote>
<p>一例として、衝突をインテリジェントに解決する <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> を定義し、衝突を起こすようなオプションを追加してみましょう:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">conflict_handler</span><span class="o">=</span><span class="s">&quot;resolve&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="s">&quot;--dry-run&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;do no harm&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="s">&quot;--noisy&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;be noisy&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>この時点で、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はすでに追加済のオプションがオプション文字列 <tt class="docutils literal"><span class="pre">-n</span></tt> を使っていることを検出します。
<tt class="docutils literal"><span class="pre">conflict_handler</span></tt> が <tt class="docutils literal"><span class="pre">&quot;resolve&quot;</span></tt> なので、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は既に追加済のオプションリストの方から
<tt class="docutils literal"><span class="pre">-n</span></tt> を除去して問題を解決します。従って、 <tt class="docutils literal"><span class="pre">-n</span></tt> の除去されたオプションは <tt class="docutils literal"><span class="pre">--dry-run</span></tt> だけでしか有効にできなくなります。ユーザがヘルプ文字列を要求した場合、問題解決の結果を反映したメッセージが出力されます:</p>
<div class="highlight-python"><pre>Options:
  --dry-run     do no harm
  [...]
  -n, --noisy   be noisy</pre>
</div>
<p>これまでに追加したオプション文字列を跡形もなく削り去り、ユーザがそのオプションをコマンドラインから起動する手段をなくせます。この場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はオプションを完全に除去してしまうので、こうしたオプションはヘルプテキストやその他のどこにも表示されなくなります。例えば、現在の <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> の場合、以下の操作:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--dry-run&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;new dry-run option&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>を行った時点で、最初の <tt class="docutils literal"><span class="pre">-n</span></tt>/<tt class="docutils literal"><span class="pre">--dry-run</span></tt> オプションはもはやアクセスできなくなります。このため、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はオプションを消去してしまい、ヘルプテキスト:</p>
<div class="highlight-python"><pre>Options:
  [...]
  -n, --noisy   be noisy
  --dry-run     new dry-run option</pre>
</div>
<p>だけが残ります。</p>
</div>
<div class="section" id="optparse-cleanup">
<span id="id24"></span><h3>15.5.3.10. クリーンアップ<a class="headerlink" href="#optparse-cleanup" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>OptionParser インスタンスはいくつかの循環参照を抱えています。このことは Python のガーベジコレクタにとって問題になるわけではありませんが、使い終わった OptionParser に対して <tt class="xref py py-meth docutils literal"><span class="pre">destroy()</span></tt>
を呼び出すことでこの循環参照を意図的に断ち切るという方法を選ぶこともできます。この方法は特に長時間実行するアプリケーションで OptionParser から大きなオブジェクトグラフが到達可能になっているような場合に有用です。</p>
</div>
<div class="section" id="optparse-other-methods">
<span id="id25"></span><h3>15.5.3.11. その他のメソッド<a class="headerlink" href="#optparse-other-methods" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>OptionParser にはその他にも幾つかの公開されたメソッドがあります:</p>
<dl class="method">
<dt id="optparse.OptionParser.set_usage">
<tt class="descclassname">OptionParser.</tt><tt class="descname">set_usage</tt><big>(</big><em>usage</em><big>)</big><a class="headerlink" href="#optparse.OptionParser.set_usage" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>上で説明したコンストラクタの <tt class="docutils literal"><span class="pre">usage</span></tt> キーワード引数での規則に従った使用法の文字列をセットします。 <tt class="docutils literal"><span class="pre">None</span></tt> を渡すとデフォルトの使用法文字列が使われるようになり、 <tt class="xref py py-data docutils literal"><span class="pre">optparse.SUPPRESS_USAGE</span></tt> によって使用法メッセージを抑制できます。</p>
</dd></dl>

<dl class="method">
<dt id="optparse.OptionParser.print_usage">
<tt class="descclassname">OptionParser.</tt><tt class="descname">print_usage</tt><big>(</big><em>file=None</em><big>)</big><a class="headerlink" href="#optparse.OptionParser.print_usage" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>現在のプログラムの使用法メッセージ (<tt class="docutils literal"><span class="pre">self.usage</span></tt>) を <em>file</em> (デフォルト:
stdout) に表示します。 <tt class="docutils literal"><span class="pre">self.usage</span></tt> 内にある全ての <tt class="docutils literal"><span class="pre">%prog</span></tt> という文字列は現在のプログラム名に置換されます。 <tt class="docutils literal"><span class="pre">self.usage</span></tt> が空もしくは未定義の時は何もしません。</p>
</dd></dl>

<dl class="method">
<dt id="optparse.OptionParser.get_usage">
<tt class="descclassname">OptionParser.</tt><tt class="descname">get_usage</tt><big>(</big><big>)</big><a class="headerlink" href="#optparse.OptionParser.get_usage" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#optparse.OptionParser.print_usage" title="optparse.OptionParser.print_usage"><tt class="xref py py-meth docutils literal"><span class="pre">print_usage()</span></tt></a> と同じですが、使用法メッセージを表示する代わりに文字列として返します。</p>
</dd></dl>

<dl class="method">
<dt id="optparse.OptionParser.set_defaults">
<tt class="descclassname">OptionParser.</tt><tt class="descname">set_defaults</tt><big>(</big><em>dest=value</em>, <em>...</em><big>)</big><a class="headerlink" href="#optparse.OptionParser.set_defaults" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>幾つかの保存先に対してデフォルト値をまとめてセットします。
<a class="reference internal" href="#optparse.OptionParser.set_defaults" title="optparse.OptionParser.set_defaults"><tt class="xref py py-meth docutils literal"><span class="pre">set_defaults()</span></tt></a> を使うのは複数のオプションにデフォルト値をセットする好ましいやり方です。複数のオプションが同じ保存先を共有することがあり得るからです。たとえば幾つかの &#8220;mode&#8221; オプションが全て同じ保存先をセットするものだったとすると、どのオプションもデフォルトをセットすることができ、しかし最後に指定したものだけが有効になります。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--advanced&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_const&quot;</span><span class="p">,</span>
                  <span class="n">dest</span><span class="o">=</span><span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="s">&quot;advanced&quot;</span><span class="p">,</span>
                  <span class="n">default</span><span class="o">=</span><span class="s">&quot;novice&quot;</span><span class="p">)</span>    <span class="c"># overridden below</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--novice&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_const&quot;</span><span class="p">,</span>
                  <span class="n">dest</span><span class="o">=</span><span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="s">&quot;novice&quot;</span><span class="p">,</span>
                  <span class="n">default</span><span class="o">=</span><span class="s">&quot;advanced&quot;</span><span class="p">)</span>  <span class="c"># overrides above setting</span>
</pre></div>
</div>
<p>こうした混乱を避けるために <a class="reference internal" href="#optparse.OptionParser.set_defaults" title="optparse.OptionParser.set_defaults"><tt class="xref py py-meth docutils literal"><span class="pre">set_defaults()</span></tt></a> を使います。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&quot;advanced&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--advanced&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_const&quot;</span><span class="p">,</span>
                  <span class="n">dest</span><span class="o">=</span><span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="s">&quot;advanced&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--novice&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_const&quot;</span><span class="p">,</span>
                  <span class="n">dest</span><span class="o">=</span><span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="s">&quot;novice&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
<div class="section" id="optparse-option-callbacks">
<span id="id26"></span><h2>15.5.4. オプション処理コールバック<a class="headerlink" href="#optparse-option-callbacks" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> の組み込みのアクションや型が望みにかなったものでない場合、二つの選択肢があります: 一つは <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
の拡張、もう一つは callback オプションの定義です。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> の拡張は汎用性に富んでいますが、単純なケースに対していささか大げさでもあります。大体は簡単なコールバックで事足りるでしょう。</p>
<p><tt class="docutils literal"><span class="pre">callback</span></tt> オプションの定義は二つのステップからなります:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">&quot;callback&quot;</span></tt> アクションを使ってオプション自体を定義する。</li>
<li>コールバックを書く。コールバックは少なくとも後で説明する 4 つの引数をとる関数
(またはメソッド) でなければなりません。</li>
</ul>
<div class="section" id="callback">
<span id="optparse-defining-callback-option"></span><h3>15.5.4.1. callbackオプションの定義<a class="headerlink" href="#callback" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>callback オプションを最も簡単に定義するには、 <a class="reference internal" href="#optparse.OptionParser.add_option" title="optparse.OptionParser.add_option"><tt class="xref py py-meth docutils literal"><span class="pre">OptionParser.add_option()</span></tt></a>
メソッドを使います。 <a class="reference internal" href="#optparse.Option.action" title="optparse.Option.action"><tt class="xref py py-attr docutils literal"><span class="pre">action</span></tt></a> の他に指定しなければならない属性は
<tt class="docutils literal"><span class="pre">callback</span></tt> すなわちコールバックする関数自体です:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;callback&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">my_callback</span><span class="p">)</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">callback</span></tt> は関数 (または呼び出し可能オブジェクト)なので、callback オプションを定義する時にはあらかじめ
<tt class="docutils literal"><span class="pre">my_callback()</span></tt> を定義しておかねばなりません。この単純なケースでは、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は <tt class="docutils literal"><span class="pre">-c</span></tt> が何らかの引数をとるかどうか判別できず、通常は <tt class="docutils literal"><span class="pre">c</span></tt> が引数を伴わないことを意味します &#8212; 知りたいことはただ単に
<a class="reference internal" href="../using/cmdline.html#cmdoption-c"><em class="xref std std-option">-c</em></a> がコマンドライン上に現れたどうかだけです。とはいえ、場合によっては、自分のコールバック関数に任意の個数のコマンドライン引数を消費させたいこともあるでしょう。これがコールバック関数をトリッキーなものにしています;
これについてはこの節の後の方で説明します。</p>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は常に四つの引数をコールバックに渡し、その他には
<tt class="xref py py-attr docutils literal"><span class="pre">Optioncallback_args</span></tt> および <tt class="xref py py-attr docutils literal"><span class="pre">callback_kwargs</span></tt> で指定した追加引数しか渡しません。従って、最小のコールバック関数シグネチャは:</p>
<div class="highlight-python"><pre>def my_callback(option, opt, value, parser):</pre>
</div>
<p>のようになります。</p>
<p>コールバックの四つの引数については後で説明します。</p>
<p>callback オプションを定義する場合には、他にもいくつかオプション属性を指定できます:</p>
<dl class="docutils">
<dt><a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a></dt>
<dd>他で使われているのと同じ意味です: <tt class="docutils literal"><span class="pre">store</span></tt> や <tt class="docutils literal"><span class="pre">append</span></tt> アクションの時と同じく、この属性は <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> に引数を一つ消費して <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> で指定した型に変換させます。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は変換後の値をどこかに保存する代わりにコールバック関数に渡します。</dd>
<dt><a class="reference internal" href="#optparse.Option.nargs" title="optparse.Option.nargs"><tt class="xref py py-attr docutils literal"><span class="pre">nargs</span></tt></a></dt>
<dd>これも他で使われているのと同じ意味です: このオプションが指定されていて、かつ
<tt class="docutils literal"><span class="pre">nargs</span></tt> &gt; 1 である場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は <tt class="docutils literal"><span class="pre">nargs</span></tt> 個の引数を消費します。このとき各引数は <a class="reference internal" href="functions.html#type" title="type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> 型に変換できねばなりません。変換後の値はタプルとしてコールバックに渡されます。</dd>
<dt><a class="reference internal" href="#optparse.Option.callback_args" title="optparse.Option.callback_args"><tt class="xref py py-attr docutils literal"><span class="pre">callback_args</span></tt></a></dt>
<dd>その他の位置指定引数からなるタプルで、コールバックに渡されます。</dd>
<dt><a class="reference internal" href="#optparse.Option.callback_kwargs" title="optparse.Option.callback_kwargs"><tt class="xref py py-attr docutils literal"><span class="pre">callback_kwargs</span></tt></a></dt>
<dd>その他のキーワード引数からなる辞書で、コールバックに渡されます。</dd>
</dl>
</div>
<div class="section" id="optparse-how-callbacks-called">
<span id="id27"></span><h3>15.5.4.2. コールバック関数はどのように呼び出されるか<a class="headerlink" href="#optparse-how-callbacks-called" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>コールバックは全て以下の形式で呼び出されます:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">func</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt_str</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>ここで、</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">option</span></tt></dt>
<dd>コールバックを呼び出している <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> のインスタンスです。</dd>
<dt><tt class="docutils literal"><span class="pre">opt_str</span></tt></dt>
<dd>は、コールバック呼び出しのきっかけとなったコマンドライン上のオプション文字列です。 (長い形式のオプションに対する省略形が使われている場合、 <em>opt</em>
は完全な、正式な形のオプション文字列となります &#8212;  例えば、ユーザが <em class="xref std std-option">--foobar</em> の短縮形として <tt class="docutils literal"><span class="pre">--foo</span></tt>
をコマンドラインに入力した時には、 <em>opt_str</em>  は <tt class="docutils literal"><span class="pre">&quot;--foobar&quot;</span></tt> となります。)</dd>
<dt><tt class="docutils literal"><span class="pre">value</span></tt></dt>
<dd>オプションの引数で、コマンドライン上に見つかったものです。
<a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は、 <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> が設定されている場合、単一の引数しかとりません。 <tt class="docutils literal"><span class="pre">value</span></tt> の型はオプションの型として指定された型になります。このオプションに対する <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> が <tt class="docutils literal"><span class="pre">None</span></tt> である(引数なしの) 場合、 <tt class="docutils literal"><span class="pre">value</span></tt> は <tt class="docutils literal"><span class="pre">None</span></tt> になります。
<a class="reference internal" href="#optparse.Option.nargs" title="optparse.Option.nargs"><tt class="xref py py-attr docutils literal"><span class="pre">nargs</span></tt></a> &gt; 1 であれば、 <tt class="docutils literal"><span class="pre">value</span></tt> は適切な型をもつ値のタプルになります。</dd>
<dt><tt class="docutils literal"><span class="pre">parser</span></tt></dt>
<dd><p class="first">現在のオプション解析の全てを駆動している <a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a>  インスタンスです。この変数が有用なのは、この値を介してインスタンス属性としていくつかの興味深いデータにアクセスできるからです:</p>
<dl class="last docutils">
<dt><tt class="docutils literal"><span class="pre">parser.largs</span></tt></dt>
<dd>現在放置されている引数、すなわち、すでに消費されたものの、オプションでもオプション引数でもない引数からなるリストです。 <tt class="docutils literal"><span class="pre">parser.largs</span></tt>
は自由に変更でき、たとえば引数を追加したりできます (このリストは <tt class="docutils literal"><span class="pre">args</span></tt> 、すなわち <tt class="xref py py-meth docutils literal"><span class="pre">parse_args()</span></tt>
の二つ目の戻り値になります)</dd>
<dt><tt class="docutils literal"><span class="pre">parser.rargs</span></tt></dt>
<dd>現在残っている引数、すなわち、 <tt class="docutils literal"><span class="pre">opt_str</span></tt> および <tt class="docutils literal"><span class="pre">value</span></tt> があれば除き、それ以外の引数が残っているリストです。
<tt class="docutils literal"><span class="pre">parser.rargs</span></tt> は自由に変更でき、例えばさらに引数を消費したりできます。</dd>
<dt><tt class="docutils literal"><span class="pre">parser.values</span></tt></dt>
<dd>オプションの値がデフォルトで保存されるオブジェクト (<tt class="docutils literal"><span class="pre">optparse.OptionValues</span></tt> のインスタンス)
です。この値を使うと、コールバック関数がオプションの値を記憶するために、他の <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
と同じ機構を使えるようにするため、グローバル変数や閉包 (closure) を台無しにしないので便利です。コマンドライン上にすでに現れているオプションの値にもアクセスできます。</dd>
</dl>
</dd>
<dt><tt class="docutils literal"><span class="pre">args</span></tt></dt>
<dd><a class="reference internal" href="#optparse.Option.callback_args" title="optparse.Option.callback_args"><tt class="xref py py-attr docutils literal"><span class="pre">callback_args</span></tt></a> オプション属性で与えられた任意の固定引数からなるタプルです。</dd>
<dt><tt class="docutils literal"><span class="pre">kwargs</span></tt></dt>
<dd><a class="reference internal" href="#optparse.Option.callback_kwargs" title="optparse.Option.callback_kwargs"><tt class="xref py py-attr docutils literal"><span class="pre">callback_kwargs</span></tt></a> オプション属性で与えられた任意のキーワード引数からなるタプルです。</dd>
</dl>
</div>
<div class="section" id="optparse-raising-errors-in-callback">
<span id="id28"></span><h3>15.5.4.3. コールバック中で例外を送出する<a class="headerlink" href="#optparse-raising-errors-in-callback" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>オプション自体か、あるいはその引数に問題がある場合、コールバック関数は <tt class="xref py py-exc docutils literal"><span class="pre">OptionValueError</span></tt>
を送出せねばなりません。 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> はこの例外をとらえてプログラムを終了させ、ユーザが指定しておいたエラーメッセージを標準エラー出力に出力します。エラーメッセージは明確、簡潔かつ正確で、どのオプションに誤りがあるかを示さねばなりません。さもなければ、ユーザは自分の操作のどこに問題があるかを解決するのに苦労することになります。</p>
</div>
<div class="section" id="optparse-callback-example-1">
<span id="id29"></span><h3>15.5.4.4. コールバックの例 1: ありふれたコールバック<a class="headerlink" href="#optparse-callback-example-1" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>引数をとらず、発見したオプションを単に記録するだけのコールバックオプションの例を以下に示します:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">record_foo_seen</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt_str</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">saw_foo</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--foo&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;callback&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">record_foo_seen</span><span class="p">)</span>
</pre></div>
</div>
<p>もちろん、 <tt class="docutils literal"><span class="pre">&quot;store_true&quot;</span></tt> アクションを使っても実現できます。</p>
</div>
<div class="section" id="optparse-callback-example-2">
<span id="id30"></span><h3>15.5.4.5. コールバックの例 2: オプションの順番をチェックする<a class="headerlink" href="#optparse-callback-example-2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>もう少し面白みのある例を示します: この例では、 <tt class="docutils literal"><span class="pre">-b</span></tt> を発見して、その後で
<tt class="docutils literal"><span class="pre">-a</span></tt> がコマンドライン中に現れた場合にはエラーになります。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_order</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt_str</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">b</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">OptionValueError</span><span class="p">(</span><span class="s">&quot;can&#39;t use -a after -b&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-a&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;callback&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">check_order</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-b&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;b&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="optparse-callback-example-3">
<span id="id31"></span><h3>15.5.4.6. コールバックの例 3: オプションの順番をチェックする (汎用的)<a class="headerlink" href="#optparse-callback-example-3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>このコールバック (フラグを立てるが、 <tt class="docutils literal"><span class="pre">-b</span></tt> が既に指定されていればエラーになる)
を同様の複数のオプションに対して再利用したければ、もう少し作業する必要があります: エラーメッセージとセットされるフラグを一般化しなければなりません。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_order</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt_str</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">b</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">OptionValueError</span><span class="p">(</span><span class="s">&quot;can&#39;t use </span><span class="si">%s</span><span class="s"> after -b&quot;</span> <span class="o">%</span> <span class="n">opt_str</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-a&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;callback&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">check_order</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-b&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;b&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;callback&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">check_order</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="optparse-callback-example-4">
<span id="id32"></span><h3>15.5.4.7. コールバックの例 4: 任意の条件をチェックする<a class="headerlink" href="#optparse-callback-example-4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>もちろん、単に定義済みのオプションの値を調べるだけにとどまらず、コールバックには任意の条件を入れられます。例えば、満月でなければ呼び出してはならないオプションがあるとしましょう。やらなければならないことはこれだけです:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_moon</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt_str</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_moon_full</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">OptionValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> option invalid when moon is full&quot;</span>
                               <span class="o">%</span> <span class="n">opt_str</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--foo&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;callback&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">check_moon</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(<tt class="docutils literal"><span class="pre">is_moon_full()</span></tt> の定義は読者への課題としましょう。</p>
</div>
<div class="section" id="optparse-callback-example-5">
<span id="id33"></span><h3>15.5.4.8. コールバックの例5: 固定引数<a class="headerlink" href="#optparse-callback-example-5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>決まった数の引数をとるようなコールパックオプションを定義するなら、問題はやや興味深くなってきます。引数をとるようコールバックに指定するのは、 <tt class="docutils literal"><span class="pre">&quot;store&quot;</span></tt>
や <tt class="docutils literal"><span class="pre">&quot;append&quot;</span></tt> オプションの定義に似ています。 <a class="reference internal" href="#optparse.Option.type" title="optparse.Option.type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> を定義していれば、そのオプションは引数を受け取ったときに該当する型に変換できねばなりません。さらに <a class="reference internal" href="#optparse.Option.nargs" title="optparse.Option.nargs"><tt class="xref py py-attr docutils literal"><span class="pre">nargs</span></tt></a> を指定すれば、オプションは
<a class="reference internal" href="#optparse.Option.nargs" title="optparse.Option.nargs"><tt class="xref py py-attr docutils literal"><span class="pre">nargs</span></tt></a> 個の引数を受け取ります。</p>
<p>標準の <tt class="docutils literal"><span class="pre">&quot;store&quot;</span></tt> アクションをエミュレートする例を以下に示します:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">store_value</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt_str</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;--foo&quot;</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&quot;callback&quot;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">store_value</span><span class="p">,</span>
                  <span class="nb">type</span><span class="o">=</span><span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> は 3 個の引数を受け取り、それらを整数に変換するところまで面倒をみてくれます。ユーザは単にそれを保存するだけです。
(他の処理もできます; いうまでもなく、この例にはコールバックは必要ありません)</p>
</div>
<div class="section" id="optparse-callback-example-6">
<span id="id34"></span><h3>15.5.4.9. コールバックの例6: 可変個の引数<a class="headerlink" href="#optparse-callback-example-6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>あるオプションに可変個の引数を持たせたいと考えているなら、問題はいささか手強くなってきます。この場合、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
では該当する組み込みのオプション解析機能を提供していないので、自分でコールバックを書かねばなりません。さらに、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
が普段処理している、伝統的な Unix コマンドライン解析における難題を自分で解決せねばなりません。とりわけ、コールバック関数では引数が裸の <tt class="docutils literal"><span class="pre">--</span></tt>
や <tt class="docutils literal"><span class="pre">-</span></tt> の場合における慣習的な処理規則:</p>
<ul class="simple">
<li>either <tt class="docutils literal"><span class="pre">--</span></tt> or <tt class="docutils literal"><span class="pre">-</span></tt> can be option arguments</li>
<li>裸の <tt class="docutils literal"><span class="pre">--</span></tt> (何らかのオプションの引数でない場合): コマンドライン処理を停止し、 <tt class="docutils literal"><span class="pre">--</span></tt> を無視します。</li>
<li>裸の <tt class="docutils literal"><span class="pre">-</span></tt> (何らかのオプションの引数でない場合): コマンドライン処理を停止しますが、 <tt class="docutils literal"><span class="pre">-</span></tt> は残します
(<tt class="docutils literal"><span class="pre">parser.largs</span></tt> に追加します)。</li>
</ul>
<p>を実装せねばなりません。</p>
<p>オプションが可変個の引数をとるようにさせたいなら、いくつかの巧妙で厄介な問題に配慮しなければなりません。どういう実装をとるかは、アプリケーションでどのようなトレードオフを考慮するかによります (このため、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> では可変個の引数に関する問題を直接的に取り扱わないのです)。</p>
<p>とはいえ、可変個の引数をもつオプションに対するスタブ (stub、仲介インタフェース) を以下に示しておきます:</p>
<div class="highlight-python"><pre> def vararg_callback(option, opt_str, value, parser):
     assert value is None
     value = []

     def floatable(str):
         try:
             float(str)
             return True
         except ValueError:
             return False

     for arg in parser.rargs:
         # stop on --foo like options
         if arg[:2] == "--" and len(arg) &gt; 2:
             break
         # stop on -a, but not on -3 or -3.0
         if arg[:1] == "-" and len(arg) &gt; 1 and not floatable(arg):
             break
         value.append(arg)

     del parser.rargs[:len(value)]
     setattr(parser.values, option.dest, value)

[...]
parser.add_option("-c", "--callback", dest="vararg_attr",
                  action="callback", callback=vararg_callback)</pre>
</div>
</div>
</div>
<div class="section" id="optparse-extending-optparse">
<span id="id35"></span><h2>15.5.5. <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> の拡張<a class="headerlink" href="#optparse-extending-optparse" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> がコマンドラインオプションをどのように解釈するかを決める二つの重要な要素はそれぞれのオプションのアクションと型なので、拡張の方向は新しいアクションと型を追加することになると思います。</p>
<div class="section" id="optparse-adding-new-types">
<span id="id36"></span><h3>15.5.5.1. 新しい型の追加<a class="headerlink" href="#optparse-adding-new-types" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>新しい型を追加するためには、 <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> の <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> クラスのサブクラスを自身で定義する必要があります。このクラスには
<a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> における型を定義する一対の属性があります。それは
<a class="reference internal" href="#optparse.Option.TYPES" title="optparse.Option.TYPES"><tt class="xref py py-attr docutils literal"><span class="pre">TYPES</span></tt></a> と <a class="reference internal" href="#optparse.Option.TYPE_CHECKER" title="optparse.Option.TYPE_CHECKER"><tt class="xref py py-attr docutils literal"><span class="pre">TYPE_CHECKER</span></tt></a> です。</p>
<dl class="attribute">
<dt id="optparse.Option.TYPES">
<tt class="descclassname">Option.</tt><tt class="descname">TYPES</tt><a class="headerlink" href="#optparse.Option.TYPES" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#optparse.Option.TYPES" title="optparse.Option.TYPES"><tt class="xref py py-attr docutils literal"><span class="pre">TYPES</span></tt></a> は型名のタプルです。新しく作るサブクラスでは、タプル
<a class="reference internal" href="#optparse.Option.TYPES" title="optparse.Option.TYPES"><tt class="xref py py-attr docutils literal"><span class="pre">TYPES</span></tt></a> を単純に標準のものを利用して新しく定義すると良いでしょう。</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.TYPE_CHECKER">
<tt class="descclassname">Option.</tt><tt class="descname">TYPE_CHECKER</tt><a class="headerlink" href="#optparse.Option.TYPE_CHECKER" title="この定義へのパーマリンク">¶</a></dt>
<dd><p><a class="reference internal" href="#optparse.Option.TYPE_CHECKER" title="optparse.Option.TYPE_CHECKER"><tt class="xref py py-attr docutils literal"><span class="pre">TYPE_CHECKER</span></tt></a> は辞書で型名を型チェック関数に対応付けるものです。型チェック関数は以下のようなシグネチャを持ちます。</p>
<div class="highlight-python"><pre>def check_mytype(option, opt, value)</pre>
</div>
<p>ここで <tt class="docutils literal"><span class="pre">option</span></tt> は <tt class="xref py py-class docutils literal"><span class="pre">Option</span></tt> のインスタンスであり、 <tt class="docutils literal"><span class="pre">opt</span></tt> はオプション文字列(たとえば <tt class="docutils literal"><span class="pre">-f</span></tt>)で、 <tt class="docutils literal"><span class="pre">value</span></tt> は望みの型としてチェックされ変換されるべくコマンドラインで与えられる文字列です。
<tt class="docutils literal"><span class="pre">check_mytype()</span></tt> は想定されている型 <tt class="docutils literal"><span class="pre">mytype</span></tt> のオブジェクトを返さなければなりません。型チェック関数から返される値は
<tt class="xref py py-meth docutils literal"><span class="pre">OptionParser.parse_args()</span></tt> で返されるOptionValues インスタンスに収められるか、またはコールバックに <tt class="docutils literal"><span class="pre">value</span></tt> パラメータとして渡されます。</p>
<p>型チェック関数は何か問題に遭遇したら <tt class="xref py py-exc docutils literal"><span class="pre">OptionValueError</span></tt> を送出しなければなりません。
<tt class="xref py py-exc docutils literal"><span class="pre">OptionValueError</span></tt> は文字列一つを引数に取り、それはそのまま
<a class="reference internal" href="#optparse.OptionParser" title="optparse.OptionParser"><tt class="xref py py-class docutils literal"><span class="pre">OptionParser</span></tt></a> の <tt class="xref py py-meth docutils literal"><span class="pre">error()</span></tt> メソッドに渡され、そこでプログラム名と文字列 <tt class="docutils literal"><span class="pre">&quot;error:&quot;</span></tt> が前置されてプロセスが終了する前に
stderr に出力されます。</p>
</dd></dl>

<p>馬鹿馬鹿しい例ですが、Python スタイルの複素数を解析する <tt class="docutils literal"><span class="pre">&quot;complex&quot;</span></tt>
オプション型を作ってみせることにします。(<a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> 1.3 が複素数のサポートを組み込んでしまったため以前にも増して馬鹿らしくなりましたが、気にしないでください。)</p>
<p>最初に必要な import 文を書きます。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">Option</span><span class="p">,</span> <span class="n">OptionValueError</span>
</pre></div>
</div>
<p>まずは型チェック関数を定義しなければなりません。これは後で(これから定義する
Option のサブクラスの <a class="reference internal" href="#optparse.Option.TYPE_CHECKER" title="optparse.Option.TYPE_CHECKER"><tt class="xref py py-attr docutils literal"><span class="pre">TYPE_CHECKER</span></tt></a> クラス属性の中で)
参照されることになります。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_complex</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">complex</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">OptionValueError</span><span class="p">(</span>
            <span class="s">&quot;option </span><span class="si">%s</span><span class="s">: invalid complex value: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
<p>最後に Option のサブクラスです。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyOption</span> <span class="p">(</span><span class="n">Option</span><span class="p">):</span>
    <span class="n">TYPES</span> <span class="o">=</span> <span class="n">Option</span><span class="o">.</span><span class="n">TYPES</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;complex&quot;</span><span class="p">,)</span>
    <span class="n">TYPE_CHECKER</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">Option</span><span class="o">.</span><span class="n">TYPE_CHECKER</span><span class="p">)</span>
    <span class="n">TYPE_CHECKER</span><span class="p">[</span><span class="s">&quot;complex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_complex</span>
</pre></div>
</div>
<p>(もしここで <a class="reference internal" href="#optparse.Option.TYPE_CHECKER" title="optparse.Option.TYPE_CHECKER"><tt class="xref py py-attr docutils literal"><span class="pre">Option.TYPE_CHECKER</span></tt></a> に <a class="reference internal" href="copy.html#module-copy" title="copy: 浅いコピーおよび深いコピー操作。"><tt class="xref py py-func docutils literal"><span class="pre">copy()</span></tt></a> を適用しなければ、
<a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> の Option クラスの <a class="reference internal" href="#optparse.Option.TYPE_CHECKER" title="optparse.Option.TYPE_CHECKER"><tt class="xref py py-attr docutils literal"><span class="pre">TYPE_CHECKER</span></tt></a> 属性をいじってしまうことになります。
Python の常として、良いマナーと常識以外にそうすることを止めるものはありません。)</p>
<p>これだけです! もう新しいオプション型を使うスクリプトを他の <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> に基づいたスクリプトとまるで同じように書くことができます。ただし、 OptionParser に Option でなく MyOption
を使うように指示しなければなければなりません。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">option_class</span><span class="o">=</span><span class="n">MyOption</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;complex&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>別のやり方として、オプションリストを構築して OptionParser に渡すという方法もあります。 <tt class="xref py py-meth docutils literal"><span class="pre">add_option()</span></tt>
を上でやったように使わないならば、OptionParser にどのクラスを使うのか教える必要はありません。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">option_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyOption</span><span class="p">(</span><span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&quot;complex&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="p">)]</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">option_list</span><span class="o">=</span><span class="n">option_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="optparse-adding-new-actions">
<span id="id37"></span><h3>15.5.5.2. 新しいアクションの追加<a class="headerlink" href="#optparse-adding-new-actions" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>新しいアクションの追加はもう少しトリッキーです。というのも <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>  が使っている二つのアクションの分類を理解する必要があるからです。</p>
<dl class="docutils">
<dt>&#8220;store&#8221; アクション</dt>
<dd><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> が値を現在の OptionValues の属性に格納することになるアクションです。この種類のオプションは Option のコンストラクタに
<a class="reference internal" href="#optparse.Option.dest" title="optparse.Option.dest"><tt class="xref py py-attr docutils literal"><span class="pre">dest</span></tt></a> 属性を与えることが要求されます。</dd>
<dt>&#8220;typed&#8221; アクション</dt>
<dd>コマンドラインから引数を受け取り、それがある型であることが期待されているアクションです。もう少しはっきり言えば、その型に変換される文字列を受け取るものです。この種類のオプションは Option のコンストラクタに <a class="reference internal" href="functions.html#type" title="type"><tt class="xref py py-attr docutils literal"><span class="pre">type</span></tt></a> 属性を与えることが要求されます。</dd>
</dl>
<p>この分類には重複する部分があります。デフォルトの &#8220;store&#8221; アクションには
<tt class="docutils literal"><span class="pre">&quot;store&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;store_const&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;append&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;count&quot;</span></tt> などがありますが、デフォルトの &#8220;typed&#8221; オプションは <tt class="docutils literal"><span class="pre">&quot;store&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;append&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;callback&quot;</span></tt>
の三つです。</p>
<p>アクションを追加する際に、以下の Option のクラス属性(全て文字列のリストです)
の中の少なくとも一つに付け加えることでそのアクションを分類する必要があります。</p>
<dl class="attribute">
<dt id="optparse.Option.ACTIONS">
<tt class="descclassname">Option.</tt><tt class="descname">ACTIONS</tt><a class="headerlink" href="#optparse.Option.ACTIONS" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>全てのアクションは ACTIONS にリストされていなければなりません</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.STORE_ACTIONS">
<tt class="descclassname">Option.</tt><tt class="descname">STORE_ACTIONS</tt><a class="headerlink" href="#optparse.Option.STORE_ACTIONS" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>&#8220;store&#8221; アクションはここにもリストされます</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.TYPED_ACTIONS">
<tt class="descclassname">Option.</tt><tt class="descname">TYPED_ACTIONS</tt><a class="headerlink" href="#optparse.Option.TYPED_ACTIONS" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>&#8220;typed&#8221; アクションはここにもリストされます</p>
</dd></dl>

<dl class="attribute">
<dt id="optparse.Option.ALWAYS_TYPED_ACTIONS">
<tt class="descclassname">Option.</tt><tt class="descname">ALWAYS_TYPED_ACTIONS</tt><a class="headerlink" href="#optparse.Option.ALWAYS_TYPED_ACTIONS" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>型を取るアクション (つまりそのオプションが値を取る) はここにもリストされます。このことの唯一の効果は <a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a>
が、型の指定が無くアクションが <a class="reference internal" href="#optparse.Option.ALWAYS_TYPED_ACTIONS" title="optparse.Option.ALWAYS_TYPED_ACTIONS"><tt class="xref py py-attr docutils literal"><span class="pre">ALWAYS_TYPED_ACTIONS</span></tt></a> のリストにあるオプションに、デフォルト型 <tt class="docutils literal"><span class="pre">&quot;string&quot;</span></tt>
を割り当てるということだけです。</p>
</dd></dl>

<p>実際に新しいアクションを実装するには、Option の <tt class="xref py py-meth docutils literal"><span class="pre">take_action()</span></tt>
メソッドをオーバライドしてそのアクションを認識する場合分けを追加しなければなりません。</p>
<p>例えば、 <tt class="docutils literal"><span class="pre">&quot;extend&quot;</span></tt> アクションというのを追加してみましょう。このアクションは標準的な <tt class="docutils literal"><span class="pre">&quot;append&quot;</span></tt>
アクションと似ていますが、コマンドラインから一つだけ値を読み取って既存のリストに追加するのではなく、複数の値をコンマ区切りの文字列として読み取ってそれらで既存のリストを拡張します。すなわち、もし <tt class="docutils literal"><span class="pre">--names</span></tt> が <tt class="docutils literal"><span class="pre">&quot;string&quot;</span></tt> 型の <tt class="docutils literal"><span class="pre">&quot;extend&quot;</span></tt>
オプションだとすると、次のコマンドライン</p>
<div class="highlight-python"><pre>--names=foo,bar --names blah --names ding,dong</pre>
</div>
<p>の結果は次のリストになります。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="s">&quot;blah&quot;</span><span class="p">,</span> <span class="s">&quot;ding&quot;</span><span class="p">,</span> <span class="s">&quot;dong&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>再び Option のサブクラスを定義します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyOption</span><span class="p">(</span><span class="n">Option</span><span class="p">):</span>

    <span class="n">ACTIONS</span> <span class="o">=</span> <span class="n">Option</span><span class="o">.</span><span class="n">ACTIONS</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;extend&quot;</span><span class="p">,)</span>
    <span class="n">STORE_ACTIONS</span> <span class="o">=</span> <span class="n">Option</span><span class="o">.</span><span class="n">STORE_ACTIONS</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;extend&quot;</span><span class="p">,)</span>
    <span class="n">TYPED_ACTIONS</span> <span class="o">=</span> <span class="n">Option</span><span class="o">.</span><span class="n">TYPED_ACTIONS</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;extend&quot;</span><span class="p">,)</span>
    <span class="n">ALWAYS_TYPED_ACTIONS</span> <span class="o">=</span> <span class="n">Option</span><span class="o">.</span><span class="n">ALWAYS_TYPED_ACTIONS</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;extend&quot;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">take_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&quot;extend&quot;</span><span class="p">:</span>
            <span class="n">lvalue</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">ensure_value</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lvalue</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Option</span><span class="o">.</span><span class="n">take_action</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
</pre></div>
</div>
<p>注意すべきは次のようなところです。</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">&quot;extend&quot;</span></tt> はコマンドラインの値を予期していると同時にその値をどこかに格納しますので、 <a class="reference internal" href="#optparse.Option.STORE_ACTIONS" title="optparse.Option.STORE_ACTIONS"><tt class="xref py py-attr docutils literal"><span class="pre">STORE_ACTIONS</span></tt></a> と
<a class="reference internal" href="#optparse.Option.TYPED_ACTIONS" title="optparse.Option.TYPED_ACTIONS"><tt class="xref py py-attr docutils literal"><span class="pre">TYPED_ACTIONS</span></tt></a> の両方に入ります。</p>
</li>
<li><p class="first"><a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> が <tt class="docutils literal"><span class="pre">extend</span></tt> アクションに <tt class="docutils literal"><span class="pre">&quot;string&quot;</span></tt> 型を割り当てるように <tt class="docutils literal"><span class="pre">&quot;extend&quot;</span></tt> アクションは
<a class="reference internal" href="#optparse.Option.ALWAYS_TYPED_ACTIONS" title="optparse.Option.ALWAYS_TYPED_ACTIONS"><tt class="xref py py-attr docutils literal"><span class="pre">ALWAYS_TYPED_ACTIONS</span></tt></a> にも入れてあります。</p>
</li>
<li><p class="first"><tt class="xref py py-meth docutils literal"><span class="pre">MyOption.take_action()</span></tt> にはこの新しいアクション一つの扱いだけを実装してあり、他の標準的な
<a class="reference internal" href="#module-optparse" title="optparse: コマンドラインオプション解析機 (撤廃)"><tt class="xref py py-mod docutils literal"><span class="pre">optparse</span></tt></a> のアクションについては <tt class="xref py py-meth docutils literal"><span class="pre">Option.take_action()</span></tt> に制御を戻すようにしてあります。</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">values</span></tt> は optparse_parser.Values クラスのインスタンスであり、非常に有用な
<tt class="xref py py-meth docutils literal"><span class="pre">ensure_value()</span></tt> メソッドを提供しています。 <tt class="xref py py-meth docutils literal"><span class="pre">ensure_value()</span></tt> は本質的に安全弁付きの
<a class="reference internal" href="functions.html#getattr" title="getattr"><tt class="xref py py-func docutils literal"><span class="pre">getattr()</span></tt></a> です。次のように呼び出します。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">values</span><span class="o">.</span><span class="n">ensure_value</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">values</span></tt> に <tt class="docutils literal"><span class="pre">attr</span></tt> 属性が無いか None だった場合に、 <tt class="xref py py-meth docutils literal"><span class="pre">ensure_value()</span></tt> は最初に <tt class="docutils literal"><span class="pre">value</span></tt>
をセットし、それから <tt class="docutils literal"><span class="pre">value</span></tt> を返します。この振る舞いは <tt class="docutils literal"><span class="pre">&quot;extend&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;append&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;count&quot;</span></tt>
のように、データを変数に集積し、またその変数がある型 (最初の二つはリスト、最後のは整数) であると期待されるアクションを作るのにとても使い易いものです。 <tt class="xref py py-meth docutils literal"><span class="pre">ensure_value()</span></tt> を使えば、作ったアクションを使うスクリプトはオプションに保存先にデフォルト値をセットすることに煩わされずに済みます。デフォルトを None にしておけば
<tt class="xref py py-meth docutils literal"><span class="pre">ensure_value()</span></tt> がそれが必要になったときに適当な値を返してくれます。</p>
</li>
</ul>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Pythonモジュール索引"
             >モジュール</a> |</li>
        <li class="right" >
          <a href="getopt.html" title="15.6. getopt — C言語スタイルのコマンドラインオプションパーサ"
             >次へ</a> |</li>
        <li class="right" >
          <a href="argparse.html" title="15.4. argparse — コマンドラインオプション、引数、サブコマンドのパーサー"
             >前へ</a> |</li>
        <li><img src="../_static/py.png" alt=""
                 style="vertical-align: middle; margin-top: -1px"/></li>
        <li><a href="../index.html">Python 2.7ja1 documentation</a> &raquo;</li>

          <li><a href="index.html" >Python 標準ライブラリ</a> &raquo;</li>
          <li><a href="allos.html" >15. 汎用オペレーティングシステムサービス</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 1990-2011, Python Software Foundation.
      最終更新: 2011-12-26
      このドキュメントは <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2pre/02cb752c6a9e で生成しました。
    </div>
  </body>
</html>